(this.webpackJsonpmed3web=this.webpackJsonpmed3web||[]).push([[0],{124:function(e,t){},125:function(e,t){},126:function(e,t){},136:function(e,t,i){},145:function(e,t){},146:function(e,t){},147:function(e,t){},148:function(e,t){},149:function(e,t){},150:function(e,t){},152:function(e,t){},154:function(e,t){},179:function(e,t,i){},180:function(e,t,i){"use strict";i.r(t);i(131);var n=i(1),r=i.n(n),s=i(20),o=i.n(s),a=(i(136),i(14)),m=i(64),l={SET_IS_LOADED:0,SET_FILENAME:1,SET_VOLUME_SET:2,SET_VOLUME_INDEX:3,SET_TEXTURE3D:4,SET_MODE_VIEW:5,SET_MODE_2D:6,SET_SLIDER_2D:7,SET_MODE_3D:8,SET_SLIDER_3DR:9,SET_SLIDER_3DG:10,SET_SLIDER_3DB:11,SET_SLIDER_Opacity:12,SET_SLIDER_Isosurface:13,SET_SLIDER_Brightness:14,SET_SLIDER_Cut:15,SET_SLIDER_Quality:16,SET_SLIDER_ErRadius:17,SET_SLIDER_ErDepth:18,SET_VOLUME_Renderer:19,SET_2D_TOOLS_INDEX:20,SET_2D_ZOOM:21,SET_2D_X_POS:22,SET_2D_Y_POS:23,SET_GRAPHICS_2D:24,SET_UI_APP:25,SET_DICOM_INFO:26,SET_IS_TOOL3D:27,SET_SLIDER_Contrast3D:28,SET_ERR_ARRAY:29,SET_MODE_3Droi:30,SET_DICOM_SERIES:31,SET_LOADER_DICOM:32},h={VIEW_NA:-1,VIEW_MPR:0,VIEW_2D:1,VIEW_3D_LIGHT:2,VIEW_3D:3,VIEW_COUNT:4},u={NA:-1,SAGGITAL:0,CORONAL:1,TRANSVERSE:2},c={NA:-1,ISO:0,RAYCAST:1,RAYFAST:2,EREASER:3},d={isLoaded:!1,fileName:"brain.ktx",volumeSet:null,volumeIndex:0,texture3d:null,modeView:h.VIEW_2D,mode2d:u.TRANSVERSE,slider2d:.5,slider3d_r:.09,slider3d_g:.3,slider3d_b:.46,mode3d:c.RAYCAST,mode3droi:{NA:-1,ISO:0,RAYCAST:1}.RAYCAST,sliderOpacity:.53,sliderIsosurface:.46,sliderBrightness:.56,sliderCut:1,sliderQuality:.35,sliderErRadius:50,sliderErDepth:50,volumeRenderer:null,indexTools2d:0,render2dZoom:1,render2dxPos:0,render2dyPos:0,graphics2d:null,uiApp:null,dicomInfo:null,isTool3D:!1,sliderContrast3D:0,arrErrors:[],dicomSeries:[],loaderDicom:null},_=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:d,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case l.SET_IS_LOADED:return Object.assign({},e,{isLoaded:t.isLoaded});case l.SET_FILENAME:return Object.assign({},e,{fileName:t.fileName});case l.SET_VOLUME_SET:return Object.assign({},e,{volumeSet:t.volumeSet});case l.SET_VOLUME_INDEX:return Object.assign({},e,{volumeIndex:t.volumeIndex});case l.SET_TEXTURE3D:return Object.assign({},e,{texture3d:t.texture3d});case l.SET_MODE_VIEW:return Object.assign({},e,{modeView:t.modeView});case l.SET_MODE_2D:return Object.assign({},e,{mode2d:t.mode2d});case l.SET_SLIDER_2D:return Object.assign({},e,{slider2d:t.slider2d});case l.SET_MODE_3D:return Object.assign({},e,{mode3d:t.mode3d});case l.SET_MODE_3Droi:return Object.assign({},e,{mode3droi:t.mode3droi});case l.SET_SLIDER_3DR:return Object.assign({},e,{slider3d_r:t.slider3d_r});case l.SET_SLIDER_3DG:return Object.assign({},e,{slider3d_g:t.slider3d_g});case l.SET_SLIDER_3DB:return Object.assign({},e,{slider3d_b:t.slider3d_b});case l.SET_SLIDER_Opacity:return Object.assign({},e,{sliderOpacity:t.sliderOpacity});case l.SET_SLIDER_Isosurface:return Object.assign({},e,{sliderIsosurface:t.sliderIsosurface});case l.SET_SLIDER_ErRadius:return Object.assign({},e,{sliderErRadius:t.sliderErRadius});case l.SET_SLIDER_ErDepth:return Object.assign({},e,{sliderErDepth:t.sliderErDepth});case l.SET_VOLUME_Renderer:return Object.assign({},e,{volumeRenderer:t.volumeRenderer});case l.SET_SLIDER_Brightness:return Object.assign({},e,{sliderBrightness:t.sliderBrightness});case l.SET_SLIDER_Cut:return Object.assign({},e,{sliderCut:t.sliderCut});case l.SET_SLIDER_Quality:return Object.assign({},e,{sliderQuality:t.sliderQuality});case l.SET_2D_TOOLS_INDEX:return Object.assign({},e,{indexTools2d:t.indexTools2d});case l.SET_2D_ZOOM:return Object.assign({},e,{render2dZoom:t.render2dZoom});case l.SET_2D_X_POS:return Object.assign({},e,{render2dxPos:t.render2dxPos});case l.SET_2D_Y_POS:return Object.assign({},e,{render2dyPos:t.render2dyPos});case l.SET_GRAPHICS_2D:return Object.assign({},e,{graphics2d:t.graphics2d});case l.SET_UI_APP:return Object.assign({},e,{uiApp:t.uiApp});case l.SET_DICOM_INFO:return Object.assign({},e,{dicomInfo:t.dicomInfo});case l.SET_IS_TOOL3D:return Object.assign({},e,{isTool3D:t.isTool3D});case l.SET_SLIDER_Contrast3D:return Object.assign({},e,{sliderContrast3D:t.sliderContrast3D});case l.SET_ERR_ARRAY:return Object.assign({},e,{arrErrors:t.arrErrors});case l.SET_DICOM_SERIES:return Object.assign({},e,{dicomSeries:t.dicomSeries});case l.SET_LOADER_DICOM:return Object.assign({},e,{loaderDicom:t.loaderDicom});default:return e}},f=i(3),v=i(5),p=i(13),g=i(12),S=i(10),x=i(186),y=i(123),T=i(196),D=i(185),b=i(193),R=i(195),w=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_strMessage="",this.m_xMessage=0,this.m_yMessage=0,this.m_timeStart=0,this.onTimerEnd=this.onTimerEnd.bind(this)}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"screenToTexture",value:function(e,t,i){var n={x:0,y:0,z:0},r=i.mode2d,s=i.slider2d,o=i.volumeSet,a=i.volumeIndex,m=o.getVolume(a),l=m.m_xDim,h=m.m_yDim,c=m.m_zDim,d=i.render2dZoom,_=i.render2dxPos,f=i.render2dyPos;return r===u.TRANSVERSE&&(n.x=Math.floor((_+e*d)*l),n.y=Math.floor((f+t*d)*h),n.z=Math.floor(s*c)),r===u.SAGGITAL&&(n.x=Math.floor(s*l),n.y=Math.floor((_+e*d)*h),n.z=Math.floor((f+t*d)*c)),r===u.CORONAL&&(n.x=Math.floor((_+e*d)*l),n.y=Math.floor(s*h),n.z=Math.floor((f+t*d)*c)),n}},{key:"onMouseDown",value:function(e,t,i){if(0!==this.m_wScreen&&0!==this.m_hScreen){var n=e/this.m_wScreen,r=t/this.m_hScreen;if(!(n>1||r>1)){var s=this.screenToTexture(n,r,i),o=i.volumeSet.getVolume(i.volumeIndex),a=o.m_xDim,m=o.m_yDim,l=o.m_bytesPerVoxel,h=s.x+s.y*a+s.z*a*m,u=0;1===l?u=o.m_dataArray[h]:4===l&&(h*=4,u=o.m_dataArray[h]),this.m_xMessage=e,this.m_yMessage=t,this.m_strMessage="x,y,z = "+s.x.toString()+", "+s.y.toString()+", "+s.z.toString()+". val = "+u.toString(),this.m_timeStart=Date.now(),setTimeout(this.onTimerEnd,1500)}}else console.log("ToolPick. onMouseDown. Bad screen size")}},{key:"onTimerEnd",value:function(){this.m_objGraphics2d.forceUpdate()}},{key:"render",value:function(e){if(0!==this.m_timeStart){if(Date.now()-this.m_timeStart<1200){e.fillStyle="white";e.font=16..toString()+"px Arial";var t=e.measureText(this.m_strMessage);this.m_xMessage+t.width<this.m_wScreen?e.textAlign="left":e.textAlign="right",this.m_yMessage+16<this.m_hScreen?e.textBaseline="top":e.textBaseline="bottom",e.fillText(this.m_strMessage,this.m_xMessage,this.m_yMessage)}}}}]),e}(),M=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.setScreenDim=this.setScreenDim.bind(this),this.onMouseWheel=this.onMouseWheel.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.state={mouseDown:!1,xMouse:0,yMouse:0}}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"onMouseDown",value:function(e,t){this.state.mouseDown=!0,this.state.xMouse=e,this.state.yMouse=t}},{key:"onMouseUp",value:function(){this.state.mouseDown=!1}},{key:"onMouseMove",value:function(e,t,i){if(this.state.mouseDown){var n=t-this.state.xMouse,r=i-this.state.yMouse;this.state.xMouse=t,this.state.yMouse=i;var s=e.render2dZoom,o=n/this.m_wScreen*s,a=r/this.m_hScreen*s,m=e.render2dxPos-o,h=e.render2dyPos-a;if(m>=0&&m+s<=1&&h>=0&&h+s<=1)e.dispatch({type:l.SET_2D_X_POS,render2dxPos:m}),e.dispatch({type:l.SET_2D_Y_POS,render2dyPos:h}),e.graphics2d.forceUpdate()}}},{key:"onMouseWheel",value:function(e,t){var i=.04*-Math.max(-1,Math.min(1,t.deltaY||-t.detail)),n=e.render2dZoom,r=n+i;if(r>1&&(r-=i),r<=0&&(r+=i),r!==n){var s=e.render2dxPos-.5*i,o=e.render2dyPos-.5*i;e.dispatch({type:l.SET_2D_ZOOM,render2dZoom:r}),e.dispatch({type:l.SET_2D_X_POS,render2dxPos:s}),e.dispatch({type:l.SET_2D_Y_POS,render2dyPos:o}),e.graphics2d.forceUpdate()}}}]),e}(),E=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_pointStart=null,this.m_lines=[],this.m_mouseDown=!1,this.m_objEdit=null,this.m_xPixelSize=0,this.m_yPixelSize=0}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"getEditPoint",value:function(t,i){for(var n=this.m_lines.length,r=0;r<n;r++){var s=this.m_lines[r],o=e.textureToScreen(s.vs.x,s.vs.y,this.m_wScreen,this.m_hScreen,i),a=e.textureToScreen(s.ve.x,s.ve.y,this.m_wScreen,this.m_hScreen,i);if(this.getDistMm(t,o)<=4)return this.m_objEdit=s,s.vs;if(this.getDistMm(t,a)<=4)return this.m_objEdit=s,s.ve}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y,this.m_objEdit.distMm=this.getDistMm(this.m_objEdit.vs,this.m_objEdit.ve)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_lines.indexOf(this.m_objEdit);e>=0&&this.m_lines.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+n*n*this.m_yPixelSize*this.m_yPixelSize)}},{key:"onMouseDown",value:function(t,i,n){var r=e.screenToTexture(t,i,this.m_wScreen,this.m_hScreen,n),s={vs:{x:r.x,y:r.y},ve:{x:r.x,y:r.y},distMm:0};this.m_lines.push(s),this.m_mouseDown=!0}},{key:"onMouseMove",value:function(t,i,n){if(this.m_mouseDown){var r=e.screenToTexture(t,i,this.m_wScreen,this.m_hScreen,n),s={x:r.x,y:r.y},o=this.m_lines.length;if(o>0){var a=this.m_lines[o-1];a.ve=s,a.distMm=this.getDistMm(a.vs,a.ve);a.distMm>1e-5&&this.m_objGraphics2d.forceUpdate()}}}},{key:"onMouseUp",value:function(){this.m_mouseDown=!1;var e=this.m_lines.length;if(e>0){var t=this.m_lines[e-1];t.distMm=this.getDistMm(t.vs,t.ve);t.distMm<=1e-5&&(this.m_lines.pop(),console.log("ToolDistance: pop last line"))}}},{key:"clear",value:function(){this.m_lines=[]}},{key:"render",value:function(t,i){var n=this.m_lines.length;t.lineWidth=2,t.strokeStyle="yellow",t.fillStyle="white";t.font=16..toString()+"px Arial",t.textAlign="center",t.textBaseline="center";for(var r=0;r<n;r++){var s=this.m_lines[r],o=s.distMm,a=s.vs,m=s.ve,l=e.textureToScreen(a.x,a.y,this.m_wScreen,this.m_hScreen,i),h=e.textureToScreen(m.x,m.y,this.m_wScreen,this.m_hScreen,i);t.beginPath(),t.moveTo(l.x,l.y),t.lineTo(h.x,h.y),t.stroke();var u=Math.floor(.5*(l.x+h.x)),c=Math.floor(.5*(l.y+h.y)),d=o.toFixed(3)+" mm";t.fillText(d,u,c)}}}],[{key:"screenToTexture",value:function(e,t,i,n,r){var s=e/i,o=t/n,a=r.mode2d,m=r.volumeSet,l=r.volumeIndex,h=m.getVolume(l),c=h.m_xDim,d=h.m_yDim,_=h.m_zDim,f=r.render2dZoom,v=r.render2dxPos,p=r.render2dyPos,g={x:0,y:0};return a===u.TRANSVERSE&&(g.x=Math.floor((v+s*f)*c),g.y=Math.floor((p+o*f)*d)),a===u.SAGGITAL&&(g.x=Math.floor((v+s*f)*d),g.y=Math.floor((p+o*f)*_)),a===u.CORONAL&&(g.x=Math.floor((v+s*f)*c),g.y=Math.floor((p+o*f)*_)),g}},{key:"textureToScreen",value:function(e,t,i,n,r){var s={x:0,y:0},o=r.mode2d,a=r.volumeSet.getVolume(r.volumeIndex),m=a.m_xDim,l=a.m_yDim,h=a.m_zDim,c=r.render2dZoom,d=r.render2dxPos,_=r.render2dyPos;return o===u.TRANSVERSE&&(s.x=(e/m-d)/c,s.y=(t/l-_)/c),o===u.SAGGITAL&&(s.x=(e/l-d)/c,s.y=(t/h-_)/c),o===u.CORONAL&&(s.x=(e/m-d)/c,s.y=(t/h-_)/c),s.x*=i,s.y*=n,s}}]),e}(),A=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t}return Object(v.a)(e,[{key:"clear",value:function(){this.m_objGraphics2d.clear()}}]),e}(),I=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0;this.m_points=[{x:0,y:0},{x:0,y:0},{x:0,y:0}],this.m_numClicks=0,this.m_angles=[],this.m_objEdit=null,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this)}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"getEditPoint",value:function(e,t){for(var i=this.m_angles.length,n=0;n<i;n++){var r=this.m_angles[n],s=E.textureToScreen(r.points[0].x,r.points[0].y,this.m_wScreen,this.m_hScreen,t),o=E.textureToScreen(r.points[1].x,r.points[1].y,this.m_wScreen,this.m_hScreen,t),a=E.textureToScreen(r.points[2].x,r.points[2].y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,s)<=4)return this.m_objEdit=r,r.points[0];if(this.getDistMm(e,o)<=4)return this.m_objEdit=r,r.points[1];if(this.getDistMm(e,a)<=4)return this.m_objEdit=r,r.points[2]}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y,this.getAngleForObj(this.m_objEdit)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_angles.indexOf(this.m_objEdit);e>=0&&this.m_angles.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+n*n*this.m_yPixelSize*this.m_yPixelSize)}},{key:"getAngleForObj",value:function(e){for(var t=0;t<3;t++)this.m_points[t].x=e.points[t].x,this.m_points[t].y=e.points[t].y;var i=this.getAngle();e.angle=i}},{key:"getAngle",value:function(){var e=this.m_points[1].x-this.m_points[0].x,t=this.m_points[1].y-this.m_points[0].y,i=this.m_points[2].x-this.m_points[0].x,n=this.m_points[2].y-this.m_points[0].y,r=(e*i+t*n)/(Math.sqrt(e*e+t*t)*Math.sqrt(i*i+n*n));return r>1?0:r<-1?180:180*Math.acos(r)/3.1415926535}},{key:"onMouseDown",value:function(e,t,i){var n=E.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);if(0===this.m_numClicks){for(var r=0;r<3;r++)this.m_points[r].x=n.x,this.m_points[r].y=n.y;this.m_numClicks++}else if(1===this.m_numClicks)this.m_numClicks++;else{console.log("3rd click: finalize angle");var s={points:[{x:this.m_points[0].x,y:this.m_points[0].y},{x:this.m_points[1].x,y:this.m_points[1].y},{x:this.m_points[2].x,y:this.m_points[2].y}],angle:this.getAngle()};this.m_angles.push(s),this.m_numClicks=0}}},{key:"onMouseMove",value:function(e,t,i){if(0!==this.m_numClicks){for(var n=E.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i),r=this.m_numClicks;r<3;r++)this.m_points[r].x=n.x,this.m_points[r].y=n.y;this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){}},{key:"clear",value:function(){this.m_angles=[],this.m_numClicks=0}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";if(e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="top",this.m_numClicks>0){for(var i=1;i<3;i++){var n=this.m_points[0],r=this.m_points[i],s=E.textureToScreen(n.x,n.y,this.m_wScreen,this.m_hScreen,t),o=E.textureToScreen(r.x,r.y,this.m_wScreen,this.m_hScreen,t),a=s.x-o.x,m=s.y-o.y;a*a+m*m>=4&&(e.beginPath(),e.moveTo(s.x,s.y),e.lineTo(o.x,o.y),e.stroke())}var l=0;this.m_numClicks>=2&&(l=this.getAngle());var h=l.toFixed(3)+"\xb0",u=this.m_points[0],c=E.textureToScreen(u.x,u.y,this.m_wScreen,this.m_hScreen,t),d=c.x,_=c.y+8;e.fillText(h,d,_)}for(var f=this.m_angles.length,v=0;v<f;v++){for(var p=this.m_angles[v],g=1;g<3;g++){var S=p.points[0],x=p.points[g],y=E.textureToScreen(S.x,S.y,this.m_wScreen,this.m_hScreen,t),T=E.textureToScreen(x.x,x.y,this.m_wScreen,this.m_hScreen,t);e.beginPath(),e.moveTo(y.x,y.y),e.lineTo(T.x,T.y),e.stroke()}var D=p.angle.toFixed(3)+"\xb0",b=p.points[0],R=E.textureToScreen(b.x,b.y,this.m_wScreen,this.m_hScreen,t),w=R.x,M=R.y+8;e.fillText(D,w,M)}}}]),e}(),O=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_areas=[],this.m_inCreateMode=!1,this.m_objSelfIntersect=null,this.m_xPixelSize=0,this.m_yPixelSize=0,this.m_objEdit=null,this.store=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this)}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_areas=[],this.m_inCreateMode=!1,this.m_objSelfIntersect=null}},{key:"getEditPoint",value:function(e,t){this.store=t;for(var i=this.m_areas.length,n=0;n<i;n++)for(var r=this.m_areas[n],s=0;s<r.m_points.length;s++){var o=E.textureToScreen(r.m_points[s].x,r.m_points[s].y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,o)<=4)return this.m_objEdit=r,r.m_points[s]}return null}},{key:"moveEditPoint",value:function(t,i){var n=t.x,r=t.y;t.x=i.x,t.y=i.y,e.hasSelfIntersection(this.m_objEdit.m_points)&&(t.x=n,t.y=r);var s=this.store;this.m_objEdit.m_area=this.getPolyArea(this.m_objEdit.m_points,s)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_areas.indexOf(this.m_objEdit);e>=0&&this.m_areas.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+n*n*this.m_yPixelSize*this.m_yPixelSize)}},{key:"addPointToPolygon",value:function(e,t){var i=t.length;if(0===i)return t.push(e),!1;var n=this.m_objSelfIntersect;if(null!==n){var r=[];r.push(n.m_vIntersection);for(var s=n.m_lineIndex+1;s<i-1;s++){var o={x:t[s].x,y:t[s].y};r.push(o)}t.length=r.length;for(var a=0;a<r.length;a++)t[a].x=r[a].x,t[a].y=r[a].y;return this.m_objSelfIntersect=null,!0}return t.push(e),!1}},{key:"getPolyArea",value:function(e,t){var i=t.volumeSet,n=t.volumeIndex,r=i.getVolume(n),s=r.m_boxSize.x,o=r.m_boxSize.y,a=r.m_boxSize.z,m=t.mode2d,l=r.m_xDim,h=r.m_yDim,c=r.m_zDim,d=0,_=0;m===u.TRANSVERSE?(d=s/l,_=o/h):m===u.SAGGITAL?(d=o/l,_=a/c):(d=s/l,_=a/c);for(var f=0,v=e.length,p=v-1,g=0;g<v;g++){var S=e[g],x=e[p],y=(x.x+S.x)*(x.y-S.y)*d*_;f+=y=y>0?y:-y,p=g}return.5*f}},{key:"onMouseDown",value:function(e,t,i){var n=E.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);if(this.m_inCreateMode){var r={x:n.x,y:n.y},s=this.m_areas.length,o=this.m_areas[s-1];this.addPointToPolygon(r,o.m_points)&&(o.m_isClosed=!0,o.m_area=this.getPolyArea(o.m_points,i),console.log("ToolArea. area = ".concat(o.m_area)),this.m_inCreateMode=!1)}else{this.m_inCreateMode=!0;var a={x:n.x,y:n.y},m={x:n.x,y:n.y},l={m_isClosed:!1,m_points:[],m_area:0};l.m_points.push(a),l.m_points.push(m),this.m_areas.push(l)}}},{key:"onMouseMove",value:function(t,i,n){if(this.m_inCreateMode){var r=E.screenToTexture(t,i,this.m_wScreen,this.m_hScreen,n),s=this.m_areas.length,o=this.m_areas[s-1],a=o.m_points.length;o.m_points[a-1].x=r.x,o.m_points[a-1].y=r.y;var m=e.getSelfIntersectPoint(o.m_points);this.m_objSelfIntersect=m,this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";if(e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="bottom",null!==this.m_objSelfIntersect){var i=this.m_objSelfIntersect.m_vIntersection,n=E.textureToScreen(i.x,i.y,this.m_wScreen,this.m_hScreen,t);e.strokeStyle="red",e.beginPath();e.arc(n.x,n.y,5,0,6.283185307),e.stroke()}e.strokeStyle="yellow";for(var r=this.m_areas.length,s=0;s<r;s++){var o=this.m_areas[s],a=o.m_isClosed,m=a?o.m_points.length+1:o.m_points.length,l=0,h=0;e.beginPath();for(var u=0;u<m;u++){var c=u<o.m_points.length?u:0,d=o.m_points[c],_=E.textureToScreen(d.x,d.y,this.m_wScreen,this.m_hScreen,t);0===u?e.moveTo(_.x,_.y):e.lineTo(_.x,_.y),l+=_.x,h+=_.y}if(e.stroke(),m>0&&(l/=m,h/=m),a){var f=o.m_area.toFixed(2)+" mm^2";e.fillText(f,l,h)}}}}],[{key:"getLineIntersection",value:function(e,t,i,n){var r={x:n.x-i.x,y:n.y-i.y},s=-r.y,o=r.x,a={x:t.x-e.x,y:t.y-e.y},m=i.x-e.x,l=i.y-e.y,h=m*s+l*o,u=a.x*s+a.y*o,c=1e-6;if(Math.abs(u)<c)return null;var d=h/u;if(d<0||d>1)return null;var _=-m,f=-l,v=-a.y,p=a.x,g=r.x*v+r.y*p;if(Math.abs(g)<c)return null;var S=(_*v+f*p)/g;return S<0||S>1?null:{x:e.x+a.x*d,y:e.y+a.y*d}}},{key:"hasSelfIntersection",value:function(t){var i,n;for(i=0;i<t.length;i++){var r=i+1<t.length?i+1:0,s=t[i],o=t[r];for(n=0;n<t.length;n++){var a=n+1<t.length?n+1:0;if(i!==n&&i!==a&&r!==n&&r!==a){var m=t[n],l=t[a];if(null!==e.getLineIntersection(s,o,m,l))return!0}}}return!1}},{key:"getSelfIntersectPoint",value:function(t){var i=t.length;if(i<=3)return null;for(var n=t[i-2],r=t[i-1],s=i-3,o=0;o<s;o++){var a=t[o+0],m=t[o+1],l=e.getLineIntersection(n,r,a,m);if(null!==l)return{m_vIntersection:l,m_lineIndex:o}}var h=r.x-t[0].x,u=r.y-t[0].y;return h*h+u*u<=6.25?{m_vIntersection:{x:r.x,y:r.y},m_lineIndex:0}:null}}]),e}(),X=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_rects=[],this.m_inCreateMode=!1,this.m_xPixelSize=0,this.m_yPixelSize=0,this.m_store=null,this.m_objEdit=null,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this)}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_rects=[],this.m_inCreateMode=!1}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+n*n*this.m_yPixelSize*this.m_yPixelSize)}},{key:"getEditPoint",value:function(e,t){for(var i=this.m_rects.length,n=0;n<i;n++){var r=this.m_rects[n],s=E.textureToScreen(r.vMin.x,r.vMin.y,this.m_wScreen,this.m_hScreen,t),o=E.textureToScreen(r.vMax.x,r.vMax.y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,s)<=4)return this.m_objEdit=r,r.vMin;if(this.getDistMm(e,o)<=4)return this.m_objEdit=r,r.vMax}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y,this.getRectArea(this.m_objEdit,this.m_store)}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_rects.indexOf(this.m_objEdit);e>=0&&this.m_rects.splice(e,1)}}},{key:"getRectArea",value:function(e,t){var i=t.volumeSet,n=t.volumeIndex,r=i.getVolume(n),s=r.m_boxSize.x,o=r.m_boxSize.y,a=r.m_boxSize.z,m=t.mode2d,l=r.m_xDim,h=r.m_yDim,c=r.m_zDim,d=0,_=0;m===u.TRANSVERSE?(d=s/l,_=o/h):m===u.SAGGITAL?(d=o/l,_=a/c):(d=s/l,_=a/c);var f=Math.abs(e.vMax.x-e.vMin.x),v=Math.abs(e.vMax.y-e.vMin.y);e.area=d*_*f*v}},{key:"onMouseDown",value:function(e,t,i){this.m_store=i;var n=E.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);if(this.m_inCreateMode)this.m_inCreateMode=!1;else{this.m_inCreateMode=!0;var r={vMin:{x:n.x,y:n.y},vMax:{x:n.x,y:n.y},area:0};this.m_rects.push(r)}}},{key:"onMouseMove",value:function(e,t,i){if(this.m_inCreateMode){var n=E.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i),r=this.m_rects.length,s=this.m_rects[r-1];s.vMax.x=n.x,s.vMax.y=n.y,this.getRectArea(s,i),this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="bottom";for(var i=this.m_rects.length,n=0;n<i;n++){var r=this.m_rects[n],s=r.vMin,o=r.vMax,a=E.textureToScreen(s.x,s.y,this.m_wScreen,this.m_hScreen,t),m=E.textureToScreen(o.x,o.y,this.m_wScreen,this.m_hScreen,t);e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(m.x,a.y),e.lineTo(m.x,m.y),e.lineTo(a.x,m.y),e.lineTo(a.x,a.y),e.stroke();var l=Math.floor(.5*(a.x+m.x)),h=Math.floor(.5*(a.y+m.y)),u=r.area.toFixed(2)+" mm^2";e.fillText(u,l,h)}}}]),e}(),C=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_texts=[],this.m_pointPressed=null,this.m_objEdit=null,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this),this.setText=this.setText.bind(this)}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"getEditPoint",value:function(e,t){for(var i=this.m_texts.length,n=0;n<i;n++){var r=this.m_texts[n],s=E.textureToScreen(r.point.x,r.point.y,this.m_wScreen,this.m_hScreen,t);if(this.getDistMm(e,s)<=4)return this.m_objEdit=r,r.point}return null}},{key:"moveEditPoint",value:function(e,t){e.x=t.x,e.y=t.y}},{key:"deleteObject",value:function(){if(null!=this.m_objEdit){var e=this.m_texts.indexOf(this.m_objEdit);e>=0&&this.m_texts.splice(e,1)}}},{key:"getDistMm",value:function(e,t){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i*this.m_xPixelSize*this.m_xPixelSize+n*n*this.m_yPixelSize*this.m_yPixelSize)}},{key:"setText",value:function(e){this.m_text=e,console.log("set text = ".concat(e));var t={point:{x:this.m_pointPressed.x,y:this.m_pointPressed.y},text:e};this.m_texts.push(t),this.m_objGraphics2d.forceUpdate()}},{key:"clear",value:function(){this.m_texts=[]}},{key:"onMouseDown",value:function(e,t,i){var n=E.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);this.m_pointPressed=n,i.uiApp.onShowModalText()}},{key:"onMouseMove",value:function(){}},{key:"onMouseUp",value:function(){}},{key:"render",value:function(e,t){e.lineWidth=2,e.strokeStyle="yellow",e.fillStyle="white";e.font=16..toString()+"px Arial",e.textAlign="center",e.textBaseline="bottom";for(var i=this.m_texts.length,n=0;n<i;n++){var r=this.m_texts[n],s=r.point,o=E.textureToScreen(s.x,s.y,this.m_wScreen,this.m_hScreen,t),a=r.text;e.fillText(a,o.x,o.y)}}}]),e}(),P=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this),this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}},{key:"onMouseDown",value:function(){this.m_mousePressed=!0}},{key:"onMouseMove",value:function(e,t,i){if(this.m_mousePressed){if(null!==this.m_pointTracked){var n=E.screenToTexture(e,t,this.m_wScreen,this.m_hScreen,i);this.m_toolTracked.moveEditPoint(this.m_pointTracked,n),this.m_objGraphics2d.forceUpdate()}}else{var r={x:e,y:t},s=[this.m_objGraphics2d.m_toolDistance,this.m_objGraphics2d.m_toolAngle,this.m_objGraphics2d.m_toolArea,this.m_objGraphics2d.m_toolRect,this.m_objGraphics2d.m_toolText],o=null!==this.m_pointTracked;this.m_pointTracked=null;for(var a=s.length,m=0;m<a;m++){var l=s[m],h=l.getEditPoint(r,i);if(null!==h){this.m_pointTracked=h,this.m_toolTracked=l;break}}var u=null!==this.m_pointTracked;(u||o&&!u)&&this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){this.m_mousePressed=!1}},{key:"render",value:function(e,t){if(null!==this.m_pointTracked){var i=E.textureToScreen(this.m_pointTracked.x,this.m_pointTracked.y,this.m_wScreen,this.m_hScreen,t);e.fillStyle="rgb(120, 250, 120)",e.beginPath(),e.arc(i.x,i.y,4,0,6.2831924,!1),e.fill()}}}]),e}(),k=function(){function e(t){Object(f.a)(this,e),this.m_objGraphics2d=t,this.m_wScreen=0,this.m_hScreen=0,this.m_xPixelSize=0,this.m_yPixelSize=0,this.onMouseDown=this.onMouseDown.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onMouseMove=this.onMouseMove.bind(this),this.render=this.render.bind(this),this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}return Object(v.a)(e,[{key:"setScreenDim",value:function(e,t){this.m_wScreen=e,this.m_hScreen=t}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"clear",value:function(){this.m_mousePressed=!1,this.m_pointTracked=null,this.m_toolTracked=null}},{key:"onMouseDown",value:function(){this.m_mousePressed=!0,null!==this.m_pointTracked&&(this.m_toolTracked.deleteObject(this.m_pointTracked),this.m_pointTracked=null,this.m_objGraphics2d.forceUpdate())}},{key:"onMouseMove",value:function(e,t,i){if(!this.m_mousePressed){var n={x:e,y:t},r=[this.m_objGraphics2d.m_toolDistance,this.m_objGraphics2d.m_toolAngle,this.m_objGraphics2d.m_toolArea,this.m_objGraphics2d.m_toolRect,this.m_objGraphics2d.m_toolText],s=null!==this.m_pointTracked;this.m_pointTracked=null;for(var o=r.length,a=0;a<o;a++){var m=r[a],l=m.getEditPoint(n,i);if(null!==l){this.m_pointTracked=l,this.m_toolTracked=m;break}}var h=null!==this.m_pointTracked;(h||s&&!h)&&this.m_objGraphics2d.forceUpdate()}}},{key:"onMouseUp",value:function(){this.m_mousePressed=!1}},{key:"render",value:function(e,t){if(null!==this.m_pointTracked){var i=E.textureToScreen(this.m_pointTracked.x,this.m_pointTracked.y,this.m_wScreen,this.m_hScreen,t);e.fillStyle="rgb(250, 120, 120)",e.beginPath(),e.arc(i.x,i.y,4,0,6.2831924,!1),e.fill()}}}]),e}(),F={INTENSITY:0,DISTANCE:1,ANGLE:2,AREA:3,RECT:4,TEXT:5,EDIT:6,DELETE:7,CLEAR:8,ZOOM:9,DEFAULT:10,FILTER:11,NONE:12},U=i(55),L=i.n(U),N=i(89),z=i(56),V=240,B=160,j=function(){function e(t){Object(f.a)(this,e),this.stage=0,this.objGraphics2d=t,this.model=null,this.tensorIndices=null,this.imgData=null,this.pixels=null,this.srcImageData=null,this.wSrc=-1,this.hSrc=-1,this.onLoadModel=this.onLoadModel.bind(this),this.startApplyImage=this.startApplyImage.bind(this),this.m_needApplySegmentation=!1}return Object(v.a)(e,[{key:"printTensor",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:192;console.log("tensor shape = "+e.shape);for(var i=e.dataSync(),n="",r=0;r<t;r++)n+=i[r].toString()+", ";console.log("tensor raw data = "+n)}},{key:"printTensorIndices",value:function(e){var t=e.shape[1],i=e.shape[0],n=e.dataSync();console.log("Tensor indices");for(var r=0,s=0;s<i;s++){for(var o="",a=0;a<t;a++){o+=n[r++].toString()}console.log(o)}}},{key:"scaleUp",value:function(e,t,i,n,r,s){for(var o=t/r,a=i/s,m=0,l=0,h=0;h<s;h++,m+=a)for(var u=Math.floor(m),c=(u+(m-u<.5?0:1))*t,d=0,_=0;_<r;_++,d+=o){var f=Math.floor(d),v=f+(d-f<.5?0:1);n[l++]=e[v+c]}}},{key:"onLoadModel",value:function(){var e=Object(N.a)(L.a.mark((function e(){var t;return L.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.stage=1,this.pixels=null,console.log("Loading tfjs model..."),e.next=5,z.b("http://lugachai.ru/med3web/tfjs/model.json",{strict:!1});case 5:t=e.sent,this.model=t,this.stage=2,console.log("Model is loaded shape = "+t.output.shape),this.startApplyImage();case 10:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"startApplyImage",value:function(){var e=Object(N.a)(L.a.mark((function e(){var t,i,n,r,s,o,a,m,l,h,u,c,d,_,f,v,p,g,S,x,y,T,D,b,R,w,M;return L.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(this.stage=3,console.log("Start apply segm to image ..."),t=z.a.fromPixels(this.srcImageData).toFloat(),320,480,i=t.resizeBilinear([320,480]),n=z.c([123,116,103]),r=i.sub(n),s=r.reshape([1,320,480,3]),o=this.model.predict(s),a=o.as2D(38400,96),m=a.reshape([B,V,96]),l=m.dataSync(),this.tensorIndices=new z.d([B,V],"int32"),h=this.tensorIndices.dataSync(),u=0,c=0,d=0;d<B;d++)for(_=0;_<V;_++){for(f=-1,v=-.1,p=0;p<96;p++)l[u+p]>v&&(v=l[u+p],f=p);h[c]=f,u+=96,c+=1}for(g=new Uint8ClampedArray(this.wSrc*this.hSrc),this.scaleUp(h,V,B,g,this.wSrc,this.hSrc),S=new Uint8ClampedArray(1024),x=0,y=0,S[y++]=0,S[y++]=0,S[y++]=255,S[y++]=255,x++,S[y++]=0,S[y++]=255,S[y++]=0,S[y++]=255,x++,S[y++]=255,S[y++]=0,S[y++]=0,S[y++]=255,x++,S[y++]=255,S[y++]=0,S[y++]=255,S[y++]=255,x++,S[y++]=64,S[y++]=200,S[y++]=255,S[y++]=255,x++;x<256;x++,y+=4)S[y+0]=Math.floor(255*Math.random()),S[y+1]=Math.floor(255*Math.random()),S[y+2]=Math.floor(255*Math.random()),S[y+3]=255;for(this.pixels=new Uint8ClampedArray(this.wSrc*this.hSrc*4),T=this.pixels,D=this.wSrc,b=this.hSrc,x=0,y=0,R=0;R<b;R++)for(w=0;w<D;w++)M=g[x],T[y+0]=S[4*M+0],T[y+1]=S[4*M+1],T[y+2]=S[4*M+2],T[y+3]=255,x++,y+=4;this.stage=4,console.log("Segm complete now "),this.objGraphics2d.forceRender();case 59:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"getStageString",value:function(){return["Wait. Model is not loaded","Wait. Model is loading ...","Model is ready","Image is processed ...","Segmentation is ready"][this.stage]}},{key:"setImageData",value:function(e){this.srcImageData=e}},{key:"render",value:function(e,t,i,n){this.srcImageData=n,this.wSrc=t,this.hSrc=i,console.log("Segm2d render. VGG model "+(null===this.model?"not loaded":"loaded"));var r=this.getStageString();if(console.log("Segm2d render. stage = "+r),4!==this.stage||null===this.pixels){e.fillStyle="rgb(64, 64, 64)",e.fillRect(0,0,t,i),e.strokeStyle="#FF0000",e.beginPath(),e.moveTo(0,0),e.lineTo(t-1,i-1),e.stroke(),e.beginPath(),e.moveTo(t-1,0),e.lineTo(0,i-1),e.stroke();var s=this.getStageString();e.font="24px serif",e.fillStyle="rgb(64, 255, 64)",e.fillText(s,t/2,i/2)}else{this.imgData=e.createImageData(t,i);for(var o=this.imgData.data,a=t*i*4,m=0;m<a;m++)o[m]=this.pixels[m];e.putImageData(this.imgData,0,0)}}}]),e}(),G=function(){function e(){Object(f.a)(this,e),this.m_palette=[{name:"amygdala",roiColor:"0.247059 0.584314 0.270588 1",roiId:139,position:"right",isBrain:!0},{name:"amygdala",roiColor:"0.309804 0.929412 0.054902 1",roiId:118,position:"left",isBrain:!0},{name:"angular gyrus",roiColor:"0.686275 0.231373 0.152941 1",roiId:19,position:"right",isBrain:!0},{name:"angular gyrus",roiColor:"0.811765 0.486275 0.117647 1",roiId:159,position:"left",isBrain:!0},{name:"anterior limb of internal capsule",roiColor:"0.309804 0.203922 0.462745 1",roiId:128,position:"right",isBrain:!0},{name:"anterior limb of internal capsule",roiColor:"0.435294 0.733333 0.027451 1",roiId:43,position:"left",isBrain:!0},{roiColor:"0.937255 0.94902 0.513725 1",roiId:20,name:"brain stem",isBrain:!0},{name:"caudate nucleus",roiColor:"0.74902 0.278431 0.141176 1",roiId:53,position:"right",isBrain:!0},{name:"caudate nucleus",roiColor:"0.184314 0.0745098 0.356863 1",roiId:39,position:"left",isBrain:!0},{name:"cerebellum",roiColor:"0.811765 0.458824 0.952941 1",roiId:76,position:"right",isBrain:!0},{name:"cerebellum",roiColor:"0.247059 0.113725 0.843137 1",roiId:67,position:"left",isBrain:!0},{name:"cingulate region",roiColor:"0.623529 0.45098 0.666667 1",roiId:7,position:"right",isBrain:!0},{name:"cingulate region",roiColor:"0.937255 0.631373 0.505882 1",roiId:27,position:"left",isBrain:!0},{roiColor:"0.937255 0.301961 0.470588 1",roiId:133,name:"corpus callosum",isBrain:!0},{name:"cuneus",roiColor:"0.435294 0.513725 0.768627 1",roiId:175,position:"right",isBrain:!0},{name:"cuneus",roiColor:"0.937255 0.729412 0.192157 1",roiId:54,position:"left",isBrain:!0},{name:"fornix",roiColor:"0.937255 0.415686 0.847059 1",roiId:254,position:"right",isBrain:!0},{name:"fornix",roiColor:"0.811765 0.67451 0.980392 1",roiId:29,position:"left",isBrain:!0},{roiColor:"0.247059 0.466667 0.105882 1",roiId:233,name:"fourth ventricle",isBrain:!0},{name:"frontal lobe WM",roiColor:"0.560784 0.290196 0.215686 1",roiId:17,position:"right",isBrain:!0},{name:"frontal lobe WM",roiColor:"0.498039 0.662745 0.101961 1",roiId:30,position:"left",isBrain:!0},{name:"globus palladus",roiColor:"0.0588235 0.843137 0.168627 1",roiId:11,position:"right",isBrain:!0},{name:"globus palladus",roiColor:"0.247059 0.74902 0.447059 1",roiId:12,position:"left",isBrain:!0},{name:"hippocampal formation",roiColor:"0.498039 0.709804 0.619608 1",roiId:36,position:"right",isBrain:!0},{name:"hippocampal formation",roiColor:"0.121569 0.4 0.972549 1",roiId:101,position:"left",isBrain:!0},{name:"inferior frontal gyrus",roiColor:"0.247059 0.85098 0.0666667 1",roiId:75,position:"right",isBrain:!0},{name:"inferior frontal gyrus",roiColor:"0.937255 0.662745 0.329412 1",roiId:15,position:"left",isBrain:!0},{name:"inferior occipital gyrus",roiColor:"0.0588235 0.643137 0.643137 1",roiId:97,position:"right",isBrain:!0},{name:"inferior occipital gyrus",roiColor:"0.247059 0.411765 0.568627 1",roiId:37,position:"left",isBrain:!0},{name:"inferior temporal gyrus",roiColor:"0.247059 0.00392157 0.796078 1",roiId:140,position:"right",isBrain:!0},{name:"inferior temporal gyrus",roiColor:"0.87451 0.819608 0.541176 1",roiId:164,position:"left",isBrain:!0},{name:"insula",roiColor:"0.623529 0.886275 0.356863 1",roiId:4,position:"right",isBrain:!0},{name:"insula",roiColor:"0.560784 0.698039 0.12549 1",roiId:108,position:"left",isBrain:!0},{name:"lateral front-orbital gyrus",roiColor:"0.435294 0.501961 0.203922 1",roiId:6,position:"right",isBrain:!0},{name:"lateral front-orbital gyrus",roiColor:"1 0.8 0.00784314 1",roiId:90,position:"left",isBrain:!0},{name:"lateral occipitotemporal gyrus",roiColor:"0.0588235 0.027451 0.470588 1",roiId:99,position:"right",isBrain:!0},{name:"lateral occipitotemporal gyrus",roiColor:"0.937255 0.101961 0.913725 1",roiId:196,position:"left",isBrain:!0},{name:"lateral ventricle",roiColor:"0.435294 0.176471 0.568627 1",roiId:8,position:"right",isBrain:!0},{name:"lateral ventricle",roiColor:"0.74902 0.764706 0.247059 1",roiId:3,position:"left",isBrain:!0},{name:"lingual gyrus",roiColor:"0.435294 0.458824 0.47451 1",roiId:112,position:"right",isBrain:!0},{name:"lingual gyrus",roiColor:"0.811765 0.0941176 0.301961 1",roiId:69,position:"left",isBrain:!0},{name:"medial front-orbital gyrus",roiColor:"0.87451 0.364706 0.384314 1",roiId:1,position:"right",isBrain:!0},{name:"medial front-orbital gyrus",roiColor:"0.811765 0.160784 0.247059 1",roiId:85,position:"left",isBrain:!0},{name:"medial frontal gyrus",roiColor:"0.435294 0.615686 0.0705882 1",roiId:114,position:"right",isBrain:!0},{name:"medial frontal gyrus",roiColor:"0.184314 0.372549 0.423529 1",roiId:9,position:"left",isBrain:!0},{name:"medial occipitotemporal gyrus",roiColor:"0.247059 0.368627 0.211765 1",roiId:165,position:"right",isBrain:!0},{name:"medial occipitotemporal gyrus",roiColor:"1 0.843137 0.254902 1",roiId:119,position:"left",isBrain:!0},{name:"middle frontal gyrus",roiColor:"0.623529 0.905882 0.113725 1",roiId:2,position:"right",isBrain:!0},{name:"middle frontal gyrus",roiColor:"0.686275 0.0901961 0.811765 1",roiId:50,position:"left",isBrain:!0},{name:"middle occipital gyrus",roiColor:"0.686275 0.933333 0.698039 1",roiId:63,position:"right",isBrain:!0},{name:"middle occipital gyrus",roiColor:"0.435294 0.0588235 0.964706 1",roiId:154,position:"left",isBrain:!0},{name:"middle temporal gyrus",roiColor:"0.937255 0.498039 0.67451 1",roiId:130,position:"right",isBrain:!0},{name:"middle temporal gyrus",roiColor:"0.498039 0.768627 0.439216 1",roiId:64,position:"left",isBrain:!0},{name:"nucleus accumbens",roiColor:"1 0.807843 0.529412 1",roiId:25,position:"right",isBrain:!0},{name:"nucleus accumbens",roiColor:"0.0588235 0.65098 0.0509804 1",roiId:72,position:"left",isBrain:!0},{name:"occipital lobe WM",roiColor:"0.0588235 0.368627 0.552941 1",roiId:45,position:"right",isBrain:!0},{name:"occipital lobe WM",roiColor:"0.0588235 0.639216 0.839216 1",roiId:73,position:"left",isBrain:!0},{name:"occipital pole",roiColor:"0.74902 0.494118 0.419608 1",roiId:132,position:"right",isBrain:!0},{name:"occipital pole",roiColor:"0.247059 0.807843 0.74902 1",roiId:251,position:"left",isBrain:!0},{name:"parahippocampal gyrus",roiColor:"0.121569 0.847059 0.00392157 1",roiId:125,position:"right",isBrain:!0},{name:"parahippocampal gyrus",roiColor:"0.247059 0.0705882 0.321569 1",roiId:18,position:"left",isBrain:!0},{name:"parietal lobe WM",roiColor:"1 0.4 0.223529 1",roiId:105,position:"right",isBrain:!0},{name:"parietal lobe WM",roiColor:"0.309804 0.678431 0.639216 1",roiId:57,position:"left",isBrain:!0},{name:"postcentral gyrus",roiColor:"0.560784 0.478431 0.2 1",roiId:110,position:"right",isBrain:!0},{name:"postcentral gyrus",roiColor:"0.498039 0.576471 0.027451 1",roiId:74,position:"left",isBrain:!0},{name:"posterior limb of internal capsule inc. cerebral peduncle",roiColor:"1 0.917647 0.576471 1",roiId:35,position:"right",isBrain:!0},{name:"posterior limb of internal capsule inc. cerebral peduncle",roiColor:"0.435294 0.490196 0.0784314 1",roiId:34,position:"left",isBrain:!0},{name:"precentral gyrus",roiColor:"0.184314 0.709804 0.615686 1",roiId:5,position:"right",isBrain:!0},{name:"precentral gyrus",roiColor:"0.87451 0.560784 1 1",roiId:80,position:"left",isBrain:!0},{name:"precuneus",roiColor:"1 0.654902 0.223529 1",roiId:32,position:"right",isBrain:!0},{name:"precuneus",roiColor:"1 0 0.211765 1",roiId:56,position:"left",isBrain:!0},{name:"putamen",roiColor:"1 0.831373 0.227451 1",roiId:16,position:"right",isBrain:!0},{name:"putamen",roiColor:"0.372549 0.678431 0.32549 1",roiId:14,position:"left",isBrain:!0},{name:"subthalamic nucleus",roiColor:"0.184314 0.545098 0.619608 1",roiId:23,position:"right",isBrain:!0},{name:"subthalamic nucleus",roiColor:"0.309804 0.686275 0.243137 1",roiId:33,position:"left",isBrain:!0},{name:"superior frontal gyrus",roiColor:"0.87451 0.380392 0.768627 1",roiId:10,position:"right",isBrain:!0},{name:"superior frontal gyrus",roiColor:"1 0.113725 0.396078 1",roiId:70,position:"left",isBrain:!0},{name:"superior occipital gyrus",roiColor:"0.372549 0.0431373 0.537255 1",roiId:38,position:"right",isBrain:!0},{name:"superior occipital gyrus",roiColor:"0.623529 0.301961 0.2 1",roiId:98,position:"left",isBrain:!0},{name:"superior parietal lobule",roiColor:"0.247059 0.843137 0.407843 1",roiId:88,position:"right",isBrain:!0},{name:"superior parietal lobule",roiColor:"0.87451 0.533333 0.254902 1",roiId:52,position:"left",isBrain:!0},{name:"superior temporal gyrus",roiColor:"0.498039 0.721569 0.996078 1",roiId:145,position:"right",isBrain:!0},{name:"superior temporal gyrus",roiColor:"1 0.67451 0.45098 1",roiId:61,position:"left",isBrain:!0},{name:"supramarginal gyrus",roiColor:"0.87451 0.45098 0.270588 1",roiId:60,position:"right",isBrain:!0},{name:"supramarginal gyrus",roiColor:"0.623529 0.0235294 0.654902 1",roiId:41,position:"left",isBrain:!0},{name:"temporal lobe WM",roiColor:"0.498039 0.603922 0.768627 1",roiId:59,position:"right",isBrain:!0},{name:"temporal lobe WM",roiColor:"0.87451 0.411765 0.368627 1",roiId:83,position:"left",isBrain:!0},{name:"thalamus",roiColor:"0.0588235 0.796078 0.866667 1",roiId:203,position:"right",isBrain:!0},{name:"thalamus",roiColor:"0.74902 0.984314 0.341176 1",roiId:102,position:"left",isBrain:!0},{roiColor:"0.811765 0.258824 0.823529 1",roiId:232,name:"third ventricle",isBrain:!0},{name:"uncus",roiColor:"0.121569 0.352941 0.196078 1",roiId:26,position:"right",isBrain:!0},{name:"uncus",roiColor:"0.623529 0.117647 0.14902 1",roiId:62,position:"left",isBrain:!0},{name:"xxx_brain_internal",roiColor:"0.8 0.8 0.1 1",roiId:150,position:"left",isBrain:!0},{name:"xxx_brain_core",roiColor:"0.2 0.8 0.2 1",roiId:250,position:"left",isBrain:!0}],this.createBytePalette256()}return Object(v.a)(e,[{key:"createBytePalette256",value:function(){var e;for(this.m_palette256=new Uint8Array(1024),e=0;e<1024;e++)this.m_palette256[e]=0;var t=this.m_palette.length;for(e=0;e<t;e++){var i=this.m_palette[e].roiId,n=this.m_palette[e].roiColor.split(" "),r=Math.floor(255*parseFloat(n[0])),s=Math.floor(255*parseFloat(n[1])),o=Math.floor(255*parseFloat(n[2])),a=4*parseInt(i,10);this.m_palette256[a+0]=r,this.m_palette256[a+1]=s,this.m_palette256[a+2]=o,this.m_palette256[a+3]=255}}},{key:"getPalette",value:function(){return this.m_palette}},{key:"getPalette256",value:function(){return this.m_palette256}}]),e}(),W=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).onMouseDown=n.onMouseDown.bind(Object(S.a)(n)),n.onMouseUp=n.onMouseUp.bind(Object(S.a)(n)),n.onMouseMove=n.onMouseMove.bind(Object(S.a)(n)),n.onMouseWheel=n.onMouseWheel.bind(Object(S.a)(n)),n.m_sliceRatio=.5,n.m_mode2d=u.TRANSVERSE,n.m_zoom=1,n.m_xPos=0,n.m_yPos=0,n.m_isMounted=!1,n.state={wRender:0,hRender:0,stateMouseDown:!1,xMouse:-1,yMouse:-1},n.segm2d=new j(Object(S.a)(n)),n.m_isSegmented=!1,n.m_toolPick=new w(Object(S.a)(n)),n.m_toolDistance=new E(Object(S.a)(n)),n.m_toolZoom=new M(Object(S.a)(n)),n.m_toolClear=new A(Object(S.a)(n)),n.m_toolAngle=new I(Object(S.a)(n)),n.m_toolArea=new O(Object(S.a)(n)),n.m_toolRect=new X(Object(S.a)(n)),n.m_toolText=new C(Object(S.a)(n)),n.m_toolEdit=new P(Object(S.a)(n)),n.m_toolDelete=new k(Object(S.a)(n)),n.m_roiPalette=new G,e.dispatch({type:l.SET_GRAPHICS_2D,graphics2d:Object(S.a)(n)}),n}return Object(v.a)(i,[{key:"componentDidMount",value:function(){this.m_isMounted=!0,this.prepareImageForRender(),this.renderReadyImage();var e=this.m_mount.clientWidth,t=this.m_mount.clientHeight;0===this.state.wRender&&(this.setState({wRender:e}),this.setState({hRender:t}))}},{key:"componentWillUnmount",value:function(){this.m_isMounted=!1}},{key:"componentDidUpdate",value:function(){this.m_isMounted&&this.renderReadyImage()}},{key:"screenshot",value:function(e,t){return console.log("get screenshot from 2d canvas: ".concat(e,"*").concat(t)),this.m_mount.toDataURL()}},{key:"renderTextInfo",value:function(e,t,i){var n,r=4,s=16;e.font=s.toString()+"px Arial",e.textAlign="left",e.textBaseline="top",e.fillStyle="grey",n="volume dim = "+i.m_xDim.toString()+" * "+i.m_yDim.toString()+" * "+i.m_zDim.toString(),e.fillText(n,4,r),r+=s;var o=Math.floor(i.m_boxSize.x),a=Math.floor(i.m_boxSize.y),m=Math.floor(i.m_boxSize.z);n="vol phys size = "+o.toString()+" * "+a.toString()+" * "+m.toString(),e.fillText(n,4,r),r+=s;var l=t.m_patientName;l.length>1&&(n="patient name = "+l,e.fillText(n,4,r),r+=s);var h=t.m_patientBirth;h.length>1&&(n="patient birth = "+h,e.fillText(n,4,r),r+=s);var u=t.m_seriesDescr;u.length>1&&(n="series descr = "+u,e.fillText(n,4,r),r+=s);var c=t.m_institutionName;c.length>1&&(n="institution name = "+c,e.fillText(n,4,r),r+=s);var d=t.m_operatorsName;d.length>1&&(n="operators name = "+d,e.fillText(n,4,r),r+=s);var _=t.m_physicansName;_.length>1&&(n="physicans name = "+_,e.fillText(n,4,r),r+=s)}},{key:"prepareImageForRender",value:function(e){var t=this.m_mount;if(null!==t){var i=t.getContext("2d"),n=t.clientWidth,r=t.clientHeight;if(n*r!==0){var s=this.props;i.fillStyle="rgb(64, 64, 64)",i.fillRect(0,0,n,r);var o=s.volumeSet,a=void 0!==e?e:s.volumeIndex,m=o.getVolume(a),l=this.m_mode2d,h=s.slider2d;if(null!==m){if(null===m.m_dataArray)return void console.log("Graphics2d. Volume has no data array");var c=m.m_xDim,d=m.m_yDim,_=m.m_zDim,f=c*d,v=m.m_dataArray;v.length!==c*d*_*m.m_bytesPerVoxel&&console.log("Bad src data len = ".concat(v.length,", but expect ").concat(c,"*").concat(d,"*").concat(_));var p=null,g=null,S=this.m_roiPalette.getPalette256(),x=m.m_boxSize;x.x*x.y*x.z<1e-5&&console.log("Bad physical dimensions for rendered volume = ".concat(x.x,"*").concat(x.y,"*").concat(x.z," "));var y=0,T=0,D=s.render2dxPos,b=s.render2dyPos,R=s.render2dZoom;if(l===u.TRANSVERSE){var w=x.x/x.y;y=n,(T=Math.floor(n/w))>r&&(T=r,(y=Math.floor(r*w))>n&&console.log("logic error! wScreen * hScreen = ".concat(y," * ").concat(T))),T=T>0?T:1,this.m_toolPick.setScreenDim(y,T),this.m_toolZoom.setScreenDim(y,T),this.m_toolDistance.setScreenDim(y,T),this.m_toolAngle.setScreenDim(y,T),this.m_toolArea.setScreenDim(y,T),this.m_toolRect.setScreenDim(y,T),this.m_toolText.setScreenDim(y,T),this.m_toolEdit.setScreenDim(y,T),this.m_toolDelete.setScreenDim(y,T);var M=m.m_boxSize.x/c,E=m.m_boxSize.y/d;this.m_toolDistance.setPixelSize(M,E),this.m_toolAngle.setPixelSize(M,E),this.m_toolArea.setPixelSize(M,E),this.m_toolRect.setPixelSize(M,E),this.m_toolText.setPixelSize(M,E),this.m_toolEdit.setPixelSize(M,E),this.m_toolDelete.setPixelSize(M,E),(g=(p=i.createImageData(y,T)).data).length!==y*T*4&&console.log("Bad dst data len = ".concat(g.length,", but expect ").concat(y,"*").concat(T,"*4"));var A=Math.floor(_*h),I=(A=A<_?A:_-1)*f,O=R*c/y,X=R*d/T,C=0,P=b*d;if(1===m.m_bytesPerVoxel)for(var k=0;k<T;k++,P+=X)for(var F=Math.floor(P)*c,U=D*c,L=0;L<y;L++,U+=O){var N=v[I+F+Math.floor(U)];g[C+0]=N,g[C+1]=N,g[C+2]=N,g[C+3]=255,C+=4}else if(4===m.m_bytesPerVoxel)for(var z=0;z<T;z++,P+=X)for(var V=Math.floor(P)*c,B=D*c,j=0;j<y;j++,B+=O){var G=4*v[4*(I+V+Math.floor(B))+3],W=S[G+0],H=S[G+1],Y=S[G+2];g[C+0]=Y,g[C+1]=H,g[C+2]=W,g[C+3]=255,C+=4}}else if(l===u.SAGGITAL){var q=x.y/x.z;y=n,(T=Math.floor(n/q))>r&&(T=r,(y=Math.floor(r*q))>n&&console.log("logic error! wScreen * hScreen = ".concat(y," * ").concat(T))),T=T>0?T:1,this.m_toolPick.setScreenDim(y,T),this.m_toolZoom.setScreenDim(y,T),this.m_toolDistance.setScreenDim(y,T),this.m_toolAngle.setScreenDim(y,T),this.m_toolArea.setScreenDim(y,T),this.m_toolRect.setScreenDim(y,T),this.m_toolText.setScreenDim(y,T),this.m_toolEdit.setScreenDim(y,T),this.m_toolDelete.setScreenDim(y,T);var Z=m.m_boxSize.y/d,K=m.m_boxSize.z/_;this.m_toolDistance.setPixelSize(Z,K),this.m_toolAngle.setPixelSize(Z,K),this.m_toolArea.setPixelSize(Z,K),this.m_toolRect.setPixelSize(Z,K),this.m_toolText.setPixelSize(Z,K),this.m_toolEdit.setPixelSize(Z,K),this.m_toolDelete.setPixelSize(Z,K),(g=(p=i.createImageData(y,T)).data).length!==y*T*4&&console.log("Bad dst data len = ".concat(g.length,", but expect ").concat(y,"*").concat(T,"*4"));var Q=Math.floor(c*h);Q=Q<c?Q:c-1;var J=R*d/y,$=R*_/T,ee=0,te=b*_;if(1===m.m_bytesPerVoxel)for(var ie=0;ie<T;ie++,te+=$)for(var ne=Math.floor(te)*c*d,re=D*d,se=0;se<y;se++,re+=J){var oe=v[ne+Math.floor(re)*c+Q];g[ee+0]=oe,g[ee+1]=oe,g[ee+2]=oe,g[ee+3]=255,ee+=4}else if(4===m.m_bytesPerVoxel)for(var ae=0;ae<T;ae++,te+=$)for(var me=Math.floor(te)*c*d,le=D*d,he=0;he<y;he++,le+=J){var ue=4*v[4*(me+Math.floor(le)*c+Q)+3],ce=S[ue+0],de=S[ue+1],_e=S[ue+2];g[ee+0]=_e,g[ee+1]=de,g[ee+2]=ce,g[ee+3]=255,ee+=4}}else if(l===u.CORONAL){var fe=x.x/x.z;y=n,(T=Math.floor(n/fe))>r&&(T=r,(y=Math.floor(r*fe))>n&&console.log("logic error! wScreen * hScreen = ".concat(y," * ").concat(T))),T=T>0?T:1,this.m_toolPick.setScreenDim(y,T),this.m_toolZoom.setScreenDim(y,T),this.m_toolDistance.setScreenDim(y,T),this.m_toolAngle.setScreenDim(y,T),this.m_toolArea.setScreenDim(y,T),this.m_toolRect.setScreenDim(y,T),this.m_toolText.setScreenDim(y,T),this.m_toolEdit.setScreenDim(y,T),this.m_toolDelete.setScreenDim(y,T);var ve=m.m_boxSize.x/c,pe=m.m_boxSize.z/_;this.m_toolDistance.setPixelSize(ve,pe),this.m_toolAngle.setPixelSize(ve,pe),this.m_toolArea.setPixelSize(ve,pe),this.m_toolRect.setPixelSize(ve,pe),this.m_toolText.setPixelSize(ve,pe),this.m_toolEdit.setPixelSize(ve,pe),this.m_toolDelete.setPixelSize(ve,pe),(g=(p=i.createImageData(y,T)).data).length!==y*T*4&&console.log("Bad dst data len = ".concat(g.length,", but expect ").concat(y,"*").concat(T,"*4"));var ge=Math.floor(d*h),Se=(ge=ge<d?ge:d-1)*c,xe=R*c/y,ye=R*_/T,Te=0,De=b*_;if(1===m.m_bytesPerVoxel)for(var be=0;be<T;be++,De+=ye)for(var Re=Math.floor(De)*c*d,we=D*c,Me=0;Me<y;Me++,we+=xe){var Ee=v[Re+Se+Math.floor(we)];g[Te+0]=Ee,g[Te+1]=Ee,g[Te+2]=Ee,g[Te+3]=255,Te+=4}else if(4===m.m_bytesPerVoxel)for(var Ae=0;Ae<T;Ae++,De+=ye)for(var Ie=Math.floor(De)*c*d,Oe=D*c,Xe=0;Xe<y;Xe++,Oe+=xe){var Ce=4*v[4*(Ie+Se+Math.floor(Oe))+3],Pe=S[Ce+0],ke=S[Ce+1],Fe=S[Ce+2];g[Te+0]=Fe,g[Te+1]=ke,g[Te+2]=Pe,g[Te+3]=255,Te+=4}}this.imgData=p,this.segm2d.setImageData(p)}}}}},{key:"renderReadyImage",value:function(){if(this.m_isMounted){var e=this.m_mount;if(null!==e){var t=e.getContext("2d"),i=this.props,n=i.volumeSet;if(0!==n.getNumVolumes()){var r=i.volumeIndex,s=n.getVolume(r);if(null!==s){if(this.m_isSegmented){var o=this.m_toolPick.m_wScreen,a=this.m_toolPick.m_hScreen;this.segm2d.render(t,o,a,this.imgData)}else t.putImageData(this.imgData,0,0);this.renderTextInfo(t,n,s),this.m_toolPick.render(t),this.m_toolDistance.render(t,i),this.m_toolAngle.render(t,i),this.m_toolArea.render(t,i),this.m_toolRect.render(t,i),this.m_toolText.render(t,i),this.m_toolEdit.render(t,i),this.m_toolDelete.render(t,i)}}}}}},{key:"onMouseWheel",value:function(e){var t=this.props;t.indexTools2d===F.ZOOM&&this.m_toolZoom.onMouseWheel(t,e)}},{key:"onMouseUp",value:function(e){var t=this.props.indexTools2d;if(t===F.ZOOM&&this.m_toolZoom.onMouseUp(),t===F.DISTANCE){var i=this.props,n=this.m_mount.getBoundingClientRect(),r=e.clientX-n.left,s=e.clientY-n.top;this.m_toolDistance.onMouseUp(r,s,i)}if(t===F.ANGLE){var o=this.props,a=this.m_mount.getBoundingClientRect(),m=e.clientX-a.left,l=e.clientY-a.top;this.m_toolAngle.onMouseUp(m,l,o)}if(t===F.AREA){var h=this.props,u=this.m_mount.getBoundingClientRect(),c=e.clientX-u.left,d=e.clientY-u.top;this.m_toolArea.onMouseUp(c,d,h)}if(t===F.RECT){var _=this.props,f=this.m_mount.getBoundingClientRect(),v=e.clientX-f.left,p=e.clientY-f.top;this.m_toolRect.onMouseUp(v,p,_)}if(t===F.EDIT){var g=this.props,S=this.m_mount.getBoundingClientRect(),x=e.clientX-S.left,y=e.clientY-S.top;this.m_toolEdit.onMouseUp(x,y,g)}if(t===F.DELETE){var T=this.props,D=this.m_mount.getBoundingClientRect(),b=e.clientX-D.left,R=e.clientY-D.top;this.m_toolDelete.onMouseUp(b,R,T)}}},{key:"onMouseMove",value:function(e){var t=this.props,i=t.indexTools2d,n=this.m_mount.getBoundingClientRect(),r=e.clientX-n.left,s=e.clientY-n.top;i===F.ZOOM&&this.m_toolZoom.onMouseMove(t,r,s),i===F.DISTANCE&&this.m_toolDistance.onMouseMove(r,s,t),i===F.ANGLE&&this.m_toolAngle.onMouseMove(r,s,t),i===F.AREA&&this.m_toolArea.onMouseMove(r,s,t),i===F.RECT&&this.m_toolRect.onMouseMove(r,s,t),i===F.EDIT&&this.m_toolEdit.onMouseMove(r,s,t),i===F.DELETE&&this.m_toolDelete.onMouseMove(r,s,t)}},{key:"onMouseDown",value:function(e){var t=this.m_mount.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top,r=this.props;switch(r.indexTools2d){case F.INTENSITY:this.m_toolPick.onMouseDown(i,n,r);break;case F.DISTANCE:this.m_toolDistance.onMouseDown(i,n,r);break;case F.ZOOM:this.m_toolZoom.onMouseDown(i,n);break;case F.ANGLE:this.m_toolAngle.onMouseDown(i,n,r);break;case F.AREA:this.m_toolArea.onMouseDown(i,n,r);break;case F.RECT:this.m_toolRect.onMouseDown(i,n,r);break;case F.TEXT:this.m_toolText.onMouseDown(i,n,r);break;case F.EDIT:this.m_toolEdit.onMouseDown(i,n,r);break;case F.DELETE:this.m_toolDelete.onMouseDown(i,n,r)}this.forceUpdate()}},{key:"clear",value:function(){this.m_toolDistance.clear(),this.m_toolAngle.clear(),this.m_toolArea.clear(),this.m_toolRect.clear(),this.m_toolText.clear(),this.m_toolEdit.clear(),this.m_toolDelete.clear()}},{key:"forceUpdate",value:function(e){this.prepareImageForRender(e),this.m_isSegmented?null!==this.segm2d.model&&this.segm2d.startApplyImage():this.forceRender()}},{key:"forceRender",value:function(){this.m_isMounted&&this.setState({state:this.state})}},{key:"render",value:function(){var e=this;this.m_sliceRatio=this.props.sliderValue,this.m_mode2d=this.props.mode2d;var t=r.a.createElement("canvas",{ref:function(t){e.m_mount=t},style:{width:"100%",height:"100%"}}),i=r.a.createElement("canvas",{ref:function(t){e.m_mount=t},width:this.state.wRender,height:this.state.hRender,onMouseDown:this.onMouseDown,onMouseUp:this.onMouseUp,onMouseMove:this.onMouseMove,onWheel:this.onMouseWheel});return this.state.wRender>0?i:t}}]),i}(r.a.Component),H=Object(a.b)((function(e){return e}))(W),Y=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(){return Object(f.a)(this,i),t.apply(this,arguments)}return Object(v.a)(i,[{key:"render",value:function(){var e={minHeight:882..toString()+"px"};return r.a.createElement(D.a,{fluid:"true",style:{height:"100%",minHeight:"100%"}},r.a.createElement(x.a,null,r.a.createElement(y.a,{xs:!0,md:!0,lg:"12",style:{height:"100%",position:"relative"}}),r.a.createElement(y.a,{lg:8,style:e},r.a.createElement(H,null))))}}]),i}(r.a.Component),q=Object(a.b)((function(e){return e}))(Y),Z=i(2),K=function(){function e(){Object(f.a)(this,e),this.m_useWebGL2=void 0}return Object(v.a)(e,[{key:"createWebGLContext",value:function(){this.canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var e=this.canvas.getContext("webgl2");return this.m_useWebGL2=1,null==e?(console.log("WebGL 2 not supported, moving to webgl 1"),e=this.canvas.getContext("webgl"),this.m_useWebGL2=0):console.log("WebGL 2 context created"),e}},{key:"getCanvas",value:function(){return this.canvas}},{key:"useWebGL2",value:function(){return this.m_useWebGL2}}]),e}(),Q=function(){function e(t,i,n,r,s){Object(f.a)(this,e),this.m_callback=s,this.m_mesh=r,this.m_wireMesh=null,this.m_camera=i,this.m_target=new Z.R(0,0,0),this.m_scene=n,this.m_button=e.EVENT_BUTTON_NA,this.domElem=t,this.m_pressedLeft=!1,this.m_pressedRight=!1,this.m_prevMouse={x:-1,y:-1},this.m_prevTime=-1,this.m_deltaTime=0,this.m_spherical=new Z.L,this.m_sphericalDelta=new Z.L,this.m_spherical.set(0,0,0),this.m_sphericalDelta.set(0,0,0),this.m_autoRotate=!1,this.m_minDistance=.3,this.m_maxDistance=2.5,this.m_minAzimuthAngle=-1/0,this.m_maxAzimuthAngle=1/0,this.m_minPolarAngle=0,this.m_maxPolarAngle=2*Math.PI,this.m_enableDamping=!1,this.m_dampingFactor=.25,this.isEraserMode=!1}return Object(v.a)(e,[{key:"setEraserMode",value:function(e){this.isEraserMode=e}},{key:"setMesh",value:function(e){this.m_mesh=e}},{key:"setWireMesh",value:function(e){this.m_wireMesh=e}},{key:"setScene",value:function(e){this.m_scene=e}},{key:"getX",value:function(e){return e-this.domElem.offsetLeft}},{key:"getY",value:function(e){return e-this.domElem.offsetTop}},{key:"updateTime",value:function(e,t){if(0!==e||0!==t){var i=(new Date).getTime();if(this.m_prevTime=this.m_prevTime>0?this.m_prevTime:i,this.m_deltaTime=i-this.m_prevTime,this.m_prevTime=i,this.m_mesh){var n=new Z.x,r=new Z.x,s=new Z.x,o=new Z.R;o.copy(this.m_target).sub(this.m_camera.position).normalize(),r.makeRotationAxis(this.m_camera.up,.008*e),n.makeRotationAxis(o.cross(this.m_camera.up),.008*t),s.identity(),s.multiply(r).multiply(n).multiply(this.m_mesh.matrix),this.m_mesh.rotation.setFromRotationMatrix(s),this.m_wireMesh&&(s.identity(),s.multiply(r).multiply(n).multiply(this.m_wireMesh.matrix),this.m_wireMesh.rotation.setFromRotationMatrix(s)),this.m_callback()}}}},{key:"onMouseDown",value:function(e,t,i){this.m_pressedLeft=!0,this.m_prevMouse={x:e,y:t},this.m_spherical.set(0,0,0),this.m_sphericalDelta.set(0,0,0),this.m_prevTime=(new Date).getTime(),this.ctrlKey=i}},{key:"onMouseUp",value:function(){this.m_pressedLeft=!1,this.m_prevMouse.x=-1,this.m_prevMouse.y=-1}},{key:"onMouseMove",value:function(e,t){this.m_prevMouse.x<0&&(this.m_prevMouse.x=e,this.m_prevMouse.y=t);var i=e-this.m_prevMouse.x,n=t-this.m_prevMouse.y;this.m_prevMouse.x=e,this.m_prevMouse.y=t,this.m_pressedLeft&&this.updateTime(i,n)}},{key:"onZoom",value:function(e){var t=.2*e,i=this.m_camera.position.length(),n=this.m_camera.position.sub(this.m_target);n.normalize(),i+=t,i=Math.max(i,.3),i=Math.min(i,2.5),n.multiplyScalar(i),this.m_camera.position.set(n.x,n.y,n.z),this.m_camera.lookAt(this.m_target),this.m_camera.updateMatrixWorld()}}]),e}();Q.EVENT_BUTTON_NA=-1,Q.EVENT_BUTTON_LEFT=0,Q.EVENT_BUTTON_CENTER=1,Q.EVENT_BUTTON_RIGHT=2;var J=i.p+"static/media/backface.3dc9d515.vert",$=i.p+"static/media/backface.84a75448.frag",ee=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment=""}return Object(v.a)(e,[{key:"create",value:function(e){var t=this,i=new Z.o(Z.l);i.setResponseType("text");var n=new Z.o(Z.l);n.setResponseType("text"),i.load(J,(function(i){t.m_strShaderVertex=i,n.load($,(function(i){t.m_strShaderFragment=i;var n=new Z.K({vertexShader:t.m_strShaderVertex,fragmentShader:t.m_strShaderFragment,side:Z.c,depthTest:!0,depthFunc:Z.s,blending:Z.A});e&&e(n)}))}))}}]),e}(),te=i.p+"static/media/frontface.6197e7b1.vert",ie=i.p+"static/media/frontface.7ecf0644.frag",ne=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={texBF:{type:"t",value:null},PlaneX:{type:"v4",value:new Z.S(-1,0,0,.5)},PlaneY:{type:"v4",value:new Z.S(0,-1,0,.5)},PlaneZ:{type:"v4",value:new Z.S(0,0,-1,.5)}}}return Object(v.a)(e,[{key:"create",value:function(e,t){var i=this;this.m_uniforms.texBF.value=e;var n=new Z.o(Z.l);n.setResponseType("text");var r=new Z.o(Z.l);r.setResponseType("text"),n.load(te,(function(e){i.m_strShaderVertex=e,r.load(ie,(function(e){i.m_strShaderFragment=e;var n=new Z.K({uniforms:i.m_uniforms,vertexShader:i.m_strShaderVertex,fragmentShader:i.m_strShaderFragment,side:Z.q,depthTest:!0,depthFunc:Z.t,blending:Z.A});t&&t(n)}),(function(e){console.log("Shader load failed! because of error "+e.target.status+", "+e.target.statusText)}))}))}}]),e}(),re=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_defines={backCullMode:1},this.m_uniforms={texBF:{type:"t",value:null},texFF:{type:"t",value:null}}}return Object(v.a)(e,[{key:"create",value:function(e,t){return this.m_uniforms.texBF.value=e,this.m_uniforms.texFF.value=t,this.m_strShaderVertex="\n      varying vec3 pos;\n      attribute vec3 uvw;\n      varying vec4 screenpos;\n      void main() {\n        pos = uvw;\n        screenpos = (projectionMatrix  * modelViewMatrix * vec4(position, 1.0));\n        gl_Position =  screenpos;\n      }\n    ",this.m_strShaderFragment="\n      precision highp float;\n      precision highp int;\n      uniform sampler2D texFF;\n      uniform sampler2D texBF;\n\n      varying vec3 pos;\n      varying vec4 screenpos;\n      void main() {\n      vec2 tc = screenpos.xy / screenpos.w * 0.5 + 0.5;\n      vec3 back  = texture2D(texBF, tc, 0.0).xyz;\n      vec3 front = texture2D(texFF, tc, 0.0).xyz;\n      float cullvalue = length(pos - back) - length(front - back);\n\n\n      #if backCullMode == 1\n        if (cullvalue < -0.001)\n          discard;\n      #endif\n      #if backCullMode == 0\n        if (cullvalue > 0.001)\n          discard;\n      #endif\n\n        gl_FragColor = vec4(0.5, 0.0, 1.0, 1.0);\n        //gl_FragColor = vec4(cullvalue, cullvalue, cullvalue, 1.0);\n        //gl_FragColor = vec4(front, 1.0);\n      }\n    ",new Z.K({uniforms:this.m_uniforms,defines:this.m_defines,vertexShader:this.m_strShaderVertex,fragmentShader:this.m_strShaderFragment,side:Z.q,wireframe:!0,depthTest:!1,polygonOffset:!1,polygonOffsetFactor:-4,polygonOffsetUnits:-4})}}]),e}(),se=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={texBuffer:{type:"t",value:null}}}return Object(v.a)(e,[{key:"create",value:function(e){return this.m_uniforms.texBuffer.value=e,this.m_strShaderVertex="\n      varying vec4 screenpos;\n      void main() {\n        screenpos = (projectionMatrix  * modelViewMatrix * vec4(position, 1.0));\n        gl_Position =  screenpos;\n      }\n    ",this.m_strShaderFragment="\n      precision highp float;\n      precision highp int;\n      uniform sampler2D texBuffer;\n\n      varying vec4 screenpos;\n      void main() {\n        vec2 tc = screenpos.xy / screenpos.w * 0.5 + 0.5;\n        gl_FragColor = texture2D(texBuffer, tc, 0.0);\n      }\n    ",new Z.K({uniforms:this.m_uniforms,vertexShader:this.m_strShaderVertex,fragmentShader:this.m_strShaderFragment,side:Z.q,depthTest:!0,depthFunc:Z.t,blending:Z.A})}}]),e}(),oe=i.p+"static/media/clipplane.7ba65be0.vert",ae=i.p+"static/media/clipplane.d594e568.frag",me=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={MVP:{type:"m4"},texBF:{type:"t"}}}return Object(v.a)(e,[{key:"create",value:function(e,t){var i=this;this.m_uniforms.texBF.value=e;var n=new Z.o(Z.l);n.setResponseType("text");var r=new Z.o(Z.l);r.setResponseType("text"),n.load(oe,(function(e){i.m_strShaderVertex=e,r.load(ae,(function(e){i.m_strShaderFragment=e;var n=new Z.K({uniforms:i.m_uniforms,vertexShader:i.m_strShaderVertex,fragmentShader:i.m_strShaderFragment,side:Z.m,depthTest:!1,depthWrite:!1});t&&t(n)}))}))}}]),e}(),le=i.p+"static/media/rendertotexture.b51229d9.vert",he=i.p+"static/media/rendertotexture.f0ef0a21.frag",ue=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={texTF:{type:"t",value:null},texVolume:{type:"t",value:null},texRoiId:{type:"t",value:null},texRoiColor:{type:"t",value:null},RoiVolumeTex:{type:"t",value:null},texVolumeMask:{type:"t",value:null},texVolumeAO:{type:"t",value:null},lightDir:{type:"v3",value:new Z.R(0,0,0)},texBF:{type:"t",value:null},texFF:{type:"t",value:null},t_function1min:{type:"v4",value:new Z.S(0,0,0,0)},t_function1max:{type:"v4",value:new Z.S(0,0,0,0)},t_function2min:{type:"v4",value:new Z.S(0,0,0,0)},t_function2max:{type:"v4",value:new Z.S(0,0,0,0)},stepSize:{type:"v4",value:new Z.S(0,0,0,0)},texSize:{type:"f",value:0},isoThreshold:{type:"f",value:0},brightness3D:{type:"f",value:0},contrast3D:{type:"f",value:0},colorMap1D:{type:"t",value:null},heatMap1D:{type:"t",value:null},opacityBarrier:{type:"f",value:0},tileCountX:{type:"f",value:0},volumeSizeZ:{type:"f",value:0},xDim:{type:"f",value:0},yDim:{type:"f",value:0},zDim:{type:"f",value:0},ssaoOffsets:{type:"v3v"}},this.m_defines={isoRenderFlag:0,MaskFlag:0,useAmbientTex:0,useWebGL2:1}}return Object(v.a)(e,[{key:"create",value:function(e,t,i,n,r,s,o,a){var m=this;this.m_uniforms.texTF.value=e,this.m_uniforms.texVolume.value=t,this.m_uniforms.texVolumeMask.value=i,this.m_uniforms.texVolumeAO.value=n,this.m_uniforms.texBF.value=r,this.m_uniforms.texFF.value=s,this.m_uniforms.ssaoOffsets.value=o;var l=new Z.o(Z.l);l.setResponseType("text");var h=new Z.o(Z.l);h.setResponseType("text"),l.load(le,(function(e){m.m_strShaderVertex=e,h.load(he,(function(e){m.m_strShaderFragment=e;var t=new Z.K({uniforms:m.m_uniforms,defines:m.m_defines,vertexShader:m.m_strShaderVertex,fragmentShader:m.m_strShaderFragment,side:Z.c,depthTest:!0,depthFunc:Z.s,blending:Z.A});a&&a(t)}))}))}}]),e}(),ce=i.p+"static/media/interpolation.ae2f2bf4.vert",de=i.p+"static/media/interpolation.b65fb94f.frag",_e=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={isoSurfTexel:{type:"v2",value:null},texIsoSurface:{type:"t",value:null}},this.m_defines={isoRenderFlag:0}}return Object(v.a)(e,[{key:"create",value:function(e,t){var i=this;this.m_uniforms.texIsoSurface.value=e;var n=new Z.o(Z.l);n.setResponseType("text");var r=new Z.o(Z.l);r.setResponseType("text"),n.load(ce,(function(e){i.m_strShaderVertex=e,r.load(de,(function(e){i.m_strShaderFragment=e;var n=new Z.K({uniforms:i.m_uniforms,defines:i.m_defines,vertexShader:i.m_strShaderVertex,fragmentShader:i.m_strShaderFragment,side:Z.c});t&&t(n)}))}))}}]),e}(),fe=i.p+"static/media/volumerender.0fdf551f.vert",ve=i.p+"static/media/volumerender.fb827430.frag",pe=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="",this.m_uniforms={isoSurfTexel:{type:"v2",value:null},lightDir:{type:"v3",value:new Z.R(0,0,0)},texTF:{type:"t",value:null},texVolume:{value:null},texRoiId:{type:"t",value:null},texRoiColor:{type:"t",value:null},RoiVolumeTex:{type:"t",value:null},texVolumeMask:{type:"t",value:null},texVolumeAO:{type:"t",value:null},texBF:{type:"t",value:null},texFF:{type:"t",value:null},texIsoSurface:{type:"t",value:null},colorMap1D:{type:"t",value:null},heatMap1D:{type:"t",value:null},t_function1min:{type:"v4",value:new Z.S(0,0,0,0)},t_function1max:{type:"v4",value:new Z.S(0,0,0,0)},t_function2min:{type:"v4",value:new Z.S(0,0,0,0)},t_function2max:{type:"v4",value:new Z.S(0,0,0,0)},stepSize:{type:"v4",value:new Z.S(0,0,0,0)},texSize:{type:"f",value:0},isoThreshold:{type:"f",value:0},brightness3D:{type:"f",value:0},contrast3D:{type:"f",value:0},tileCountX:{type:"f",value:0},volumeSizeZ:{type:"f",value:0},opacityBarrier:{type:"f",value:0},xDim:{type:"f",value:0},yDim:{type:"f",value:0},zDim:{type:"f",value:0},ssaoOffsets:{type:"v3v"}},this.m_defines={isoRenderFlag:0,MaskFlag:0,useAmbientTex:0,useWebGL2:1}}return Object(v.a)(e,[{key:"create",value:function(e,t,i,n,r,s,o,a,m){var l=this;this.m_uniforms.texTF.value=e,this.m_uniforms.texVolume.value=t,this.m_uniforms.texVolumeMask.value=i,this.m_uniforms.texVolumeAO.value=n,this.m_uniforms.texBF.value=r,this.m_uniforms.texFF.value=s,this.m_uniforms.texIsoSurface.value=o,this.m_uniforms.ssaoOffsets.value=a;var h=new Z.o(Z.l);h.setResponseType("text");var u=new Z.o(Z.l);u.setResponseType("text"),h.load(fe,(function(e){l.m_strShaderVertex=e,u.load(ve,(function(e){l.m_strShaderFragment=e;var t=new Z.K({uniforms:l.m_uniforms,defines:l.m_defines,vertexShader:l.m_strShaderVertex,fragmentShader:l.m_strShaderFragment,side:Z.c,depthTest:!0,depthFunc:Z.s,blending:Z.A});m&&m(t)}))}))}}]),e}(),ge=i.p+"static/media/blur.a62df0a0.vert",Se=i.p+"static/media/blur.d95db93c.frag",xe=function(){function e(){Object(f.a)(this,e),this.m_strShaderVertex="",this.m_strShaderFragment="";this.m_uniforms={texVolume:{type:"t",value:null},texVolumeRoi:{type:"t",value:null},texRoiColor:{type:"t",value:null},texSegInUse:{type:"t",value:null},texelSize:{type:"v3",value:null},tileCountX:{type:"f",value:16},volumeSizeZ:{type:"f",value:256},xDim:{type:"f",value:256},yDim:{type:"f",value:256},blurSigma:{type:"f",value:.8},contrast:{type:"f",value:1},brightness:{type:"f",value:0},curZ:{type:"f",value:0},save_flag:{type:"b",value:!0}},this.m_defines={renderRoiMap:0,useWebGL2:1}}return Object(v.a)(e,[{key:"create",value:function(e,t,i,n,r,s){var o=this;this.m_uniforms.texVolume.value=e,this.m_uniforms.texVolume.value=e,this.m_uniforms.texVolumeRoi.value=t,this.m_uniforms.texRoiColor.value=n,this.m_uniforms.texSegInUse.value=r,this.m_uniforms.texelSize.value=i;var a=new Z.o(Z.l);a.setResponseType("text");var m=new Z.o(Z.l);m.setResponseType("text"),a.load(ge,(function(e){o.m_strShaderVertex=e,m.load(Se,(function(e){o.m_strShaderFragment=e;var t=new Z.K({uniforms:o.m_uniforms,defines:o.m_defines,vertexShader:o.m_strShaderVertex,fragmentShader:o.m_strShaderFragment});s&&s(t)}))}))}}]),e}(),ye=i(124),Te=i.n(ye),De=function e(){Object(f.a)(this,e),this.m_point=new Z.R,this.m_next=null},be=function(){function e(t){Object(f.a)(this,e),this.create(t)}return Object(v.a)(e,[{key:"create",value:function(e){this.m_numPoints=0,this.m_numAllocatedPoints=e,this.m_points=new Array(e),this.m_voxels=new Array(4096);for(var t=0;t<e;t++)this.m_points[t]=new De,this.m_points[t].m_point.set(0,0,0),this.m_points[t].m_next=null}},{key:"getNumPoints",value:function(){return this.m_numPoints}},{key:"findPointSlow",value:function(e,t,i){for(var n=0;n<this.m_numPoints;n++){var r=e-this.m_points[n].m_point.x,s=t-this.m_points[n].m_point.y,o=i-this.m_points[n].m_point.z;if(r*r+s*s+o*o<1e-8)return n}return-1}},{key:"addPoint",value:function(e,t,i){var n=this.findPointSlow(e,t,i);if(n>=0)return n;if(this.m_numPoints>=this.m_numAllocatedPoints)return-1;var r=this.m_numPoints;return this.m_points[r]=new De,this.m_points[r].m_point.set(e,t,i),this.m_points[r].m_next=null,this.m_numPoints++,r}}]),e}(),Re=function e(t,i,n){Object(f.a)(this,e);this.m_indices=new Int32Array(3),this.m_indices[0]=t,this.m_indices[1]=i,this.m_indices[2]=n},we=function(){function e(t){Object(f.a)(this,e),this.create(t)}return Object(v.a)(e,[{key:"create",value:function(e){this.m_numTriangles=0,this.m_numAllocatedTriangles=e,this.m_triangles=new Array(e);for(var t=0;t<e;t++)this.m_triangles[t]=new Re(-1,-1,-1)}},{key:"getNumTriangles",value:function(){return this.m_numTriangles}},{key:"addTriangle",value:function(e,t,i){return this.m_numTriangles>=this.m_numAllocatedTriangles?-1:(this.m_triangles[this.m_numTriangles].m_indices[0]=e,this.m_triangles[this.m_numTriangles].m_indices[1]=t,this.m_triangles[this.m_numTriangles].m_indices[2]=i,this.m_numTriangles++,1)}}]),e}(),Me=function e(){Object(f.a)(this,e),this.va=new Z.R,this.vb=new Z.R,this.vc=new Z.R},Ee=function(){function e(){Object(f.a)(this,e),this.m_numAllocated=0,this.m_numStacked=0,this.m_stack=null}return Object(v.a)(e,[{key:"create",value:function(e){for(var t=20,i=0;i<e;i++)t*=4;this.m_numAllocated=t,this.m_stack=new Array(this.m_numAllocated);for(var n=0;n<this.m_numAllocated;n++)this.m_stack[n]=new Me;this.m_numStacked=0}},{key:"getStackDepth",value:function(){return this.m_numStacked}},{key:"isEmpty",value:function(){return 0===this.m_numStacked}},{key:"push",value:function(e,t,i){return this.m_numStacked>=this.m_numAllocated?-1:(this.m_stack[this.m_numStacked].va=e,this.m_stack[this.m_numStacked].vb=t,this.m_stack[this.m_numStacked].vc=i,this.m_numStacked++,1)}},{key:"pop",value:function(){return this.m_numStacked<=0?null:(this.m_numStacked--,this.m_stack[this.m_numStacked])}}]),e}(),Ae=function(){function e(){Object(f.a)(this,e),this.m_pointSet=null,this.m_triangleSet=null}return Object(v.a)(e,[{key:"create",value:function(e,t){var i=.5257311121,n=.8506508083,r=[-i,0,+n,+i,0,+n,-i,0,-n,+i,0,-n,0,+n,+i,0,+n,-i,0,-n,+i,0,-n,-i,+n,+i,0,-n,+i,0,+n,-i,0,-n,-i,0],s=[0,4,1,0,9,4,9,5,4,4,5,8,4,8,1,8,10,1,8,3,10,5,3,8,5,2,3,2,7,3,7,10,3,7,6,10,7,11,6,11,0,6,0,1,6,6,1,10,9,0,11,9,11,2,9,2,5,7,2,11];this.m_pointSet=new be(12);for(var o=0,a=0;a<12;a++,o+=3){var m=r[o+0],l=r[o+1],h=r[o+2];this.m_pointSet.addPoint(m,l,h)}this.m_triangleSet=new we(20),o=0;for(var u=0;u<20;u++,o+=3){var c=s[o+0],d=s[o+1],_=s[o+2];this.m_triangleSet.addTriangle(c,_,d)}this.subDivideMesh(t);for(var f=this.m_pointSet.getNumPoints(),v=0;v<f;v++)this.m_pointSet.m_points[v].m_point.x*=e.x,this.m_pointSet.m_points[v].m_point.y*=e.y,this.m_pointSet.m_points[v].m_point.z*=e.z;return 1}},{key:"getNumTriangles",value:function(){return this.m_triangleSet.m_numTriangles}},{key:"getNumVertices",value:function(){return this.m_pointSet.m_numPoints}},{key:"getVertex",value:function(e){return this.m_pointSet.m_points[e].m_point}},{key:"getTriangle",value:function(e){return this.m_triangleSet.m_triangles[e].m_indices}},{key:"saveGeoToPlyFile",value:function(e){var t="ply\nformat ascii 1.0\ncomment tetrahedron mesh\n",i=this.m_pointSet.m_numPoints,n=i.toString();t=(t=(t=(t=(t=t.concat("element vertex ")).concat(n)).concat("\n")).concat("property float x\nproperty float y\nproperty float z\n")).concat("element face ");var r=this.m_triangleSet.m_numTriangles,s=r.toString();t=(t=(t=(t=t.concat(s)).concat("\n")).concat("property list uchar int vertex_indices\n")).concat("end_header\n");for(var o=0;o<i;o++){var a=this.m_pointSet.m_points[o].m_point,m=a.x.toString(),l=a.y.toString(),h=a.z.toString();t=(t=(t=(t=(t=(t=t.concat(m)).concat(" ")).concat(l)).concat(" ")).concat(h)).concat(" 1.0\n")}for(var u=0;u<r;u++){var c=this.m_triangleSet.m_triangles[u].m_indices,d="3 ".concat(c[0]," ").concat(c[1]," ").concat(c[2],"\n");t=t.concat(d)}var _=(new TextEncoder).encode(t),f=new Blob([_],{type:"application/octet-stream"}),v=URL.createObjectURL(f),p=document.createElement("a");p.setAttribute("href",v),p.setAttribute("download",e);var g=document.createEvent("MouseEvents");g.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),p.dispatchEvent(g)}},{key:"saveGeoToObjFile",value:function(e){for(var t="# Tetrahedron test geo\n",i=this.m_pointSet.m_numPoints,n=i.toString(),r=this.m_triangleSet.m_numTriangles,s=r.toString(),o=0;o<i;o++){var a=this.m_pointSet.m_points[o].m_point,m=a.x.toString(),l=a.y.toString(),h=a.z.toString();t=(t=(t=(t=(t=(t=(t=t.concat("v  ")).concat(m)).concat(" ")).concat(l)).concat(" ")).concat(h)).concat("\n")}var u="# ".concat(n," vertices\n");t=(t=t.concat(u)).concat("g TetraObj\n");for(var c=0;c<r;c++){var d=this.m_triangleSet.m_triangles[c].m_indices,_=1+d[0],f=1+d[1],v=1+d[2],p="f ".concat(_," ").concat(f," ").concat(v,"\n");t=t.concat(p)}var g="# ".concat(s," triangles\n");t=t.concat(g);var S=(new TextEncoder).encode(t),x=new Blob([S],{type:"application/octet-stream"}),y=URL.createObjectURL(x),T=document.createElement("a");T.setAttribute("href",y),T.setAttribute("download",e);var D=document.createEvent("MouseEvents");D.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null),T.dispatchEvent(D)}},{key:"subDivideMesh",value:function(e){if(0===e)return 1;var t=new Ee;t.create(e);var i=new Ee;i.create(e);for(var n=this.m_triangleSet.getNumTriangles(),r=0;r<n;r++){var s=this.m_triangleSet.m_triangles[r].m_indices,o=s[0],a=s[1],m=s[2],l=this.m_pointSet.m_points[o].m_point,h=this.m_pointSet.m_points[a].m_point,u=this.m_pointSet.m_points[m].m_point,c=t.push(l,h,u);if(c<1)return c}for(var d=t,_=i,f=0;f<e;f++){for(var v=d.getStackDepth(),p=0;p<v;p++){var g=d.pop();if(null===g)return-1;var S=g.va,x=g.vb,y=g.vc,T=new Z.R,D=new Z.R,b=new Z.R;T.addVectors(S,x),T.normalize(),D.addVectors(x,y),D.normalize(),b.addVectors(y,S),b.normalize(),_.push(S,T,b),_.push(x,D,T),_.push(y,b,D),_.push(T,D,b)}var R=d;d=_,_=R}var w=d.getStackDepth(),M=Math.floor(3*w*.6);for(this.m_triangleSet.create(w),this.m_pointSet.create(M);!d.isEmpty();){var E=d.pop(),A=E.va,I=E.vb,O=E.vc,X=this.m_pointSet.addPoint(A.x,A.y,A.z),C=this.m_pointSet.addPoint(I.x,I.y,I.z),P=this.m_pointSet.addPoint(O.x,O.y,O.z),k=this.m_triangleSet.addTriangle(X,C,P);if(1!==k)return k}var F=this.m_pointSet.getNumPoints(),U=this.m_triangleSet.getNumTriangles();return F>M||U>w?-10:1}}]),e}(),Ie=function(){function e(t){Object(f.a)(this,e),this.rendererBlur=t.renderer,this.sceneBlur=t.scene,this.cameraOrtho=t.camera,this.xDim=t.xDim,this.yDim=t.yDim,this.zDim=t.zDim,this.texVolumeAO=null,this.vectorsTex=null}return Object(v.a)(e,[{key:"_setAOVectorTex",value:function(){var e=255,t=new Ae,i=new Z.R(.5,.5,.5);if(!(t.create(i,2)<1)){this.numAOVectors=t.getNumVertices(),this.vectors=new Uint8Array(4*this.numAOVectors);for(var n=0;n<this.numAOVectors;n++){var r=t.getVertex(n);this.vectors[4*n+0]=(r.x+.5)*e,this.vectors[4*n+1]=(r.y+.5)*e,this.vectors[4*n+2]=(r.z+.5)*e,this.vectors[4*n+3]=e}this.vectorsTex=new Z.j(this.vectors,this.numAOVectors,1,Z.H),this.vectorsTex.wrapS=Z.g,this.vectorsTex.wrapT=Z.g,this.vectorsTex.magFilter=Z.z,this.vectorsTex.minFilter=Z.z,this.vectorsTex.needsUpdate=!0}}},{key:"set",value:function(e,t){var i=this;null===this.vectorsTex&&this._setAOVectorTex(),this.xDimAO=this.xDim,this.yDimAO=this.yDim,this.zDimAO=this.zDim,this.bufferTextureAO=new Z.T(this.xDimAO,this.yDimAO,{minFilter:Z.u,magFilter:Z.u,format:Z.H,type:Z.P,depthBuffer:!1}),this.ambientVolumeTexCPU=new Uint8Array(this.xDimAO*this.yDimAO*this.zDimAO),0===this.isWebGL2?this.texVolumeAO=new Z.j(this.ambientVolumeTexCPU,this.xTex,this.yTex,Z.b):(this.texVolumeAO=new Z.k(this.ambientVolumeTexCPU,this.xDimAO,this.yDimAO,this.zDimAO),this.texVolumeAO.format=Z.I),this.texVolumeAO.wrapS=Z.g,this.texVolumeAO.wrapT=Z.g,this.texVolumeAO.wrapR=Z.g,this.texVolumeAO.magFilter=Z.u,this.texVolumeAO.minFilter=Z.u,this.texVolumeAO.needsUpdate=!0;var n=new Z.R(1/this.xDim,1/this.yDim,1/this.zDim);(new Te.a).create(e,n,this.vectorsTex,this.numAOVectors,t,(function(e){i.materialAO=e,e.uniforms.tileCountX.value=i.zTexDivSqrt,e.uniforms.volumeSizeZ.value=i.zDim,i.setAmbientTextureWebGL2(),i.texVolumeAO.needsUpdate=!0}))}},{key:"setAmbientTextureWebGL2",value:function(){var e=new Uint8Array(4*this.xDimAO*this.yDimAO),t=this.rendererBlur.getContext();console.log("AO WebGL2");for(var i=0;i<this.zDimAO;++i){this.materialAO.uniforms.curZ.value=i/(this.zDimAO-1),this.materialAO.uniforms.curZ.needsUpdate=!0,this.sceneBlur.overrideMaterial=this.materialAO,this.rendererBlur.render(this.sceneBlur,this.cameraOrtho,this.bufferTextureAO),this.sceneBlur.overrideMaterial=null,t.readPixels(0,0,this.xDimAO,this.yDimAO,t.RGBA,t.UNSIGNED_BYTE,e);for(var n=i*this.xDimAO*this.yDimAO,r=0;r<this.yDimAO;r++)for(var s=0;s<this.xDimAO;s++)this.ambientVolumeTexCPU[s+r*this.xDimAO+n]=e[4*(s+r*this.xDimAO)]}console.log("AO WebGL2 End")}},{key:"get",value:function(){return this.texVolumeAO}}]),e}(),Oe=function(){function e(){Object(f.a)(this,e),this.selectedROIs=null,this.transferFuncRgba=null,this.transferFuncTexture=null,this.texRoiColor=null,this.texRoiId=null,this.numRois=256,this.m_handleColors=[{r:0,g:0,b:0},{r:255,g:128,b:64},{r:255,g:0,b:0},{r:128,g:64,b:64},{r:128,g:0,b:0},{r:64,g:64,b:64},{r:128,g:128,b:128},{r:192,g:192,b:192},{r:255,g:255,b:255},{r:255,g:255,b:255}]}return Object(v.a)(e,[{key:"init",value:function(e,t){this.selectedROIs=new Uint8Array(4*this.numRois),this.numTfPixels=256,this.transferFuncRgba=new Uint8Array(4*this.numTfPixels),this.texRoiColor=null,e&&(this.texRoiId=this.createSelectedRoiMap(),this.texRoiColor=this.createRoiColorMap(t))}},{key:"createTransferFuncTexture",value:function(){for(var e=null,t=0,i=255,n=22.95,r=76.5,s=.43*i,o=135.15,a=0;a<this.numTfPixels;a++)a>n&&a<51&&(t=(a-n)/28.05),a>51&&a<r&&(t=(r-a)/25.5),a>s&&a<o&&(t=(a-s)/(o-s)),a>o&&(t=1),this.transferFuncRgba[4*a+0]=i,this.transferFuncRgba[4*a+1]=0,this.transferFuncRgba[4*a+1+1]=0,this.transferFuncRgba[4*a+1+1+1]=i*t/12,a>s&&(this.transferFuncRgba[4*a+0]=255,this.transferFuncRgba[4*a+1]=210,this.transferFuncRgba[4*a+1+1]=180,this.transferFuncRgba[4*a+1+1+1]=i*t/3);return(e=new Z.j(this.transferFuncRgba,this.numTfPixels,1,Z.H)).wrapS=Z.g,e.wrapT=Z.g,e.magFilter=Z.z,e.minFilter=Z.z,e.needsUpdate=!0,this.transferFuncTexture=e,e}},{key:"setTransferFuncColors",value:function(e){this.transferFuncCtrlPtsRgb=[];for(var t=0;t<e.length;t++)this.transferFuncCtrlPtsRgb.push(new Z.R(e[t].r,e[t].g,e[t].b))}},{key:"updateTransferFuncTexture",value:function(e,t){if(null===this.transferFuncRgba)return null;for(var i=0;i<e.length-1;i++)for(var n=Math.floor(e[i]),r=Math.floor(e[i+1]),s=n;s<r;s++){var o=(s-n)/(r-n),a=(1-o)*this.m_handleColors[i].r+o*this.m_handleColors[i+1].r,m=(1-o)*this.m_handleColors[i].g+o*this.m_handleColors[i+1].g,l=(1-o)*this.m_handleColors[i].b+o*this.m_handleColors[i+1].b;this.transferFuncRgba[4*s+0]=a,this.transferFuncRgba[4*s+1]=m,this.transferFuncRgba[4*s+2]=l;var h=t[i]>0?t[i]:0,u=t[i+1]>0?t[i+1]:0;this.transferFuncRgba[4*s+3]=255*(u*o+(1-o)*h)}return this.transferFuncTexture.needsUpdate=!0,this.transferFuncRgba}},{key:"createRoiColorMap",value:function(e){var t=null;if(null!==e)t=new Z.j(e,256,1,Z.H);else{for(var i=new Uint8Array(4*this.numRois),n=0;n<this.numRois;n++)i[4*n+0]=255,i[4*n+1]=0,i[4*n+2]=0,i[4*n+3]=255;t=new Z.j(i,this.numRois,1,Z.H)}return t.wrapS=Z.g,t.wrapT=Z.g,t.magFilter=Z.z,t.minFilter=Z.z,t.needsUpdate=!0,t}},{key:"createSelectedRoiMap",value:function(){for(var e=0;e<this.numRois;e++)this.selectedROIs[4*e]=e<50||e>240?0:255,this.selectedROIs[4*e+1]=0,this.selectedROIs[4*e+2]=0,this.selectedROIs[4*e+3]=0;var t=new Z.j(this.selectedROIs,256,1,Z.H);return t.wrapS=Z.g,t.wrapT=Z.g,t.magFilter=Z.z,t.minFilter=Z.z,t.needsUpdate=!0,t}},{key:"updateSelectedRoiMap",value:function(e){for(var t=0;t<this.numRois;t++)e[t]?this.selectedROIs[4*t]=255:this.selectedROIs[4*t]=0;this.texRoiId.needsUpdate=!0}},{key:"updateSelectedRoi",value:function(e,t){this.selectedROIs[4*e]=t?255:0,console.log("initMatBlure: ".concat(this.initMatBlure)),this.texRoiId.needsUpdate=!0}}]),e}(),Xe=function(){function e(){Object(f.a)(this,e),this.bufferBF=null,this.bufferFF=null,this.bufferRenderToTexture=null,this.isoThreshold=0,this.volTextureMask=null,this.geometry=null,this.lastSize=[],this.lastDepth=[],this.lastRotationVector=[],this.lastTarget=[],this.lastMode=[],this.lastBackDistance=[],this.resetflag=!1,this.bufferTextureCPU=null}return Object(v.a)(e,[{key:"createUpdatableVolumeMask",value:function(e,t){this.xDim=e.xDim,this.yDim=e.yDim,this.zDim=e.zDim,this.bufferBF=e.bufBF,this.bufferFF=e.bufFF,this.bufferRenderToTexture=e.bufTex,this.bufferMask=new Uint8Array(this.xDim*this.yDim*this.zDim),this.bufferTextureCPU=t;for(var i=0;i<this.zDim;i++)for(var n=0;n<this.yDim;n++)for(var r=0;r<this.xDim;r++)this.bufferMask[r+n*this.xDim+i*this.xDim*this.yDim]=255;return this.updatableTextureMask&&this.updatableTextureMask.dispose(),this.updatableTextureMask=new Z.k(this.bufferMask,this.xDim,this.yDim,this.zDim),this.updatableTextureMask.format=Z.I,this.updatableTextureMask.type=Z.P,this.updatableTextureMask.wrapS=Z.g,this.updatableTextureMask.wrapT=Z.g,this.updatableTextureMask.magFilter=Z.u,this.updatableTextureMask.minFilter=Z.u,this.updatableTextureMask.needsUpdate=!0,this.updatableTextureMask}},{key:"eraseStart",value:function(e,t,i,n,r){this.isoThreshold=n;var s=Math.round(e),o=Math.round(t);this.eraserMouseDown=!0;var a=4*(o*i+s),m=4*(Math.floor(o/3)*Math.floor(i/3)+Math.floor(s/3)),l=this.bufferRenderToTexture[m+3];if(2!==l){var h=this.bufferBF[a+0]-this.bufferFF[a+0],u=this.bufferBF[a+1]-this.bufferFF[a+1],c=this.bufferBF[a+2]-this.bufferFF[a+2],d=new Z.R(h,u,c),_=Math.sqrt(h*h+u*u+c*c);h=h/_*l+.5+this.bufferFF[a+0],u=u/_*l+.5+this.bufferFF[a+1],c=c/_*l+.5+this.bufferFF[a+2],this.erasePixels(h,u,c,d,r,l),this.updatableTextureMask.needsUpdate=!0}}},{key:"onMouseUp",value:function(){this.orbitControl.onMouseUp(),this.lockEraserBuffersUpdating=!1,this.eraserMouseDown=!1,this.renderState=this.RENDER_STATE.ONCE}},{key:"setEraserRadius",value:function(e){this.radius=e}},{key:"setEraserDepth",value:function(e){this.depth=e}},{key:"erasePixels",value:function(e,t,i,n,r,s){for(var o=Math.floor(e*this.xDim),a=Math.floor(t*this.yDim),m=Math.floor(i*this.zDim),l=new Z.R,h=new Z.R,u=1.4*1.4,c=0,d=0,_=0,f=0,v=0,p=-Math.min(2,m);p<=Math.min(2,this.zDim-1-m);p++)for(var g=-Math.min(2,a);g<=Math.min(2,this.yDim-1-a);g++)for(var S=-Math.min(2,o);S<=Math.min(2,this.xDim-1-o);S++){var x=m+p;v=o+S+(a+g)*this.xDim+x*this.xDim*this.yDim;var y=1-Math.exp(-(S*S+g*g+p*p)/(2*u));f+=y;var T=this.bufferTextureCPU[v];c+=T*y*(-S/u),d+=T*y*(-g/u),_+=T*y*(-p/u)}h.set(c/f,d/f,_/f),l.copy(h),l.normalize();var D=this.xDim/this.zDim,b=new Z.i(this.radius,this.radius,this.depth,180,this.depth),R=new Z.y(b,null),w=new Z.R(0,0,1);R.quaternion.setFromUnitVectors(w,l.clone().normalize().multiplyScalar(-1)),R.position.copy(new Z.R(o,a,m)),!0===r&&(this.prevDistance=s,this.resetflag=!1);if(!1===this.resetflag)if(Math.abs(this.prevDistance-s)<.05){this.prevDistance=s,this.point=new Z.R(0,0,0),this.queue=[],this.queue.push(this.point);-5;for(var M=!1;this.queue.length>0;){this.point=this.queue.pop();var E=this.point.clone();if(E.z*=D,E.applyAxisAngle(new Z.R(1,0,0),-R.rotation.x),E.applyAxisAngle(new Z.R(0,1,0),-R.rotation.y),E.applyAxisAngle(new Z.R(0,0,1),R.rotation.z),!(Math.sqrt(E.x*E.x+E.y*E.y)>this.radius||Math.abs(E.z)>this.depth||E.z<-5))for(var A=this.point.x-1;A<=this.point.x+1;A++)for(var I=this.point.y-1;I<=this.point.y+1;I++)for(var O=this.point.z-1;O<=this.point.z+1;O++){var X=o+Math.round(A),C=a+Math.round(I),P=m+Math.round(O);if(v=X+C*this.xDim+P*this.xDim*this.yDim,0!==this.bufferMask[v]){var k=255*this.isoThreshold-.01*255;this.bufferTextureCPU[v]>=k&&(M=!0,this.bufferMask[v]=0,this.queue.push(new Z.R(A,I,O)))}}}!0===M&&(this.lastSize.push(this.radius),this.lastDepth.push(this.depth),this.lastRotationVector.push(new Z.R(-R.rotation.x,-R.rotation.y,R.rotation.z)),this.lastTarget.push(new Z.R(o,a,m)),this.lastBackDistance.push(-Math.round(Math.abs(Math.tan(n.normalize().angleTo(h.normalize())))*this.radius))),this.updatableTextureMask.needsUpdate=!0}else this.resetflag=!1}},{key:"undoLastErasing",value:function(){if(0!==this.lastSize.length){var e=this.lastTarget.pop(),t=this.lastRotationVector.pop(),i=Math.round(this.lastSize.pop()),n=this.lastDepth.pop(),r=this.lastBackDistance.pop(),s=this.xDim/this.zDim;for(this.point=new Z.R(0,0,0),this.queue=[],this.queue.push(this.point);this.queue.length>0;){this.point=this.queue.pop();var o=this.point.clone();if(o.z*=s,o.applyAxisAngle(new Z.R(1,0,0),t.x),o.applyAxisAngle(new Z.R(0,1,0),t.y),o.applyAxisAngle(new Z.R(0,0,1),t.z),!(Math.sqrt(o.x*o.x+o.y*o.y)>i||o.z>n||o.z<r))for(var a=0,m=this.point.x-1;m<=this.point.x+1;m++)for(var l=this.point.y-1;l<=this.point.y+1;l++)for(var h=this.point.z-1;h<=this.point.z+1;h++){var u=e.x+Math.round(m),c=e.y+Math.round(l),d=e.z+Math.round(h);a=u+c*this.xDim+d*this.xDim*this.xDim,0===this.bufferMask[a]&&(this.bufferMask[a]=255,this.queue.push(new Z.R(m,l,h)))}}this.updatableTextureMask.needsUpdate=!0}}}]),e}(),Ce=function(){function e(){Object(f.a)(this,e),this.transferFunc=null,this.xDim=0,this.yDim=0,this.zDim=0,this.bufferTextureCPU=null,this.eraser=null}return Object(v.a)(e,[{key:"initRenderer",value:function(e,t){var i=this;this.sceneBlur=new Z.J;this.numRois=256,this.cameraOrtho=new Z.D(this.xDim/-2,this.xDim/2,this.yDim/2,this.yDim/-2,.1,100);var n=new K;this.context=n.createWebGLContext(),this.canvas3d=n.getCanvas(),this.rendererBlur=new Z.U({canvas:this.canvas3d,context:this.context}),this.ambientTexture=new Ie({xDim:this.xDim,yDim:this.yDim,zDim:this.zDim,renderer:this.rendererBlur,scene:this.sceneBlur,camera:this.cameraOrtho}),console.log("rendererBlur done");var r=new Z.G(1,1);this.rendererBlur.setSize(this.xDim,this.yDim),this.transferFunc=new Oe,this.transferFunc.init(e,t);var s=new Z.R(1/this.xDim,1/this.yDim,1/this.zDim);(new xe).create(this.origVolumeTex,this.RoiVolumeTex,s,this.transferFunc.texRoiColor,this.transferFunc.texRoiId,(function(t){var n=new Z.y(r,t);t.uniforms.volumeSizeZ.value=i.zDim,t.uniforms.xDim.value=i.xDim,t.uniforms.yDim.value=i.yDim,t.defines.useWebGL2=i.isWebGL2,i.material=t,i.sceneBlur.add(n),!1===e?i.switchToBlurRender():i.switchToRoiMapRender(),console.log("isRoiVolume: ".concat(e)),i.setVolumeTexture(.8)})),this.vectorsTex=null}},{key:"createTransferFuncTexture",value:function(){return null!==this.transferFunc?this.transferFunc.createTransferFuncTexture():null}},{key:"setTransferFuncColors",value:function(e){this.transferFunc.setTransferFuncColors(e)}},{key:"updateTransferFuncTexture",value:function(e,t){return this.transferFunc.updateTransferFuncTexture(e,t)}},{key:"switchToRoiMapRender",value:function(){this.material.defines.renderRoiMap=1,this.material.needsUpdate=!0}},{key:"switchToBlurRender",value:function(){this.material.defines.renderRoiMap=0,this.material.needsUpdate=!0}},{key:"setVolumeTexture",value:function(e){this.material&&"undefined"!==typeof this.material?(console.log("blur material NOT null"),this.setVolumeTextureWebGL2(e),this.updatableTexture.needsUpdate=!0):console.log("blur material null")}},{key:"updateVolumeTextureWithMask",value:function(){null===this.eraser.bufferMask&&console.log("volTextureMask null");for(var e=0;e<this.zDim;e++)for(var t=e*this.xDim*this.yDim,i=0;i<this.yDim;i++)for(var n=i*this.xDim,r=0;r<this.xDim;r++){var s=r+n+t,o=this.arrPixels[s],a=s;this.zDim>5&&(0===e||e===this.zDim-1||0===this.eraser.bufferMask[s])&&(o=0),this.bufferR[a]=o}this.origVolumeTex.needsUpdate=!0,this.setVolumeTexture(1)}},{key:"setVolumeTextureWebGL2",value:function(e){this.material.uniforms.blurSigma.value=e,this.material.uniforms.blurSigma.needsUpdate=!0;for(var t=new Uint8Array(4*this.xDim*this.yDim),i=this.rendererBlur.getContext(),n=1;n<this.zDim-1;++n){this.material.uniforms.curZ.value=n/this.zDim,this.material.uniforms.curZ.needsUpdate=!0,this.rendererBlur.render(this.sceneBlur,this.cameraOrtho,this.bufferTexture),i.readPixels(0,0,this.xDim,this.yDim,i.RGBA,i.UNSIGNED_BYTE,t);for(var r=n*this.xDim*this.yDim,s=0;s<this.yDim;s++)for(var o=0;o<this.xDim;o++)if(this.isRoiVolume){var a=4*(o+s*this.xDim),m=a+4*r;this.bufferTextureCPU[m]=t[a],this.bufferTextureCPU[m+1]=t[a+1],this.bufferTextureCPU[m+2]=t[a+2],this.bufferTextureCPU[m+3]=t[a+3]}else this.bufferTextureCPU[o+s*this.xDim+r]=t[4*(o+s*this.xDim)]}}},{key:"set3DTextureFrom1Byte",value:function(){this.bufferTextureCPU=new Uint8Array(this.xDim*this.yDim*this.zDim),this.bufferR=new Uint8Array(this.xDim*this.yDim*this.zDim);for(var e=0;e<this.zDim;e++)for(var t=e*this.xDim*this.yDim,i=0;i<this.yDim;i++)for(var n=i*this.xDim,r=0;r<this.xDim;r++){var s=r+n+t,o=this.arrPixels[s+0],a=s;this.zDim>5&&(0===e||e===this.zDim-1)&&(o=0),this.bufferR[a+0]=o,this.bufferTextureCPU[a+0]=o}console.log("setBufferRgbaFrom1Bytes for 3d texture")}},{key:"set3DTextureFrom4Bytes",value:function(){this.isRoiVolume&&(this.bufferRoi=new Uint8Array(this.xDim*this.yDim*this.zDim),this.bufferTextureCPU=new Uint8Array(4*this.xDim*this.yDim*this.zDim),console.log("ROI")),this.bufferR=new Uint8Array(this.xDim*this.yDim*this.zDim);for(var e=0;e<this.zDim;e++)for(var t=e*this.xDim*this.yDim,i=0;i<this.yDim;i++)for(var n=i*this.xDim,r=0;r<this.xDim;r++){var s=r,o=4*(s+n+t),a=this.arrPixels[o+0],m=this.arrPixels[o+3],l=s+n+t;r<2||r>this.xDim-4||i<2||i>this.yDim-4||e<2||e>this.zDim-4?this.bufferR[l+0]=0:this.bufferR[l+0]=a,this.bufferTextureCPU[4*l+0]=a,this.bufferTextureCPU[4*l+1]=a,this.bufferTextureCPU[4*l+2]=a,this.bufferTextureCPU[4*l+3]=a,this.bufferRoi[l+0]=m}console.log("setBufferRgbaFrom4Bytes for 3D texture")}},{key:"createRoiColorMap",value:function(e){return this.transferFunc.createRoiColorMap(e)}},{key:"createSelectedRoiMap",value:function(){return this.createSelectedRoiMap()}},{key:"updateSelectedRoiMap",value:function(e){this.transferFunc.updateSelectedRoiMap(e),this.setVolumeTexture(1)}},{key:"updateSelectedRoi",value:function(e,t){this.transferFunc.updateSelectedRoi(e,t),this.setVolumeTexture(1)}},{key:"createUpdatableVolumeTex",value:function(e,t,i){this.isWebGL2=1,this.arrPixels=e.m_dataArray;var n=e.m_xDim,r=e.m_yDim,s=e.m_zDim;this.xDim=n,this.yDim=r,this.zDim=s,this.isRoiVolume=t,this.RoiVolumeTex=null,t?(this.set3DTextureFrom4Bytes(),this.RoiVolumeTex=new Z.k(this.bufferRoi,this.xDim,this.yDim,this.zDim),this.RoiVolumeTex.format=Z.I,this.RoiVolumeTex.type=Z.P,this.RoiVolumeTex.wrapS=Z.g,this.RoiVolumeTex.wrapT=Z.g,this.RoiVolumeTex.magFilter=Z.z,this.RoiVolumeTex.minFilter=Z.z,this.RoiVolumeTex.needsUpdate=!0):this.set3DTextureFrom1Byte(),this.bufferTexture=new Z.T(this.xDim,this.yDim,{minFilter:Z.u,magFilter:Z.u,format:Z.H,type:Z.P,depthBuffer:!1}),this.origVolumeTex&&this.origVolumeTex.dispose(),this.origVolumeTex=new Z.k(this.bufferR,this.xDim,this.yDim,this.zDim),this.origVolumeTex.format=Z.I,this.origVolumeTex.type=Z.P,this.origVolumeTex.wrapR=Z.g,this.origVolumeTex.wrapS=Z.g,this.origVolumeTex.wrapT=Z.g,this.origVolumeTex.magFilter=Z.z,this.origVolumeTex.minFilter=Z.z,this.origVolumeTex.needsUpdate=!0;var o=Z.I;return t&&(o=Z.H),this.updatableTexture=new Z.k(this.bufferTextureCPU,this.xDim,this.yDim,this.zDim),this.updatableTexture.format=o,this.updatableTexture.type=Z.P,this.updatableTexture.wrapR=Z.g,this.updatableTexture.wrapS=Z.g,this.updatableTexture.wrapT=Z.g,this.updatableTexture.magFilter=Z.u,this.updatableTexture.minFilter=Z.u,this.zDim>1&&this.initRenderer(t,i),this.updatableTexture.needsUpdate=!0,this.eraser=new Xe,this.updatableTexture}},{key:"createUpdatableVolumeMask",value:function(e){return this.eraser.createUpdatableVolumeMask(e,this.bufferTextureCPU)}}]),e}(),Pe=i(125),ke=i.n(Pe),Fe=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this)).m_canvas=new ke.a,n.m_align=new Z.Q(0,0),n.m_side=Z.m,n.m_antialias=!0,n.m_text=e,n}return Object(v.a)(i,[{key:"getText",value:function(){return this.m_text}},{key:"setText",value:function(e){this.m_text!==e&&(this.m_text=e,this.updateText())}},{key:"getFont",value:function(){return this.m_font}},{key:"updateText",value:function(){console.log("Use virtual method for ".concat(this.m_text))}},{key:"cleanUp",value:function(){this.texture&&this.texture.dispose()}},{key:"applyAntiAlias",value:function(){!1===this.antialias&&(this.texture.magFilter=Z.z,this.texture.minFilter=Z.v)}}]),i}(Z.B),Ue=i(90),Le=i.n(Ue),Ne=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).m_mesh=null,n.m_material=null,n.m_renderedTextHeight=0,n.m_xMin=3,n.m_xMax=-3,n.m_yMin=3,n.m_yMax=-3,n}return Object(v.a)(i,[{key:"getRenderedTextHeight",value:function(){return this.m_renderedTextHeight}},{key:"updateText",value:function(e,t,n,r,s,o,a){var m=this;this.cleanUp(),null!==this.m_mesh&&(this.remove(this.m_mesh),this.m_mesh=null,this.m_material=null),this.m_canvas.drawText(this.m_text,a),this.m_renderedTextHeight=n;var l=n,h=l*(this.m_canvas.m_textWidth/this.m_canvas.m_textHeight);if(this.m_texture=new Z.N(this.m_canvas.m_canvas),this.m_texture.needsUpdate=!0,null===this.m_material){this.m_matTexturePlain=new Le.a,this.m_matTexturePlain.create(this.m_texture),this.m_material=this.m_matTexturePlain.m_material,this.m_material.blending=Z.h,this.m_material.blendEquation=Z.a,this.m_material.blendSrc=Z.M,this.m_material.blendDst=Z.C,this.m_geometry=new Z.r;var u=this.m_canvas.m_textWidth/this.m_canvas.m_canvas.width,c=this.m_canvas.m_textHeight/this.m_canvas.m_canvas.height;this.m_xMin=i.getXMin(e,r,h),this.m_xMax=i.getXMax(e,r,h),this.m_yMin=i.getYMin(t,s,l),this.m_yMax=i.getYMax(t,s,l);var d=.05,_=new Z.R(this.m_xMin,this.m_yMin,d),f=new Z.R(this.m_xMax,this.m_yMin,d),v=new Z.R(this.m_xMin,this.m_yMax,d),p=new Z.R(this.m_xMax,this.m_yMax,d);this.m_geometry.vertices.push(_),this.m_geometry.vertices.push(f),this.m_geometry.vertices.push(v),this.m_geometry.vertices.push(p),this.m_geometry.faceVertexUvs[0].push([new Z.Q(0,1-c),new Z.Q(u,1-c),new Z.Q(0,1)]),this.m_geometry.faceVertexUvs[0].push([new Z.Q(u,1),new Z.Q(0,1),new Z.Q(u,1-c)]);var g=new Z.R;Z.O.getNormal(_,f,v,g),this.m_geometry.faces.push(new Z.n(0,1,2,g)),this.m_geometry.faces.push(new Z.n(3,2,1,g)),this.m_mesh=new Z.y(this.m_geometry,this.m_material),this.add(this.m_mesh);var S=document.createElement("canvas"),x=S.getContext("2d");S.width=32,S.height=32,x.fillStyle=o,x.fillRect(0,0,S.width,S.height);var y=new Z.N(S);y.needsUpdate=!0,this.m_matTextureBox=new Le.a,this.m_matTextureBox.create(y,(function(e){m.m_boxMaterial=e;var t=.06;m.m_boxGeometry=new Z.r;var i,n=new Z.R(m.m_xMin,m.m_yMin,t),r=new Z.R(m.m_xMax,m.m_yMin,t),s=new Z.R(m.m_xMin,m.m_yMax,t),o=new Z.R(m.m_xMax,m.m_yMax,t);m.m_boxGeometry.vertices.push(n),m.m_boxGeometry.vertices.push(r),m.m_boxGeometry.vertices.push(s),m.m_boxGeometry.vertices.push(o),Z.O.getNormal(n,r,s,i),m.m_boxGeometry.faces.push(new Z.n(0,1,2,i)),m.m_boxGeometry.faces.push(new Z.n(3,2,1,i)),m.m_boxMesh=new Z.y(m.m_boxGeometry,m.m_boxMaterial),m.add(m.m_boxMesh)}))}else this.m_material.map=this.m_texture}}],[{key:"getXMin",value:function(e,t,n){return t===i.ALIGN_LEFT?e:t===i.ALIGN_RIGHT?e-n:t===i.ALIGN_CENTER?e-.5*n:0}},{key:"getXMax",value:function(e,t,n){return t===i.ALIGN_LEFT?e+n:t===i.ALIGN_RIGHT?e:t===i.ALIGN_CENTER?e+.5*n:0}},{key:"getYMin",value:function(e,t,n){return t===i.ALIGN_TOP?e-n:t===i.ALIGN_BOTTOM?e:t===i.ALIGN_CENTER?e-.5*n:0}},{key:"getYMax",value:function(e,t,n){return t===i.ALIGN_TOP?e:t===i.ALIGN_BOTTOM?e+n:t===i.ALIGN_CENTER?e+.5*n:0}}]),i}(Fe);Ne.ALIGN_LEFT=0,Ne.ALIGN_RIGHT=1,Ne.ALIGN_TOP=2,Ne.ALIGN_BOTTOM=3,Ne.ALIGN_CENTER=4;var ze=i(126),Ve=i.n(ze),Be=.11,je=function(){function e(t,i,n,r,s,o,a){Object(f.a)(this,e),this.createWithMaterial(t,i,n,r,s,o,a),this.m_xS=n,this.m_yS=r,this.m_xE=s,this.m_yE=o}return Object(v.a)(e,[{key:"createWithMaterial",value:function(e,t,i,n,r,s,o){this.m_scene=e,this.m_lineWidth=t;var a=new Z.Q(r-i,s-n),m=new Z.Q(+a.y,-a.x);m.normalize(),m.multiplyScalar(t);var l=new Z.R(i-m.x,n-m.y,Be),h=new Z.R(i+m.x,n+m.y,Be),u=new Z.R(r-m.x,s-m.y,Be),c=new Z.R(r+m.x,s+m.y,Be);this.m_geo=new Z.r,this.m_geo.vertices.push(l),this.m_geo.vertices.push(h),this.m_geo.vertices.push(u),this.m_geo.vertices.push(c);var d=new Z.R(0,0,1);this.m_geo.faces.push(new Z.n(0,1,3,d)),this.m_geo.faces.push(new Z.n(3,2,0,d)),this.m_mesh=new Z.y(this.m_geo,o),this.m_scene.add(this.m_mesh),console.log("Line added to scene: ".concat(i,",").concat(n," -> ").concat(r,",").concat(s," "))}},{key:"getRenderObject",value:function(){return this.m_mesh}},{key:"getxS",value:function(){return this.m_xS}},{key:"getyS",value:function(){return this.m_yS}},{key:"getxE",value:function(){return this.m_xE}},{key:"getyE",value:function(){return this.m_yE}}]),e}(),Ge=function(){function e(t,i){Object(f.a)(this,e),this.m_scene=t,this.m_lineWidth=i,this.m_runningState=!1,this.m_xPixelSize=-1,this.m_yPixelSize=-1;var n=new Ve.a;this.m_linesMaterial=n.create(),this.m_distances=[],this.m_vertexes=[],this.m_xStart=-1,this.m_yStart=-1,this.m_textWidthScr=.03,this.m_textColor="rgba(255, 255, 255, 255)",this.m_textBgColor="rgb(65, 65, 65)",this.m_zoom=1}return Object(v.a)(e,[{key:"clearLines",value:function(){for(var e=this.m_distances.length,t=0;t<e;++t){var i=this.m_distances.pop();this.m_scene.remove(i.line.getRenderObject()),this.m_scene.remove(i.text)}this.m_runningState=!1,this.m_vertexes=[]}},{key:"updateLines",value:function(e,t,i){for(var n=this.m_distances.length,r=0;r<n;++r){this.m_scene.remove(this.m_distances[r].line.getRenderObject()),this.m_scene.remove(this.m_distances[r].text);var s=(this.m_vertexes[2*r].xZ-t)/e-(1-1/e),o=(this.m_vertexes[2*r].yZ-i)/e+(1-1/e);if(null==this.m_vertexes[2*r+1])break;var a=(this.m_vertexes[2*r+1].xZ-t)/e-(1-1/e),m=(this.m_vertexes[2*r+1].yZ-i)/e+(1-1/e),l=new je(this.m_scene,this.m_lineWidth,s,o,a,m,this.m_linesMaterial);this.m_distances[r].line=l,this.m_distances[r].text.updateText(.5*(s+a)-0,.5*(o+m)-0,this.m_textWidthScr,Ne.ALIGN_CENTER,Ne.ALIGN_CENTER,this.m_textBgColor,this.m_textColor),this.m_scene.add(this.m_distances[r].text)}}},{key:"updateZoom",value:function(e){this.m_zoom=e}},{key:"setPixelSize",value:function(e,t){this.m_xPixelSize=e,this.m_yPixelSize=t}},{key:"isRunning",value:function(){return this.m_runningState}},{key:"onMouseDown",value:function(e,t,i,n,r){this.m_runningState=!this.m_runningState;var s=(e+(1-1/i))*i+n,o=(t-(1-1/i))*i+r;if(this.m_runningState){this.m_xStart=e,this.m_yStart=t;var a=new je(this.m_scene,this.m_lineWidth,e,t,e,t,this.m_linesMaterial),m=new Ne("0 mm");m.updateText(e,t,this.m_textWidthScr,Ne.ALIGN_CENTER,Ne.ALIGN_CENTER,this.m_textBgColor,this.m_textColor),this.m_scene.add(m),this.m_distances.push({line:a,text:m}),this.m_vertexes.push({xZ:s,yZ:o})}else this.m_vertexes.push({xZ:s,yZ:o}),this.m_xStart=-1,this.m_yStart=-1}},{key:"test",value:function(){new je(this.m_scene,this.m_lineWidth,-1,1,-.5,.5,this.m_linesMaterial)}},{key:"onMouseMove",value:function(e,t,i){if(this.m_runningState){var n=this.m_distances.pop();this.m_scene.remove(n.line.getRenderObject());var r=new je(this.m_scene,this.m_lineWidth,this.m_xStart,this.m_yStart,e,t,this.m_linesMaterial);this.m_scene.remove(n.text);var s="".concat((i*Math.sqrt((e-this.m_xStart)*(e-this.m_xStart)*this.m_xPixelSize*this.m_xPixelSize+(t-this.m_yStart)*(t-this.m_yStart)*this.m_yPixelSize*this.m_yPixelSize)).toFixed(2)," mm"),o=new Ne(s);o.updateText(.5*(e+this.m_xStart)-0,.5*(t+this.m_yStart)-0,this.m_textWidthScr,Ne.ALIGN_CENTER,Ne.ALIGN_CENTER,this.m_textBgColor,this.m_textColor),this.m_scene.add(o),this.m_distances.push({line:r,text:o})}}},{key:"updateVertexes",value:function(e,t,i){this.m_vertexes=[];for(var n=0;n<this.m_distances.length;++n){var r=(this.m_distances[n].line.getxS()+(1-1/e))*e+t,s=(this.m_distances[n].line.getyS()-(1-1/e))*e+i;this.m_vertexes.push({xZ:r,yZ:s}),r=(this.m_distances[n].line.getxE()+(1-1/e))*e+t,s=(this.m_distances[n].line.getyE()-(1-1/e))*e+i,this.m_vertexes.push({xZ:r,yZ:s})}}}]),e}(),We="distance",He="angle",Ye="area",qe="rect",Ze="text",Ke="grad",Qe="cobr",Je="bifi",$e="zoom",et="delete",tt="edit",it=function(){function e(t,i,n){Object(f.a)(this,e),this.m_width=i,this.m_height=n,this.m_material=null,this.m_mesh=null,console.log("Graphics2d create size = ".concat(i," * ").concat(n)),this.m_scene=t,this.m_materialsTex2d=null,this.m_material=null,this.m_zoom=1,this.m_savePosX=0,this.m_savePosY=0,this.m_posX=0,this.m_posY=0,this.m_move=!1,this.m_wProjScreen=i,this.m_hProjScreen=n,this.m_showTileTexture=!1;var r=1/i,s=1/n;this.m_lineWidth=2*(r>s?r:s),this.m_lineWidth=.002,this.m_textTime=-1e3,this.m_text=null,this.m_toolType=We,this.m_distanceTool=new Ge(this.m_scene,this.m_lineWidth)}return Object(v.a)(e,[{key:"set2dToolType",value:function(e){this.m_toolType=e}},{key:"onFileLoaded",value:function(){this.m_distanceTool.clearLines(),this.m_angleTool.clearLines(),this.m_areaTool.clearLines(),this.m_rectTool.clearLines(),this.m_textTool.clear(),this.m_deleteTool.clearLines(),this.m_editTool.clearLines()}},{key:"clear2DTools",value:function(){this.m_distanceTool.clearLines(),this.m_angleTool.clearLines(),this.m_areaTool.clearLines(),this.m_rectTool.clearLines(),this.m_textTool.clear(),this.m_deleteTool.clearLines(),this.m_editTool.clearLines()}},{key:"default2DTools",value:function(){this.m_zoom=1,this.m_posX=0,this.m_posY=0,this.m_savePosX=0,this.m_savePosY=0,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY,this.m_materialsTex2d.m_uniforms.zoom.value=this.m_zoom,this.updateLines()}},{key:"fov2Tan",value:function(e){return Math.tan(Z.w.degToRad(.5*e))}},{key:"tan2Fov",value:function(e){return 2*Z.w.radToDeg(Math.atan(e))}},{key:"onKeyDown",value:function(e,t){}},{key:"onMouseDown",value:function(e,t){if(null!==this.m_volumeData&&null!==this.m_volumeHeader&&!(e>this.m_wProjScreen||t>this.m_hProjScreen)&&!this.m_levelSetMode){var i=2*e-1,n=2*t-1;switch(this.m_toolType){case We:this.m_distanceTool.onMouseDown(i,n,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case He:this.m_angleTool.onMouseDown(i,n,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case Ze:this.m_textTool.onMouseDown(i,n,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case Ye:this.m_areaTool.onMouseDown(i,n,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case qe:this.m_rectTool.onMouseDown(i,n,this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;case Ke:case Qe:case Je:break;case $e:this.m_move=!0,this.m_moveTool.onMouseDown(i,n);break;case et:this.m_deleteTool.onMouseDown(i,n,this.m_distanceTool.m_distances,this.m_angleTool.m_angles,this.m_rectTool.m_areas,this.m_areaTool.m_distances,this.m_textTool.m_textArr,this.m_distanceTool.m_vertexes,this.m_angleTool.m_vertexes,this.m_rectTool.m_vertexes,this.m_areaTool.m_vertexes2,this.m_areaTool.m_last_lengths,this.m_areaTool.m_vertexes,this.m_areaTool,this.m_textTool.m_vertexes),console.log("".concat(this.m_areaTool.last_length));break;case tt:this.m_editTool.onMouseDown();break;default:console.log("Unexpected 2d tool")}}}},{key:"onMouseUp",value:function(e,t){if(null!==this.m_volumeData&&null!==this.m_volumeHeader&&!(e>this.m_wProjScreen||t>this.m_hProjScreen)){var i=2*e-1,n=2*t-1;if(this.m_levelSetMode)return null!==this.m_levelSetCircle&&this.clearLevelSetCenter(),void this.drawLevelSetCenter(i,n);switch(this.m_toolType){case We:case He:case Ye:case qe:case Ze:case Qe:case Je:break;case $e:this.m_move=!1,this.m_moveTool.onMouseUp(),this.m_savePosX=this.m_posX,this.m_savePosY=this.m_posY;break;case et:break;case tt:this.m_editTool.onMouseUp();break;default:console.log("Unexpected 2d tool")}}}},{key:"onMouseMove",value:function(e,t){if(null!==this.m_volumeData&&null!==this.m_volumeHeader&&!(e>this.m_wProjScreen||t>this.m_hProjScreen)){var i=2*e-1,n=2*t-1;switch(this.m_toolType){case We:this.m_distanceTool.onMouseMove(i,n,this.m_zoom);break;case He:this.m_angleTool.onMouseMove(i,n);break;case Ye:this.m_areaTool.onMouseMove(i,n);break;case qe:this.m_rectTool.onMouseMove(i,n,this.m_zoom);break;case Ze:case Ke:case Qe:case Je:break;case $e:this.m_move&&this.updateMove(i,n);break;case et:this.m_deleteTool.onMouseMove(i,n,this.m_zoom,this.m_distanceTool.m_distances,this.m_angleTool.m_angles,this.m_rectTool.m_areas,this.m_areaTool.m_distances,this.m_textTool.m_textArr);break;case tt:this.m_editTool.onMouseMove(i,n,this.m_zoom,this.m_distanceTool.m_distances,this.m_angleTool.m_angles,this.m_rectTool.m_areas,this.m_areaTool.m_distances,this.m_areaTool,this.m_textTool,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_distanceTool.updateVertexes(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_angleTool.updateVertexes(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen);break;default:console.log("Unexpected 2d tool")}}}},{key:"onMouseWheel",value:function(e){switch(this.m_toolType){case We:case He:case Ye:case qe:case Ze:case Qe:case Je:break;case $e:this.m_zoomTool.onMouseWheel(e),this.updateZoom(),this.createMarkLinesAndText();break;case et:case tt:break;default:console.log("Unexpected 2d tool")}}},{key:"updateLines",value:function(){this.m_distanceTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_angleTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_rectTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_textTool.updateAll(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_areaTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_deleteTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen),this.m_editTool.updateLines(this.m_zoom,this.m_posX*this.m_wProjScreen,this.m_posY*this.m_hProjScreen)}},{key:"updateMove",value:function(e,t){var i=2-2*this.m_zoom,n=this.m_moveTool.onMouseMove(e,t);this.m_savePosX+n.x<=Math.abs(i)&&this.m_savePosX+n.x>0?(this.m_posX=this.m_savePosX+n.x,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX):this.m_savePosX+n.x>Math.abs(i)?(this.m_posX=Math.abs(i),this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX):(this.m_posX=0,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX),this.m_savePosY+n.y>=-1*Math.abs(i)&&this.m_savePosY+n.y<0?(this.m_posY=this.m_savePosY+n.y,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY):this.m_savePosY+n.y<-1*Math.abs(i)?(this.m_posY=-1*Math.abs(i),this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY):(this.m_posY=0,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY),this.updateLines()}},{key:"updateZoom",value:function(){this.m_materialsTex2d.m_uniforms.zoom.value=this.m_zoomTool.m_zoom,this.m_zoom=this.m_zoomTool.m_zoom;var e=2-2*this.m_zoom;this.m_posX>e&&(this.m_posX=e,this.m_materialsTex2d.m_uniforms.posX.value=this.m_posX),this.m_posY<-1*e&&this.m_posY<0&&(this.m_posY=-1*e,this.m_materialsTex2d.m_uniforms.posY.value=this.m_posY),this.updateLines()}},{key:"updateText",value:function(){}}],[{key:"shortenString",value:function(e){var t=e,i=e.length;if(i>20){var n=e.substring(0,6),r=e.substring(i-5,i);t="".concat(n,"...").concat(r)}return t}}]),e}(),nt=.1,rt=.902,st=.773,ot=.5,at=.4,mt=.3,lt=.0025,ht=.0033,ut=.0025,ct=.0029,dt=175,_t=function(){function e(t){var i=this;Object(f.a)(this,e),this.curFileDataType=t.curFileDataType,this.sceneReadyCounter=0,this.renderCounter=0,this.scene=new Z.J,this.sceneClipPlane=new Z.J,this.scene23D=new Z.J,this.graphics23d=null,this.sceneSphere=new Z.J,this.meshSphere=null,this.newScene=new Z.J,this.renderScene=0,this.planeGeometry=null,this.props=t,this.mesh=null,this.renderer=null,this.texTF=null,this.volTexture=null,this.origVolumeTex=null,this.texRoiId=null,this.texRoiColor=null,this.RoiVolumeTex=null,this.volTextureMask=null,this.texVolumeAO=null,this.bfTexture=null,this.ffTexture=null,this.renderToTexture=null,this.geometry=null,this.geometrySphere=null,this.geometryWireFrameSphere=null,this.matBF=null,this.matFF=null,this.matScreenTex=null,this.matWireFrame=null,this.matRenderToTexture=null,this.matVolumeRender=null,this.volumeUpdater=null,this.checkFrameBufferMode=0,this.eraserStarted=!1,this.lockEraserBuffersUpdating=!1,this.planeCenterPt=new Z.R(-.5,-.5,.7);var n=new K;this.context=n.createWebGLContext(),this.isWebGL2=n.useWebGL2(),this.canvas3d=n.getCanvas(),this.renderer=new Z.U({antialias:!1,canvas:this.canvas3d,preserveDrawingBuffer:!0,context:this.context}),this.renderer.autoClearStencil=!1,this.renderer.autoClearColor=!1,this.renderer||console.log("cant create 3d renderer"),this.windowWidth=Math.floor(t.width),this.windowHeight=Math.floor(t.height),console.log("Window: ".concat(this.windowWidth," x ").concat(this.windowHeight));var r=this.windowWidth/this.windowHeight;this.camera=new Z.E(60,r,.01,3),this.camera.position.z=10,this.renderer.setSize(this.windowWidth,this.windowHeight),this.renderer.setClearColor(0),t.mount.appendChild(this.renderer.domElement),this.orbitControl=new Q(this.renderer.domElement,this.camera,this.scene,this.mesh,(function(){i.updateCutPlanes(),i.updateLightDir()})),this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.RENDER_STATE={ENABLED:0,ONCE:1,DISABLED:2},this.renderState=this.RENDER_STATE.ENABLED,this.fps=0,this.isoThreshold=0,this.isEraseMode=!1,this.eraserRadius=10,this.eraserDepth=20,this.eraserSrart=!1,this.lockEraserBuffersUpdating=!1,this.eraserMouseDown=!1,this.m_eraser=null,this.isSculptingMode=!1,this.sculptingCapturedVertex=null,this.sculptingSphereCenter=new Z.R(0,0,0),this.sculptingSphereSize=1,this.vBoxVirt={x:1,y:1,z:1}}return Object(v.a)(e,[{key:"setFileDataType",value:function(e){this.curFileDataType=e}},{key:"removeSphereFromSphereScene",value:function(){null!==this.meshSphere&&this.sceneSphere.remove(this.meshSphere),this.meshSphere=null,this.geometrySphere=null}},{key:"addSphereToSphereScene",value:function(){var e=new Ae,t=new Z.R(.5,.5,.5),i=e.create(t,2);if(i<1)return i;for(var n=e.getNumVertices(),r=e.getNumTriangles(),s=[],o=[],a=[],m=0;m<n;m++){var l=e.getVertex(m),h=new Z.R(l.x,l.y,l.z);s.push(l.x,l.y,l.z),h.normalize(),a.push(h.x,h.y,h.z)}for(var u=0,c=0;u<r;u++,c+=3){var d=e.getTriangle(u);o.push(d[0],d[1],d[2])}this.geometrySphere=new Z.f;var _=new Float32Array(s),f=new Float32Array(a),v=new Uint8Array(o);return this.geometrySphere.addAttribute("position",new Z.e(_,3)),this.geometrySphere.addAttribute("normal",new Z.e(f,3)),this.geometrySphere.setIndex(new Z.e(v,1)),this.computeGeometrySphereUVs(),this.meshSphere=new Z.y(this.geometrySphere),this.sceneSphere.add(this.meshSphere),this.meshSphere}},{key:"updateMeshSphere",value:function(){}},{key:"isVolumeLoaded",value:function(){return null!==this.matVolumeRender}},{key:"fov2Tan",value:function(e){return Math.tan(Z.w.degToRad(.5*e))}},{key:"tan2Fov",value:function(e){return 2*Z.w.radToDeg(Math.atan(e))}},{key:"screenshot",value:function(e,t){if(null===this.renderer)return null;var i=null;if("undefined"===typeof e)i=this.renderer.domElement.toDataURL("image/png");else{var n=this.camera.aspect,r=this.camera.fov,s=this.fov2Tan(this.camera.fov)*Math.min(this.windowWidth,this.windowHeight)/this.windowHeight,o=e/t;this.camera.aspect=o,this.camera.fov=this.tan2Fov(s/Math.min(o,1)),this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.render(),i=this.renderer.domElement.toDataURL("image/png"),this.camera.aspect=n,this.camera.fov=r,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.windowWidth,this.windowHeight),this.render()}return i}},{key:"setMaskFlag",value:function(e){this.matVolumeRender.defines.MaskFlag=e,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.MaskFlag=e,this.matRenderToTexture.needsUpdate=!0}},{key:"switchToTool23D",value:function(e){this.Tool23D=e,this.Tool23D?this.graphics23d=new it(this.scene23D,this.windowWidth,this.windowHeight):this.graphics23d=null}},{key:"switchToVolumeRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.isRoiVolume>0?(this.matVolumeRender.defines.isoRenderFlag=4,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=4,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE):(this.matVolumeRender.defines.isoRenderFlag=0,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=0,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE))}},{key:"switchToFullVolumeRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.isRoiVolume>0?(this.matVolumeRender.defines.isoRenderFlag=4,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=4,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE):(this.matVolumeRender.defines.isoRenderFlag=3,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=3,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE))}},{key:"switchToIsosurfRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.isRoiVolume>0?(this.matVolumeRender.defines.isoRenderFlag=5,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=5,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE,this.volumeUpdater.switchToRoiMapRender()):(this.matVolumeRender.defines.isoRenderFlag=1,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=1,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE))}},{key:"switchToFLATRender",value:function(){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matVolumeRender.defines.isoRenderFlag=2,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.defines.isoRenderFlag=2,this.matRenderToTexture.needsUpdate=!0,this.renderState=this.RENDER_STATE.ONCE)}},{key:"setIsoThresholdValue",value:function(e){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.isoThreshold.value=e,this.matRenderToTexture.uniforms.isoThreshold.needsUpdate=!0,this.matVolumeRender.uniforms.isoThreshold.value=e,this.matVolumeRender.uniforms.isoThreshold.needsUpdate=!0,this.isoThreshold=e,this.renderState=this.RENDER_STATE.ONCE)}},{key:"setOpacityBarrier",value:function(e){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matVolumeRender.uniforms.opacityBarrier.value=dt*e,this.matVolumeRender.uniforms.opacityBarrier.needsUpdate=!0,this.matRenderToTexture.uniforms.opacityBarrier.value=dt*e,this.matRenderToTexture.uniforms.opacityBarrier.needsUpdate=!0)}},{key:"updateBrightness",value:function(e){null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.brightness3D.value=e,this.matRenderToTexture.uniforms.brightness3D.needsUpdate=!0),null!==this.matVolumeRender&&(this.matVolumeRender.uniforms.brightness3D.value=e,this.matVolumeRender.uniforms.brightness3D.needsUpdate=!0)}},{key:"updateContrast",value:function(e){null!==this.matVolumeRender&&null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.contrast3D.value=e,this.matVolumeRender.uniforms.contrast3D.value=e,this.matRenderToTexture.uniforms.contrast3D.needsUpdate=!0,this.matVolumeRender.uniforms.contrast3D.needsUpdate=!0)}},{key:"setAmbientTextureMode",value:function(e){this.texVolumeAO&&this.texVolumeAO.dispose(),this.volumeUpdater.ambientTexture.set(this.volTexture,e),this.texVolumeAO=this.volumeUpdater.ambientTexture.get(),this.matRenderToTexture.defines.useAmbientTex=1,this.matVolumeRender.defines.useAmbientTex=1,this.matRenderToTexture.needsUpdate=!0,this.matVolumeRender.needsUpdate=!0,this.matRenderToTexture.uniforms.texVolumeAO.value=this.texVolumeAO,this.matRenderToTexture.uniforms.texVolumeAO.needsUpdate=!0,this.matVolumeRender.uniforms.texVolumeAO.value=this.texVolumeAO,this.matVolumeRender.uniforms.texVolumeAO.needsUpdate=!0}},{key:"offAmbientTextureMode",value:function(){this.texVolumeAO&&this.texVolumeAO.dispose(),this.matRenderToTexture.defines.useAmbientTex=0,this.matVolumeRender.defines.useAmbientTex=0,this.matRenderToTexture.needsUpdate=!0,this.matVolumeRender.needsUpdate=!0}},{key:"updateZCutPlane",value:function(e){this.planeCenterPt.z=1.4*e,this.updateCutPlanes()}},{key:"setTransferFuncVec3",value:function(e,t){null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.t_function1min.value=0===t?new Z.S(nt,0,0,e[0]):new Z.S(0,.8,0,e[0]),this.matRenderToTexture.uniforms.t_function1min.needsUpdate=!0,this.matRenderToTexture.uniforms.t_function1max.value=new Z.S(1,0,0,e[1]),this.matRenderToTexture.uniforms.t_function1max.needsUpdate=!0,this.matRenderToTexture.uniforms.t_function2min.value=new Z.S(1,rt,st,e[2]),this.matRenderToTexture.uniforms.t_function2min.needsUpdate=!0,this.matRenderToTexture.uniforms.t_function2max.value=new Z.S(ot,at,mt,e[2]),this.matRenderToTexture.uniforms.t_function2max.needsUpdate=!0,this.matRenderToTexture.uniforms.stepSize.value=new Z.S(lt,ht,ut,ct),this.matRenderToTexture.uniforms.stepSize.needsUpdate=!0,this.matVolumeRender.uniforms.t_function1min.value=0===t?new Z.S(nt,0,0,e[0]):new Z.S(0,.8,0,e[0]),this.matVolumeRender.uniforms.t_function1min.needsUpdate=!0,this.matVolumeRender.uniforms.t_function1max.value=new Z.S(1,0,0,e[1]),this.matVolumeRender.uniforms.t_function1max.needsUpdate=!0,this.matVolumeRender.uniforms.t_function2min.value=new Z.S(1,rt,st,e[2]),this.matVolumeRender.uniforms.t_function2min.needsUpdate=!0,this.matVolumeRender.uniforms.t_function2max.value=new Z.S(ot,at,mt,e[2]),this.matVolumeRender.uniforms.t_function2max.needsUpdate=!0,this.matVolumeRender.uniforms.stepSize.value=new Z.S(lt,ht,ut,ct),this.matVolumeRender.uniforms.stepSize.needsUpdate=!0)}},{key:"computeGeometryUVs",value:function(e,t){this.geometry.computeBoundingBox();var i=this.geometry.boundingBox.max,n=this.geometry.boundingBox.min,r=new Z.R(0-n.x,0-n.y,0-n.z),s=new Z.R(i.x-n.x,i.y-n.y,i.z-n.z);this.geo_offset1=new Z.R(0,0,0),this.geo_offset1=r,this.geo_offset2=new Z.R(0,0,0),this.geo_offset2.x=e.x+.5,this.geo_offset2.y=e.y-.5,this.geo_offset2.z=e.z-.5,this.geo_scale=new Z.R(0,0,0),this.geo_scale.x=(t.x-e.x)/s.x,this.geo_scale.y=(t.y-e.y)/s.y,this.geo_scale.z=(t.z-e.z)/s.z;for(var o=new Float32Array(3*this.geometry.getAttribute("position").count),a=0;a<this.geometry.getAttribute("position").count;a++){var m=this.geometry.getAttribute("position").getX(a),l=this.geometry.getAttribute("position").getY(a),h=this.geometry.getAttribute("position").getZ(a);o[3*a+0]=-m,o[3*a+1]=l,o[3*a+2]=h}this.geometry.addAttribute("uvw",new Z.e(o,3)),this.geometry.getAttribute("uvw").needsUpdate=!0}},{key:"computeGeometrySphereUVs",value:function(){for(var e=new Float32Array(3*this.geometrySphere.getAttribute("position").count),t=0;t<this.geometrySphere.getAttribute("position").count;t++){var i=this.geometrySphere.getAttribute("position").getX(t),n=this.geometrySphere.getAttribute("position").getY(t),r=this.geometrySphere.getAttribute("position").getZ(t);e[3*t+0]=-i/this.vBoxVirt.x,e[3*t+1]=+n/this.vBoxVirt.y,e[3*t+2]=+r/this.vBoxVirt.z}this.geometrySphere.addAttribute("uvw",new Z.e(e,3)),this.geometrySphere.getAttribute("uvw").needsUpdate=!0}},{key:"createClipPlaneGeometry",value:function(){var e=this;(new me).create(this.bfTexture,(function(t){e.planeGeometry=new Z.F(2,2);var i=new Z.y(e.planeGeometry,t);e.sceneClipPlane.add(i)}))}},{key:"updateClipPlaneGeometry",value:function(){var e=new Float32Array(3*this.planeGeometry.getAttribute("position").count),t=new Z.x;t.getInverse(this.mesh.matrix);var i=new Z.x;i.getInverse(this.camera.projectionMatrix);var n=new Z.x;n.copy(this.camera.matrixWorld);for(var r=0;r<this.planeGeometry.getAttribute("position").count;r++){var s=new Z.R;s.x=this.planeGeometry.getAttribute("position").getX(r),s.y=this.planeGeometry.getAttribute("position").getY(r),s.z=this.planeGeometry.getAttribute("position").getZ(r)+.001,s.applyMatrix4(i),s.applyMatrix4(n),s.applyMatrix4(t),e[3*r+0]=-s.x,e[3*r+1]=s.y,e[3*r+2]=s.z}this.planeGeometry.addAttribute("uvw",new Z.e(e,3)),this.planeGeometry.getAttribute("uvw").needsUpdate=!0}},{key:"getScreen2WorldTransform",value:function(){var e=new Z.x;e.getInverse(this.mesh.matrix);var t=new Z.x;t.getInverse(this.camera.projectionMatrix);var i=new Z.x;return i.copy(this.camera.matrixWorld),t.multiply(i),t.multiply(e),t}},{key:"initWithVolume",value:function(e,t,i,n,r,s){var o=this,a=t.x>t.y?t.x:t.y;a=t.z>a?t.z:a,this.vBoxVirt.x=t.x/a,this.vBoxVirt.y=t.y/a,this.vBoxVirt.z=t.z/a,this.isoThreshold=this.curFileDataType.thresholdIsosurf,this.volume=e,this.nonEmptyBoxMin=i,this.nonEmptyBoxMax=n,this.matWireFrame=null,this.removeSphereFromSphereScene();var m=new re;this.matWireFrame=m.create(this.bfTexture,this.ffTexture),this.addSphereToSphereScene(),this.renderScene=0,this.sceneReadyCounter=0,this.renderCounter=0;var l=null,h=null,u=null;if(this.sceneClipPlane&&(this.sceneClipPlane=new Z.J),this.scene){null!==this.mesh&&this.scene.remove(this.mesh),null!==this.geometry&&this.geometry.dispose(),this.mesh=null,this.geometry=new Z.f,this.geometry.fromGeometry(new Z.d(1,1,1)),this.computeGeometryUVs(i,n),this.geometry.scale(this.vBoxVirt.x,this.vBoxVirt.y,this.vBoxVirt.z),this.camera.position.set(0,0,1.5),this.camera.lookAt(new Z.R(0,0,0));var c=this.volume.m_xDim,d=this.volume.m_yDim,_=this.volume.m_zDim;if(console.log("3D tex size = ".concat(c," ").concat(d," ").concat(_)),this.volTexture&&this.volTexture.dispose(),this.eraserStarted=!1,this.isRoiVolume=r,this.roiPalette=null,!0===r){var f=new G;this.roiPalette=f.getPalette256();var v=this.roiPalette[1e3],p=this.roiPalette[1001],g=this.roiPalette[1002];console.log("RoiPalette: pal[250] = ".concat(g,", ").concat(p,", ").concat(v))}if(this.volumeUpdater=new Ce,this.volTexture=this.volumeUpdater.createUpdatableVolumeTex(this.volume,r,this.roiPalette),this.origVolumeTex=this.volumeUpdater.origVolumeTex,this.texTF=this.volumeUpdater.createTransferFuncTexture(),this.volTextureMask&&this.volTextureMask.dispose(),this.texVolumeAO&&this.texVolumeAO.dispose(),this.renderer.getContext().getExtension("EXT_color_buffer_float")){this.bfTexture&&this.bfTexture.dispose(),this.bfTexture=new Z.T(this.windowWidth,this.windowHeight,{minFilter:Z.u,magFilter:Z.u,format:Z.H,type:Z.p,depthBuffer:!0});this.bufferBFTextureCPU=new Float32Array(4*this.windowWidth*this.windowHeight),this.ffTexture&&this.ffTexture.dispose(),this.ffTexture=new Z.T(this.windowWidth,this.windowHeight,{minFilter:Z.u,magFilter:Z.u,format:Z.H,type:Z.p,depthBuffer:!0}),this.bufferFFTextureCPU=new Float32Array(4*this.windowWidth*this.windowHeight),this.renderfTexture&&this.renderToTexture.dispose();this.xSmallTexSize=Math.floor(this.windowWidth/3),this.ySmallTexSize=Math.floor(this.windowHeight/3),this.renderToTexture=new Z.T(this.xSmallTexSize,this.ySmallTexSize,{minFilter:Z.z,magFilter:Z.z,format:Z.H,type:Z.p,depthBuffer:!0}),this.bufferRenderToTextureCPU=new Float32Array(4*this.xSmallTexSize*this.ySmallTexSize)}else console.log("cant create float texture");this.createClipPlaneGeometry(),this.matWireFrame&&(this.matWireFrame.uniforms.texBF.value=this.bfTexture,this.matWireFrame.uniforms.texBF.needsUpdate=!0,this.matWireFrame.uniforms.texFF.value=this.ffTexture,this.matWireFrame.uniforms.texFF.needsUpdate=!0),u=new se,this.matScreenTex=u.create(this.ffTexture),(new ee).create((function(e){o.matBF=e,o.sceneReadyCounter++})),(l=new ne).m_uniforms.PlaneX.value=new Z.S(-1,0,0,.5),l.m_uniforms.PlaneY.value=new Z.S(0,-1,0,.5),l.m_uniforms.PlaneZ.value=new Z.S(0,0,-1,.5),l.create(this.bfTexture.texture,(function(e){o.matFF=e,o.sceneReadyCounter++})),this.mesh=new Z.y(this.geometry),this.orbitControl.setMesh(this.mesh),this.orbitControl.setWireMesh(this.meshSphere);for(var S=[],x=0;x<64;++x){var y=2*Math.random()-1,T=2*Math.random()-1,D=-Math.random();S.push(new Z.R(y,T,D))}this.matRenderToTextureThreeGS=new ue,this.matRenderToTextureThreeGS.m_uniforms.colorMap1D.value=this.colorMapTexture,this.matRenderToTextureThreeGS.create(this.texTF,this.volTexture,null,this.texVolumeAO,this.bfTexture.texture,this.ffTexture.texture,S,(function(e){e.uniforms.t_function1min.value=new Z.S(nt,0,0,o.curFileDataType.thresholdTissue1),e.uniforms.t_function1max.value=new Z.S(1,0,0,o.curFileDataType.thresholdTissue2),e.uniforms.t_function2min.value=new Z.S(1,rt,st,o.curFileDataType.thresholdIsosurf),e.uniforms.t_function2max.value=new Z.S(ot,at,mt,o.curFileDataType.thresholdIsosurf),e.uniforms.stepSize.value=new Z.S(lt,ht,ut,ct),e.uniforms.texSize.value=c,e.uniforms.isoThreshold.value=o.curFileDataType.thresholdIsosurf,e.uniforms.brightness3D.value=o.curFileDataType.brightness,e.uniforms.opacityBarrier.value=dt*o.curFileDataType.opacityTissue,e.uniforms.volumeSizeZ.value=_,e.uniforms.xDim.value=c,e.uniforms.yDim.value=d,e.uniforms.lightDir.value=new Z.R(o.curFileDataType.lightDirComp,o.curFileDataType.lightDirComp,o.curFileDataType.lightDirComp),e.uniforms.needsUpdate=!0,o.matRenderToTexture=e,o.sceneReadyCounter++}));(h=new _e).m_uniforms.isoSurfTexel.value=new Z.Q(3/this.windowWidth,3/this.windowHeight),h.create(this.renderToTexture.texture,(function(e){e.uniforms.needsUpdate=!0,o.sceneReadyCounter++})),this.matSkullThreeGS=new pe,this.matSkullThreeGS.m_uniforms.isoSurfTexel.value=new Z.Q(3/this.windowWidth,3/this.windowHeight),this.matSkullThreeGS.m_uniforms.colorMap1D.value=this.colorMapTexture,this.matSkullThreeGS.create(this.texTF,this.volTexture,null,this.texVolumeAO,this.bfTexture.texture,this.ffTexture.texture,this.renderToTexture.texture,S,(function(e){e.uniforms.t_function1min.value=new Z.S(nt,0,0,o.curFileDataType.thresholdTissue1),e.uniforms.t_function1max.value=new Z.S(1,0,0,o.curFileDataType.thresholdTissue2),e.uniforms.t_function2min.value=new Z.S(1,rt,st,o.curFileDataType.thresholdIsosurf),e.uniforms.t_function2max.value=new Z.S(ot,at,mt,o.curFileDataType.thresholdIsosurf),e.uniforms.stepSize.value=new Z.S(lt,ht,ut,ct),e.uniforms.texSize.value=c,e.uniforms.isoThreshold.value=o.curFileDataType.thresholdIsosurf,e.uniforms.brightness3D.value=o.curFileDataType.brightness,e.uniforms.volumeSizeZ.value=_,e.uniforms.xDim.value=c,e.uniforms.yDim.value=d,e.uniforms.opacityBarrier.value=dt*o.curFileDataType.opacityTissue,e.uniforms.lightDir.value=new Z.R(o.curFileDataType.lightDirComp,o.curFileDataType.lightDirComp,o.curFileDataType.lightDirComp),e.uniforms.needsUpdate=!0,o.scene.add(o.mesh),o.matVolumeRender=e,s?o.switchToFullVolumeRender():o.switchToVolumeRender(),o.mesh.material=o.matVolumeRender,o.meshSphere.material=o.matVolumeRender,o.sceneReadyCounter++}))}}},{key:"setTransferFuncColors",value:function(e){this.volumeUpdater.setTransferFuncColors(e)}},{key:"updateTransferFuncTexture",value:function(e,t){return this.volumeUpdater.updateTransferFuncTexture(e,t)}},{key:"updateSelectedRoiMap",value:function(e){this.volumeUpdater.updateSelectedRoiMap(e)}},{key:"updateCutPlanes",value:function(){if(this.mesh){var e=new Z.x;1===this.renderScene?e.getInverse(e.extractRotation(this.meshSphere.matrix)):e.getInverse(e.extractRotation(this.mesh.matrix));var t=new Z.R(-1,0,0),i=new Z.R(0,-1,0),n=new Z.R(0,0,-1),r=(new Z.R).copy(this.planeCenterPt);r.applyMatrix4(e),t.applyMatrix4(e),i.applyMatrix4(e),n.applyMatrix4(e),null!==this.matFF&&(this.matFF.uniforms.PlaneX.value.x=t.x,this.matFF.uniforms.PlaneX.value.y=t.y,this.matFF.uniforms.PlaneX.value.z=t.z,this.matFF.uniforms.PlaneX.value.w=-r.dot(t),this.matFF.uniforms.PlaneY.value.x=i.x,this.matFF.uniforms.PlaneY.value.y=i.y,this.matFF.uniforms.PlaneY.value.z=i.z,this.matFF.uniforms.PlaneY.value.w=-r.dot(i),this.matFF.uniforms.PlaneZ.value.x=-n.x,this.matFF.uniforms.PlaneZ.value.y=n.y,this.matFF.uniforms.PlaneZ.value.z=n.z,this.matFF.uniforms.PlaneZ.value.w=-r.dot(n))}}},{key:"updateLightDir",value:function(){if(this.mesh){var e=new Z.x;0===this.renderScene?e.getInverse(e.extractRotation(this.mesh.matrix)):e.getInverse(e.extractRotation(this.meshSphere.matrix));var t=new Z.R(1,1,1);t.normalize(),t.applyMatrix4(e),t.x=-t.x,this.matRenderToTexture.uniforms.lightDir.value=t,this.matRenderToTexture.uniforms.lightDir.needsUpdate=!0,this.matVolumeRender.uniforms.lightDir.value=t,this.matVolumeRender.uniforms.lightDir.needsUpdate=!0}else console.log("UpdateLightDir call mesh is not created")}},{key:"isReadyToRender",value:function(){return 5===this.sceneReadyCounter&&!(null===this.matVolumeRender||null===this.matBF||null===this.matFF||null===this.matRenderToTexture)}},{key:"render",value:function(){if(this.isReadyToRender())if(null!==this.matVolumeRender&&null!==this.matBF&&null!==this.matFF&&null!==this.matRenderToTexture){if(0===this.checkFrameBufferMode&&(this.checkFrameBufferMode=1),0===this.renderScene){this.updateLightDir(),this.updateClipPlaneGeometry(),this.updateCutPlanes(),this.renderer.setRenderTarget(this.bfTexture),this.renderer.clear(),this.renderer.state.buffers.depth.setClear(0),this.scene.overrideMaterial=this.matBF,this.renderer.render(this.scene,this.camera,this.bfTexture);var e=this.renderer.getContext();this.isEraseMode&&!this.lockEraserBuffersUpdating&&e.readPixels(0,0,this.windowWidth,this.windowHeight,e.RGBA,e.FLOAT,this.bufferBFTextureCPU),this.renderer.setRenderTarget(this.ffTexture),this.renderer.clear(),this.renderer.state.buffers.depth.setClear(1),this.renderer.render(this.sceneClipPlane,this.camera,this.ffTexture),this.scene.overrideMaterial=this.matFF,this.renderer.render(this.scene,this.camera,this.ffTexture),this.isEraseMode&&!this.lockEraserBuffersUpdating&&e.readPixels(0,0,this.windowWidth,this.windowHeight,e.RGBA,e.FLOAT,this.bufferFFTextureCPU),this.renderer.setRenderTarget(),this.renderer.clear(),this.renderer.state.buffers.depth.setClear(0),this.scene.overrideMaterial=this.matRenderToTexture,this.renderer.render(this.scene,this.camera,this.renderToTexture),this.isEraseMode&&!this.lockEraserBuffersUpdating&&e.readPixels(0,0,this.xSmallTexSize,this.ySmallTexSize,e.RGBA,e.FLOAT,this.bufferRenderToTextureCPU),this.scene.overrideMaterial=null,this.renderer.render(this.scene,this.camera),this.renderer.autoClearDepth=!1,this.Tool23D&&this.renderer.render(this.scene23D,this.camera),this.renderer.autoClearDepth=!0}this.renderCounter++}else;}},{key:"setStepsize",value:function(e){var t=1/(100+700*e);null!==this.matRenderToTexture&&(this.matRenderToTexture.uniforms.stepSize.value=new Z.S(t,t,t,t),this.matRenderToTexture.uniforms.needsUpdate=!0),null!==this.matVolumeRender&&(this.matVolumeRender.uniforms.stepSize.value=new Z.S(t,t,t,t),this.matVolumeRender.uniforms.needsUpdate=!0)}},{key:"getVertexProjectionToScreen",value:function(e,t){var i=e.clone();i.applyMatrix4(this.meshSphere.matrixWorld),i.project(this.camera);var n=.5*this.windowWidth,r=.5*this.windowHeight,s=n+n*i.x,o=r+r*i.y;t.x=s,t.y=o;var a=e.clone();return a.applyMatrix4(this.meshSphere.matrixWorld),a.applyMatrix3(this.camera.normalMatrix),a.z}},{key:"setEraserMode",value:function(e){if(this.isEraseMode=e,this.orbitControl.setEraserMode(e),!this.eraserStarted&&e){this.eraserStarted=!0;var t={xDim:this.volume.m_xDim,yDim:this.volume.m_yDim,zDim:this.volume.m_zDim,bufBF:this.bufferBFTextureCPU,bufFF:this.bufferFFTextureCPU,bufTex:this.bufferRenderToTextureCPU};this.volTextureMask=this.volumeUpdater.createUpdatableVolumeMask(t),this.matSkullThreeGS.m_uniforms.texVolumeMask.value=this.volTextureMask,this.matRenderToTextureThreeGS.m_uniforms.texVolumeMask.value=this.volTextureMask}e?this.setMaskFlag(1):this.setMaskFlag(0)}},{key:"undoEraser",value:function(){this.volumeUpdater.eraser.undoLastErasing()}},{key:"setEraserStart",value:function(e){this.eraserStart=e}},{key:"onMouseDown",value:function(e,t){this.Tool23D?this.graphics23d.onMouseDown(e/this.windowWidth,t/this.windowHeight):(this.orbitControl.onMouseDown(e,t),1===this.checkFrameBufferMode&&(this.renderState=this.RENDER_STATE.ENABLED,this.eraserMouseDown=!0,this.isEraseMode&&this.eraserStart&&(this.lockEraserBuffersUpdating=!0,this.volumeUpdater.eraser.eraseStart(e,t,this.windowWidth,this.matVolumeRender.uniforms.isoThreshold.value,!0))))}},{key:"onMouseMove",value:function(e,t){this.Tool23D?this.graphics23d.onMouseMove(e/this.windowWidth,t/this.windowHeight):1===this.checkFrameBufferMode&&(this.renderState=this.RENDER_STATE.ENABLED,this.isEraseMode&&this.eraserMouseDown&&this.eraserStart?this.volumeUpdater.eraser.eraseStart(e,t,this.windowWidth,this.matVolumeRender.uniforms.isoThreshold.value,!1):this.orbitControl.onMouseMove(e,t))}},{key:"onMouseUp",value:function(e,t){this.Tool23D?this.graphics23d.onMouseUp(e/this.windowWidth,t/this.windowHeight):(this.orbitControl.onMouseUp(),1===this.checkFrameBufferMode&&(this.lockEraserBuffersUpdating=!1,this.eraserMouseDown=!1,this.renderState=this.RENDER_STATE.ONCE))}},{key:"onMouseWheel",value:function(e){var t=Math.max(-1,Math.min(1,e.deltaY||-e.detail));this.orbitControl.onZoom(-t),1===this.checkFrameBufferMode&&(this.renderState=this.RENDER_STATE.ONCE)}}]),e}(),ft=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).onMode=n.onMode.bind(Object(S.a)(n)),n.isLoaded=!1,n.volume=null,n.start=n.start.bind(Object(S.a)(n)),n.stop=n.stop.bind(Object(S.a)(n)),n.animate=n.animate.bind(Object(S.a)(n)),n.renderScene=n.renderScene.bind(Object(S.a)(n)),n.setVolRenderToStore=n.setVolRenderToStore.bind(Object(S.a)(n)),n.onKeyDown=n.onKeyDown.bind(Object(S.a)(n)),n.onKeyUp=n.onKeyUp.bind(Object(S.a)(n)),n.m_mount=null,n.m_volumeRenderer3D=null,n.m_distanceTool=null,n.m_renderer=null,n.m_frameId=null,n.m_prevMode=c.RAYCAST,n.m_fileDataType={thresholdIsosurf:.46,thresholdTissue1:.09,thresholdTissue2:.3,opacityTissue:.53,startRotX:.5*-Math.PI,startRotY:Math.PI,lightDirComp:-.5773,brightness:.56},n.state={wRender:0,hRender:0},n}return Object(v.a)(i,[{key:"setVolRenderToStore",value:function(e){var t=this.props;t.dispatch({type:l.SET_VOLUME_Renderer,volumeRenderer:e}),t.dispatch({type:l.SET_SLIDER_3DR,slider3d_r:Number.parseFloat(.09)}),t.dispatch({type:l.SET_SLIDER_3DG,slider3d_g:Number.parseFloat(.3)}),t.dispatch({type:l.SET_SLIDER_3DB,slider3d_b:Number.parseFloat(.46)}),t.dispatch({type:l.SET_SLIDER_Opacity,sliderOpacity:Number.parseFloat(.53)}),t.dispatch({type:l.SET_SLIDER_Isosurface,sliderIsosurface:Number.parseFloat(.46)}),t.dispatch({type:l.SET_SLIDER_Brightness,sliderBrightness:Number.parseFloat(.56)}),t.dispatch({type:l.SET_SLIDER_Cut,sliderCut:Number.parseFloat(1)}),t.dispatch({type:l.SET_SLIDER_Quality,sliderQuality:Number.parseFloat(.35)})}},{key:"start",value:function(){null===this.m_frameId&&(this.m_frameId=requestAnimationFrame(this.animate))}},{key:"stop",value:function(){cancelAnimationFrame(this.m_frameId),this.m_frameId=null}},{key:"animate",value:function(){this.renderScene(),this.m_frameId=window.requestAnimationFrame(this.animate)}},{key:"renderScene",value:function(){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.render()}},{key:"onMode",value:function(e){this.props.dispatch({type:l.SET_MODE_3D,mode3d:e})}},{key:"componentDidMount",value:function(){var e=this.m_mount.clientWidth>0?this.m_mount.clientWidth:200,t=this.m_mount.clientHeight>0?this.m_mount.clientHeight:200;if(0===this.state.wRender&&(this.setState({wRender:e}),this.setState({hRender:t})),null===this.m_volumeRenderer3D&&(this.m_volumeRenderer3D=new _t({curFileDataType:this.m_fileDataType,width:e,height:t,mount:this.m_mount})),this.setVolRenderToStore(this.m_volumeRenderer3D),null!==this.volume&&!1===this.isLoaded&&null!==this.m_volumeRenderer3D){var i=this.props,n=i.volumeSet,r=i.volumeIndex,s=4===n.getVolume(r).m_bytesPerVoxel;i.modeView===h.VIEW_3D?this.m_volumeRenderer3D.initWithVolume(this.volume,this.volume.m_boxSize,{x:0,y:0,z:0},{x:1,y:1,z:1},s,!0):this.m_volumeRenderer3D.initWithVolume(this.volume,this.volume.m_boxSize,{x:0,y:0,z:0},{x:1,y:1,z:1},s,!1),this.isLoaded=!0}this.start(),this.m_mount.focus()}},{key:"componentWillUnmount",value:function(){this.stop(),null!==this.m_renderer&&this.m_mount.removeChild(this.m_renderer.domElement),this.m_volumeRenderer3D=null}},{key:"_onMouseMove",value:function(e){if(null!==this.m_volumeRenderer3D){var t=this.m_mount.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this.m_volumeRenderer3D.onMouseMove(i,-(this.state.hRender-n),this.props.ereaseStart)}}},{key:"_onMouseDown",value:function(e){if(null!==this.m_volumeRenderer3D){var t=this.m_mount.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this.m_volumeRenderer3D.onMouseDown(i,-(this.state.hRender-n),this.props.ereaseStart)}}},{key:"_onMouseUp",value:function(){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseUp()}},{key:"_onWheel",value:function(e){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseWheel(e)}},{key:"onClick",value:function(e){e.stopPropagation()}},{key:"onTouchStart",value:function(e){if(void 0!==this.m_mount&&null!==this.m_mount){var t=e.changedTouches,i=t.length;if(i>=2&&console.log("onTouchStart. numTouches == 2"),i>=1){var n=this.m_mount.getBoundingClientRect(),r=t[i-1].pageX-n.left,s=t[i-1].pageY-n.top;null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseDown(r,this.state.hRender-s,this.props.ereaseStart)}}}},{key:"onTouchMove",value:function(e){if(void 0!==this.m_mount&&null!==this.m_mount){var t=e.changedTouches,i=t.length;if(i>=2&&console.log("onTouchStart. numTouches == 2"),i>=1){var n=this.m_mount.getBoundingClientRect(),r=t[i-1].pageX-n.left,s=t[i-1].pageY-n.top;null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseMove(r,this.state.hRender-s,this.props.ereaseStart)}}}},{key:"onTouchEnd",value:function(){null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.onMouseUp()}},{key:"onKeyDown",value:function(e){"Control"===e.key&&(console.log("Ctrl key was pressed"),this.props.volumeRenderer.setEraserStart(!0))}},{key:"onKeyUp",value:function(e){"Control"===e.key&&(console.log("Ctrl key was released"),this.props.volumeRenderer.setEraserStart(!1))}},{key:"render",value:function(){var e=this,t=this.props,i=null,n=t.volumeSet;if(n.getNumVolumes()>0){var s=t.volumeIndex;i=n.getVolume(s)}null!==i&&(this.volume=i);var o=t.mode3d,a=t.modeView;null!==this.m_volumeRenderer3D&&(this.m_volumeRenderer3D.switchToTool23D(t.isTool3D),a!==h.VIEW_3D?(o===c.RAYCAST&&(this.m_prevMode=c.RAYCAST,this.m_volumeRenderer3D.setTransferFuncVec3([t.slider3d_r,t.slider3d_g,t.slider3d_b],0),this.m_volumeRenderer3D.switchToVolumeRender()),o===c.ISO&&(this.m_prevMode=c.ISO,this.m_volumeRenderer3D.switchToIsosurfRender(),this.m_volumeRenderer3D.setIsoThresholdValue(t.sliderIsosurface)),o===c.RAYFAST&&(this.m_prevMode=c.RAYFAST,this.m_volumeRenderer3D.switchToFLATRender()),o===c.EREASER&&(this.m_prevMode=c.RAYFAST,this.m_volumeRenderer3D.switchToIsosurfRender(),this.m_volumeRenderer3D.setIsoThresholdValue(t.sliderIsosurface),this.m_volumeRenderer3D.volumeUpdater.eraser.setEraserRadius(t.sliderErRadius),this.m_volumeRenderer3D.volumeUpdater.eraser.setEraserDepth(t.sliderErDepth))):this.m_volumeRenderer3D.switchToFullVolumeRender(),this.m_volumeRenderer3D.setOpacityBarrier(t.sliderOpacity),this.m_volumeRenderer3D.updateBrightness(t.sliderBrightness),this.m_volumeRenderer3D.updateZCutPlane(t.sliderCut-.5),this.m_volumeRenderer3D.setStepsize(t.sliderQuality),this.m_volumeRenderer3D.updateContrast(t.sliderContrast3D)),null!==this.m_volumeRenderer3D&&this.m_volumeRenderer3D.render();var m=r.a.createElement("div",{style:{width:"100%",height:"100%"},ref:function(t){e.m_mount=t},onMouseMove:this._onMouseMove.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseUp:this._onMouseUp.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchEnd:this.onTouchEnd.bind(this),onTouchMove:this.onTouchMove.bind(this),onClick:this.onClick.bind(this),onWheel:this._onWheel.bind(this)}),l=r.a.createElement("div",{width:this.state.wRender,height:this.state.hRender,ref:function(t){e.m_mount=t},onMouseMove:this._onMouseMove.bind(this),onMouseDown:this._onMouseDown.bind(this),onMouseUp:this._onMouseUp.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchEnd:this.onTouchEnd.bind(this),onTouchMove:this.onTouchMove.bind(this),onClick:this.onClick.bind(this),tabIndex:"1",onKeyDown:function(t){return e.onKeyDown(t)},onKeyUp:function(t){return e.onKeyUp(t)},onWheel:this._onWheel.bind(this)});return this.state.wRender>0?l:m}}]),i}(r.a.Component),vt=Object(a.b)((function(e){return e}))(ft),pt=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(){return Object(f.a)(this,i),t.apply(this,arguments)}return Object(v.a)(i,[{key:"render",value:function(){var e={minHeight:882..toString()+"px"};return r.a.createElement(x.a,null,r.a.createElement(y.a,{xs:12,sm:!0,md:!0,lg:12,style:e},r.a.createElement(vt,null)))}}]),i}(r.a.Component),gt=Object(a.b)((function(e){return e}))(pt),St=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(){return Object(f.a)(this,i),t.apply(this,arguments)}return Object(v.a)(i,[{key:"render",value:function(){var e=this.props.modeView,t=r.a.createElement(q,null),i=r.a.createElement(gt,null),n=new Array(h.VIEW_COUNT);return n[h.VIEW_2D]=t,n[h.VIEW_3D_LIGHT]=i,n[h.VIEW_3D]=i,n[e]}}]),i}(r.a.Component),xt=Object(a.b)((function(e){return e}))(St),yt=i(127),Tt=i.n(yt),Dt=i(128),bt=i.n(Dt),Rt=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).m_xDim=0,n.m_yDim=0,n.m_zDim=0,n.m_bytesPerVoxel=0,n.m_dataArray=null,n.m_dataSize=0,n.m_boxSize={x:0,y:0,z:0},n.m_xIcon=0,n.m_yIcon=0,n.m_dataIcon=null,n}return Object(v.a)(i,[{key:"createEmptyBytesVolume",value:function(e,t,i){this.m_xDim=e,this.m_yDim=t,this.m_zDim=i;var n=e*t*i;this.m_bytesPerVoxel=1,this.m_dataArray=new Uint8Array(n),this.m_dataSize=n,this.m_boxSize={x:e,y:t,z:i};for(var r=0;r<n;r++)this.m_dataArray[r]=0}},{key:"createIcon",value:function(){console.assert(this.m_xDim>0),console.assert(this.m_yDim>0),console.assert(this.m_zDim>0),console.assert(null!==this.m_dataArray);var e=this.m_xDim>this.m_yDim?this.m_xDim:this.m_yDim,t=e/64,i=Math.floor(this.m_zDim/2)*this.m_xDim*this.m_yDim;this.m_xIcon=64,this.m_yIcon=this.m_xIcon;var n=this.m_xIcon*this.m_yIcon;this.m_dataIcon=new Uint8Array(n);for(var r=0;r<n;r++)this.m_dataIcon[r]=0;for(var s=Math.floor(64*this.m_xDim/e),o=Math.floor(64*this.m_yDim/e),a=Math.floor(this.m_xIcon/2-s/2),m=Math.floor(this.m_yIcon/2-o/2),l=0;l<o;l++)for(var h=Math.floor(l*t),u=0;u<s;u++){var c=Math.floor(u*t),d=this.m_dataArray[c+h*this.m_xDim+i],_=u+a,f=l+m;this.m_dataIcon[_+f*this.m_xIcon]=d}}},{key:"makeDimensions4x",value:function(){if(!(this.m_zDim<4)){var e=this.m_xDim+3&-4,t=this.m_yDim+3&-4,i=this.m_zDim+3&-4;if(this.m_xDim!==e||this.m_yDim!==t||this.m_zDim!==i){console.log("Volume. makeDimensions4x. Convert into ".concat(e,"*").concat(t,"*").concat(i));var n,r=e*t*i,s=this.m_bytesPerVoxel,o=r*s,a=new Uint8Array(r*s);for(n=0;n<o;n++)a[n]=0;console.log("Volume info: xyzDim = ".concat(this.m_xDim,"*").concat(this.m_yDim,"*").concat(this.m_zDim)),console.log("Volume info: bpp = ".concat(this.m_bytesPerVoxel)),console.log("Volume info: dataSize = ".concat(this.m_dataSize));var m=this.m_xDim*this.m_yDim;if(1===this.m_bytesPerVoxel)for(var l=0;l<this.m_zDim;l++)for(var h=l*m,u=l*e*t,c=0;c<this.m_yDim;c++)for(var d=c*this.m_xDim,_=c*e,f=0;f<this.m_xDim;f++){var v=f+d+h,p=this.m_dataArray[v];a[f+_+u]=p}else if(4===this.m_bytesPerVoxel)for(var g=0;g<this.m_zDim;g++)for(var S=g*m,x=g*e*t,y=0;y<this.m_yDim;y++)for(var T=y*this.m_xDim,D=y*e,b=0;b<this.m_xDim;b++){var R=4*(b+T+S),w=this.m_dataArray[R+0],M=this.m_dataArray[R+1],E=this.m_dataArray[R+2],A=this.m_dataArray[R+3],I=4*(b+D+x);a[I+0]=w,a[I+1]=M,a[I+2]=E,a[I+3]=A}this.m_xDim=e,this.m_yDim=t,this.m_zDim=i,this.m_dataArray=a,this.m_dataSize=r}}}},{key:"render",value:function(){return r.a.createElement("p",null,">")}}]),i}(r.a.Component),wt=function(){function e(){Object(f.a)(this,e)}return Object(v.a)(e,null,[{key:"getResultString",value:function(t){switch(t){case e.SUCCESS:return"Success";case e.UNKNOWN:return"Unknown";case e.BAD_DICOM:return"Bad Dicom";case e.BAD_HEADER:return"Bad header";case e.UNSUPPORTED_ENDIANNESS:return"Unsupported endianness";case e.UNSUPPORTED_COLOR_FORMAT:return"Unsupported color format";case e.WRONG_HEADER_DATA_SIZE:return"Wrong header data size";case e.WRONG_HEADER_DIMENSIONS:return"Wrong header dimensions";case e.WRONG_HEADER_DATA_TYPE:return"Wrong header data type";case e.WRONG_HEADER_BITS_PER_PIXEL:return"Wrong header bits per pixel";case e.WRONG_HEADER_MAGIC:return"Wrong header magic";case e.ERROR_PROCESS_HISTOGRAM:return"Wrong histogram";case e.WRONG_IMAGE_DIM_X:return"Wrong image dim x";case e.WRONG_IMAGE_DIM_Y:return"Wrong image dim y";case e.WRONG_IMAGE_DIM_Z:return"Wrong image dim z";case e.ERROR_PIXELS_TAG_NOT_FOUND:return"Pixels tag is not found";case e.ERROR_NO_MEMORY:return"No memory during loading";case e.ERROR_CANT_OPEN_URL:return"Cant open file via url";case e.ERROR_WRONG_NUM_SLICES:return"Wrong number of slices";case e.ERROR_HISTOGRAM_DETECT_RIDGES:return"Error detect histogram ridges";case e.ERROR_SCALING:return"Error scaling 16 bit data into 8 bit";case e.ERROR_INVALID_SLICE_INDEX:return"Invalid slice index. Possible reason: incomplete dicom folder";case e.ERROR_TOO_SMALL_DATA_SIZE:return"Too small input data size";case e.ERROR_TOO_LARGE_DATA_SIZE:return"Too large input data size";case e.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED:return"Compressed image formats read is not supported";default:return"Unknown error code"}}}]),e}();wt.SUCCESS=0,wt.UNKNOWN=1,wt.BAD_DICOM=2,wt.BAD_HEADER=3,wt.UNSUPPORTED_ENDIANNESS=4,wt.UNSUPPORTED_COLOR_FORMAT=5,wt.WRONG_HEADER_DATA_SIZE=6,wt.WRONG_HEADER_DIMENSIONS=7,wt.WRONG_HEADER_DATA_TYPE=8,wt.WRONG_HEADER_BITS_PER_PIXEL=9,wt.WRONG_HEADER_MAGIC=10,wt.ERROR_PROCESS_HISTOGRAM=11,wt.WRONG_IMAGE_DIM_X=12,wt.WRONG_IMAGE_DIM_Y=13,wt.ERROR_PIXELS_TAG_NOT_FOUND=14,wt.ERROR_NO_MEMORY=15,wt.ERROR_CANT_OPEN_URL=16,wt.ERROR_WRONG_NUM_SLICES=17,wt.ERROR_HISTOGRAM_DETECT_RIDGES=18,wt.ERROR_SCALING=19,wt.ERROR_INVALID_SLICE_INDEX=20,wt.ERROR_TOO_SMALL_DATA_SIZE=21,wt.ERROR_TOO_LARGE_DATA_SIZE=22,wt.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED=23;var Mt=null,Et=function(){function e(t){Object(f.a)(this,e),Mt||(Mt=this),this.m_url=t,this.m_request=null,this.readFile=this.readFile.bind(this)}return Object(v.a)(e,[{key:"readFile",value:function(e,t){var i=this;if(this.m_request=new XMLHttpRequest,this.m_request||console.log("Cant create object request"),!("withCredentials"in this.m_request))return this.m_request=null,void console.log("This browser cant support CORS requests");this.m_request.open("GET",this.m_url,!0),this.m_request.responseType="arraybuffer",this.m_request.addEventListener("load",(function(t){var i=t.target.response;if(null===i)console.log("Bad response type. Expect object type in response.");else if(e){var n=new TextDecoder("utf-8"),r=i.byteLength;r>4e3&&(r=4e3);var s=i.slice(0,r),o=n.decode(s);"<!DOCTYPE"===o.substr(0,9)&&console.log("Error load data from URL. Read result is "+o),e(i)}}),!1),this.m_request.addEventListener("error",(function(){var e="Error accessing file ".concat(i.m_url);t(e)}),!1),this.m_request.send();if(404===this.m_request.status){var n="Cant access url =  ".concat(this.m_url);t(n)}}}]),e}(),At=6403,It=6407,Ot=6408,Xt=function(){function e(){Object(f.a)(this,e),this.m_header={m_id:"",m_endianness:0,m_glType:0,m_glTypeSize:0,m_glFormat:0,m_glInternalFormat:0,m_glBaseInternalFormat:0,m_pixelWidth:0,m_pixelHeight:0,m_pixelDepth:0,m_numberOfArrayElements:0,m_numberOfFaces:0,m_numberOfMipmapLevels:0,m_bytesOfKeyValueData:0},this.m_boxSize={x:0,y:0,z:0}}return Object(v.a)(e,[{key:"readFromBuffer",value:function(t,i,n,r){var s=new Uint8Array(i),o=0;if(void 0!==n&&n(0),0===s.length)return void 0!==r&&r(wt.BAD_HEADER),wt.BAD_HEADER;var a,m=[171,75,84,88,32,49,49,187,13,10,26,10],l=m.length,h=!0;for(a=0;a<l;a++){if(s[o]!==m[a]){h=!1;break}this.m_header.m_id+=String.fromCharCode(s[o]),o+=1}if(!h)return console.log("KTX HEADER IS WRONG"),void 0!==r&&r(wt.BAD_HEADER),wt.BAD_HEADER;var u=67305985;if(this.m_header.m_endianness=e.readInt(s,o),o+=4,this.m_header.m_endianness!==u){var c=this.m_header.m_endianness.toString(16);return console.log("ENDIANNESS IS WRONG. Found = ".concat(c," , but should be = ").concat(u.toString(16))),void 0!==r&&r(wt.UNSUPPORTED_ENDIANNESS),wt.UNSUPPORTED_ENDIANNESS}if(this.m_header.m_glType=e.readInt(s,o),o+=4,this.m_header.m_glTypeSize=e.readInt(s,o),o+=4,this.m_header.m_glFormat=e.readInt(s,o),o+=4,this.m_header.m_glFormat!==At&&this.m_header.m_glFormat!==It&&this.m_header.m_glFormat!==Ot)return console.log("KTX header.m_glFormat is WRONG"),void 0!==r&&r(wt.UNSUPPORTED_COLOR_FORMAT),wt.UNSUPPORTED_COLOR_FORMAT;this.m_header.m_glInternalFormat=e.readInt(s,o),o+=4,this.m_header.m_glBaseInternalFormat=e.readInt(s,o),o+=4,this.m_header.m_pixelWidth=e.readInt(s,o),o+=4,this.m_header.m_pixelHeight=e.readInt(s,o),o+=4,this.m_header.m_pixelDepth=e.readInt(s,o),o+=4,t.m_xDim=this.m_header.m_pixelWidth,t.m_yDim=this.m_header.m_pixelHeight,t.m_zDim=this.m_header.m_pixelDepth;var d=this.m_header,_=8192;if(d.m_pixelWidth<4||d.m_pixelHeight<4||d.m_pixelDepth<4)return console.log("KTX dims too small: ".concat(d.m_pixelWidth," * ").concat(d.m_pixelHeight," * ").concat(d.m_pixelDepth)),void 0!==r&&r(wt.WRONG_IMAGE_DIM_X),wt.WRONG_IMAGE_DIM_X;if(d.m_pixelWidth>_||d.m_pixelHeight>_||d.m_pixelDepth>_)return console.log("KTX dims too large: ".concat(d.m_pixelWidth," * ").concat(d.m_pixelHeight," * ").concat(d.m_pixelDepth)),void 0!==r&&r(wt.WRONG_IMAGE_DIM_X),wt.WRONG_IMAGE_DIM_X;this.m_header.m_numberOfArrayElements=e.readInt(s,o),o+=4,this.m_header.m_numberOfFaces=e.readInt(s,o),o+=4,this.m_header.m_numberOfMipmapLevels=e.readInt(s,o),o+=4,this.m_header.m_bytesOfKeyValueData=e.readInt(s,o),o+=4;var f=0;if(this.m_header.m_glFormat===At?f=1:this.m_header.m_glFormat===It?f=3:this.m_header.m_glFormat===Ot&&(f=4),this.m_header.m_bytesOfKeyValueData>0){var v,p,g,S,x,y,T=o;for(o+=this.m_header.m_bytesOfKeyValueData;T<o;){var D="",b=void 0;for(b=s[T+=4];0!==b;T++)0!==(b=s[T])&&(D=D.concat(String.fromCharCode(b)));if(console.log("UDataString = ".concat(D)),"fBoxMin"===D)v=e.readFloat(s,T),T+=4,p=e.readFloat(s,T),T+=4,g=e.readFloat(s,T),T+=4,console.log("vBoxMix = ".concat(v," * ").concat(p," * ").concat(g));else if("fBoxMax"===D){S=e.readFloat(s,T),T+=4,x=e.readFloat(s,T),T+=4,y=e.readFloat(s,T),T+=4,this.m_boxSize.x=S-v,this.m_boxSize.y=x-p,this.m_boxSize.z=y-g,console.log("vBox = ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z));break}}}this.m_dataSize=e.readInt(s,o),o+=4;var R,w=this.m_header.m_pixelWidth*this.m_header.m_pixelHeight*this.m_header.m_pixelDepth*f;if(this.m_dataSize!==w)return console.log("!!! not implemented yet"),void 0!==r&&r(wt.WRONG_HEADER_DATA_SIZE),wt.WRONG_HEADER_DATA_SIZE;this.m_dataArray=new Uint8Array(this.m_dataSize);var M=!1;for(R=29;R>=0&&!M;R--){1<<R<this.m_dataSize&&(M=!0)}R++;(R-=3)<=0&&(R=1);for(var E=(1<<R)-1,A=0;A<this.m_dataSize;A++){if(this.m_dataArray[A]=s[o],o+=1,void 0!==n&&0===(A&E)&&A>0)n(A/this.m_dataSize)}if(0===this.m_boxSize.x){var I=.3;this.m_boxSize.x=I*this.m_header.m_pixelWidth,this.m_boxSize.x=I*this.m_header.m_pixelWidth,this.m_boxSize.y=I*this.m_header.m_pixelHeight,this.m_boxSize.z=I*this.m_header.m_pixelDepth,console.log("vBox = ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z))}return t.m_bytesPerVoxel=f,t.m_dataArray=this.m_dataArray,t.m_dataSize=this.m_dataSize,t.m_boxSize=this.m_boxSize,console.log("KTX Loaded successfully with dim = ".concat(t.m_xDim,"*").concat(t.m_yDim,"*").concat(t.m_zDim,". bpp=").concat(t.m_bytesPerVoxel)),this.m_isLoadedSuccessfull=!0,void 0!==n&&n(1),void 0!==r&&r(wt.SUCCESS),wt.SUCCESS}},{key:"readFromUrl",value:function(e,t,i,n){var r=this;console.log("LoadedKtx. staring read ".concat(t)),this.m_fileLoader=new Et(t),this.m_fileLoader.readFile((function(t){r.readFromBuffer(e,t,i,n)}),(function(e){console.log("LoaderKtx. Error read file: ".concat(e)),n(wt.ERROR_CANT_OPEN_URL,null,0,null)}))}}],[{key:"readInt",value:function(e,t){for(var i=0,n=0;n<4;n++){i=(i<<8)+e[t+3-n]}return i}},{key:"readFloat",value:function(e,t){var i=new ArrayBuffer(4),n=new DataView(i);n.setUint8(0,e[t+0]),n.setUint8(1,e[t+1]),n.setUint8(2,e[t+2]),n.setUint8(3,e[t+3]);return n.getFloat32(0,!0)}}]),e}(),Ct=function(){function e(){Object(f.a)(this,e),this.m_mouseDown=!1,this.m_indexMoved=-1,this.m_numHandles=10,this.m_handleColors=[{r:0,g:0,b:0},{r:255,g:128,b:64},{r:255,g:0,b:0},{r:128,g:64,b:64},{r:128,g:0,b:0},{r:64,g:64,b:64},{r:128,g:128,b:128},{r:192,g:192,b:192},{r:255,g:255,b:255},{r:255,g:255,b:255}],this.m_handleX=[0,22,40,55,61,115,118,125,160,255],this.m_handleY=[0,0,.3,.12,0,0,.4,.8,.95,1],this.m_proj=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}],this.m_handleColors.length!==this.m_numHandles&&console.log("Wrong array this.m_handleColors: ".concat(this.m_handleColors.length," !== ").concat(this.m_numHandles))}return Object(v.a)(e,[{key:"render",value:function(e,t,i,n,r){this.m_xMin=t,this.m_yMin=i,this.m_wScreen=n,this.m_hScreen=r;var s,o,a=Math.floor(n/50);this.m_radCircle=a,e.lineWidth=1,e.strokeStyle="#000000",s=-1,o=-1;for(var m=0;m<this.m_numHandles;m++){var l=this.m_handleX[m],h=this.m_handleY[m],u=t+Math.floor(n*l/255),c=i+Math.floor(r-1-r*h/1);this.m_proj[m].x=u,this.m_proj[m].y=c,m>0&&(e.beginPath(),e.moveTo(s,o),e.lineTo(u,c),e.stroke()),s=u,o=c}for(var d=0;d<this.m_numHandles;d++){var _=this.m_handleX[d],f=this.m_handleY[d],v=t+Math.floor(n*_/255),p=i+Math.floor(r-1-r*f/1),g=this.m_handleColors[d].r.toString(16),S=this.m_handleColors[d].g.toString(16),x=this.m_handleColors[d].b.toString(16);g=1===g.length?"0"+g:g,S=1===S.length?"0"+S:S,x=1===x.length?"0"+x:x;var y="#".concat(g).concat(S).concat(x);e.fillStyle=y,e.beginPath(),e.ellipse(v,p,a,a,0,0,2*Math.PI),e.fill(),e.stroke()}}},{key:"onMouseDown",value:function(e,t){for(var i=0;i<this.m_numHandles;i++){var n=e-this.m_proj[i].x,r=t-this.m_proj[i].y;n*n+r*r<=this.m_radCircle*this.m_radCircle&&(console.log("Picked point ".concat(i)),this.m_mouseDown=!0,this.m_indexMoved=i)}return!1}},{key:"onMouseUp",value:function(){return this.m_mouseDown=!1,!1}},{key:"onMouseMove",value:function(e,t){if(this.m_mouseDown){var i,n;i=0===this.m_indexMoved||this.m_indexMoved===this.m_numHandles-1?this.m_proj[this.m_indexMoved].x:(i=(i=e)<this.m_proj[this.m_indexMoved-1].x?this.m_proj[this.m_indexMoved-1].x:i)>this.m_proj[this.m_indexMoved+1].x?this.m_proj[this.m_indexMoved+1].x:i,(n=t)<this.m_yMin&&(n=this.m_yMin),n>this.m_yMin+this.m_hScreen&&(n=this.m_yMin+this.m_hScreen),this.m_proj[this.m_indexMoved].x=i,this.m_proj[this.m_indexMoved].y=n;var r=255*(i-this.m_xMin)/this.m_wScreen,s=1*(this.m_yMin+this.m_hScreen-1-n)/this.m_hScreen;return this.m_handleX[this.m_indexMoved]=r,this.m_handleY[this.m_indexMoved]=s,!0}return!1}}]),e}(),Pt=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).m_histogram=[],n.m_numColors=0,n.m_transfFunc=new Ct,n.m_transfFuncCallback=void 0,n.m_transfFuncUpdateCallback=void 0,n.setSize=n.setSize.bind(Object(S.a)(n)),n.onMouseDown=n.onMouseDown.bind(Object(S.a)(n)),n.onMouseUp=n.onMouseUp.bind(Object(S.a)(n)),n.onMouseMove=n.onMouseMove.bind(Object(S.a)(n)),n.state={width:0,height:220},n}return Object(v.a)(i,[{key:"componentDidMount",value:function(){this.updateCanvas(),window.addEventListener("resize",this.handleResize,!1),this.setSize()}},{key:"componentDidUpdate",value:function(){this.updateCanvas(),window.removeEventListener("resize",this.handleResize,!1)}},{key:"handleResize",value:function(){this.setSize()}},{key:"setSize",value:function(){var e=this.m_canvasOwner;if(null!==e){var t=e.clientWidth-2,i=e.clientHeight-2;this.setState({width:t}),this.setState({height:i})}}},{key:"getVolumeHistogram",value:function(e){var t,i=e.m_xDim,n=e.m_yDim,r=e.m_zDim,s=e.m_dataArray,o=i*n*r;for(this.m_numColors=256,this.m_histogram=new Array(this.m_numColors),t=0;t<this.m_numColors;t++)this.m_histogram[t]=0;for(t=0;t<o;t++){var a=s[t];this.m_histogram[a]++}var m=0;for(t=0;t<this.m_numColors;t++)m=this.m_histogram[t]>m?this.m_histogram[t]:m;var l=1/(m+=.001);for(t=0;t<this.m_numColors;t++)this.m_histogram[t]*=l;this.smoothHistogram(),this.getMaxPeak()}},{key:"assignArray",value:function(e,t){this.m_numColors=e,this.m_histogram=t}},{key:"getLastMaxIndex",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=4,n=!1;for(e=this.m_numColors-i;e>i;e--)if(this.m_histogram[e]>t&&this.m_histogram[e]>this.m_histogram[e-2]&&this.m_histogram[e]>this.m_histogram[e+2]){n=!0;break}return n?e:(console.log("getLastMaxIndex. Not found!"),-1)}},{key:"getMaxPeak",value:function(){var e;this.m_peakIndex=-1;var t=this.m_histogram,i=0;for(e=this.m_numColors-4;e>12;e--)if(t[e]>t[e-1]&&t[e]>t[e+1]&&t[e]>t[e-2]&&t[e]>t[e+2]){var n=t[e];n>i&&(i=n,this.m_peakIndex=e)}}},{key:"smoothHistogram",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1.2,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=60,n=Math.floor(this.m_numColors/i),r=32;n>r&&(n=r);var s,o=1/(2*e*e),a=new Array(this.m_numColors),m=0;for(s=0;s<this.m_numColors;s++){for(var l=0,h=0,u=-n;u<=n;u++){var c=s+u,d=u/n,_=Math.exp(-d*d*o);c>=0&&c<this.m_numColors&&(l+=this.m_histogram[c]*_,h+=_)}m=(l/=h)>m?l:m,a[s]=l}if(t)for(s=0;s<this.m_numColors;s++)this.m_histogram[s]=a[s]/m;else for(s=0;s<this.m_numColors;s++)this.m_histogram[s]=a[s]}},{key:"onMouseDown",value:function(e){if(void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback){var t=this.refs.canvasHistogram.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this.m_transfFunc.onMouseDown(i,n)&&this.forceRender()}}},{key:"onMouseUp",value:function(e){if(void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback){var t=this.refs.canvasHistogram.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this.m_transfFunc.onMouseUp(i,n)&&this.forceRender()}}},{key:"onMouseMove",value:function(e){if(void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback){var t=this.refs.canvasHistogram.getBoundingClientRect(),i=e.clientX-t.left,n=e.clientY-t.top;this.m_transfFunc.onMouseMove(i,n)&&this.forceRender()}}},{key:"updateCanvas",value:function(){if(void 0!==this.refs.canvasHistogram){var e=this.refs.canvasHistogram.getContext("2d"),t=this.refs.canvasHistogram.clientWidth,i=this.refs.canvasHistogram.clientHeight;e.fillStyle="rgb(220, 220, 220)",e.fillRect(0,0,t,i);var n=this.props.volume;null!==n&&this.getVolumeHistogram(n);var r=Math.floor(.01*t),s=Math.floor(.99*t),o=Math.floor(.05*i),a=Math.floor(.95*i),m=s-r,l=a-o;e.lineWidth=1,e.strokeStyle="#0a0a0a",e.moveTo(r,a),e.lineTo(r,o),e.stroke(),e.moveTo(r,a),e.lineTo(s,a),e.stroke(),e.font="10px Arial",e.fillStyle="rgb(120, 20, 20)",e.textBaseline="top",e.textAlign="center";var h,u=1;this.m_peakIndex>0&&(u=(u=2*this.m_histogram[this.m_peakIndex])>1?1:u);var c,d,_;for(h=0;h<=4;h++){var f=r+Math.floor(m*h/4);e.moveTo(f,a),e.lineTo(f,a+6),e.stroke();var v=Math.floor(0+this.m_numColors*h/4);e.textAlign=0===h?"left":4===h?"right":"center",e.fillText(v.toString(),f,a+4)}for(e.lineWidth=2,e.strokeStyle="#080808",e.fillStyle="#707070",e.beginPath(),e.moveTo(r,a),c=0;c<this.m_numColors;c++){d=r+Math.floor(m*c/this.m_numColors);var p=this.m_histogram[c]/u;p=p>=1?1:p,_=a-Math.floor(l*p),e.lineTo(d,_)}if(_=a,e.lineTo(d,_),e.closePath(),e.fill(),this.m_peakIndex>0){e.lineWidth=1,e.strokeStyle="#eeeeee";var g=r+Math.floor(m*this.m_peakIndex/this.m_numColors),S=this.m_histogram[this.m_peakIndex]/u;S=S>=1?1:S;var x=a-Math.floor(l*S);e.beginPath(),e.setLineDash([5,15]),e.moveTo(g,x),x=a,e.lineTo(g,x),e.stroke(),e.setLineDash([])}void 0!==this.m_transfFuncCallback&&void 0!==this.m_transfFuncUpdateCallback&&this.m_transfFunc.render(e,r,o,m,l)}}},{key:"forceRender",value:function(){this.setState({state:this.state}),void 0!==this.m_transfFuncCallback&&this.m_transfFuncCallback(this.m_transfFunc)}},{key:"render",value:function(){if(null===this.props.volume)return r.a.createElement("p",null)}}]),i}(r.a.Component),kt=function(){function e(){Object(f.a)(this,e),this.m_littleEndian=!0,this.m_header={m_id:"",m_endianness:0,m_glType:0,m_glTypeSize:0,m_glFormat:0,m_glInternalFormat:0,m_glBaseInternalFormat:0,m_pixelWidth:0,m_pixelHeight:0,m_pixelDepth:0,m_numberOfArrayElements:0,m_numberOfFaces:0,m_numberOfMipmapLevels:0,m_bytesOfKeyValueData:0},this.m_xDim=0,this.m_yDim=0,this.m_zDim=0,this.m_boxSize={x:0,y:0,z:0}}return Object(v.a)(e,[{key:"readIntFromBuffer",value:function(e,t){return this.m_littleEndian?e[t+0]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24:e[t+3]|e[t+2]<<8|e[t+1]<<16|e[t+0]<<24}},{key:"readShortFromBuffer",value:function(e,t){return this.m_littleEndian?e[t+0]|e[t+1]<<8:e[t+1]|e[t+0]<<8}},{key:"readFloatFromBuffer",value:function(e,t){var i=new ArrayBuffer(4),n=new DataView(i);return n.setUint8(0,e[t+0]),n.setUint8(1,e[t+1]),n.setUint8(2,e[t+2]),n.setUint8(3,e[t+3]),n.getFloat32(0,this.m_littleEndian)}},{key:"readFromBuffer",value:function(e,t,i,n){var r=new Uint8Array(t),s=r.length;if(s<8)return n&&n(wt.ERROR_TOO_SMALL_DATA_SIZE,null,0,null),!1;if(s>=241172480)return n&&n(wt.ERROR_TOO_LARGE_DATA_SIZE,null,0,null),!1;var o=348;if(s<o)return console.log("Nifti header too small"),n&&n(wt.BAD_HEADER,null,0,null),!1;console.log("Nifti loader. Start parse ".concat(s," bytes..."));var a=0,m=this.readIntFromBuffer(r,a);if(m>2<<24&&(this.m_littleEndian=!1,m=this.readIntFromBuffer(r,a)),a+=4,m!==o)return console.log("Nifti first int wrong: ".concat(m,", but should be ").concat(o)),n&&n(wt.BAD_HEADER,null,0,null),!1;a+=10,a+=18,a+=4,a+=2,a+=1,a+=1;var l=this.readShortFromBuffer(r,a);a+=2;if(l<3)return console.log("Nifti header wrong num dimensions: ".concat(l,", but should be at least 3")),n&&n(wt.WRONG_HEADER_DIMENSIONS,null,0,null),!1;this.m_xDim=this.readShortFromBuffer(r,a),a+=2,this.m_yDim=this.readShortFromBuffer(r,a),a+=2,this.m_zDim=this.readShortFromBuffer(r,a),a+=2,a+=8,a+=4,a+=4,a+=4,a+=2;var h=this.readShortFromBuffer(r,a);a+=2;var u=this.readShortFromBuffer(r,a);a+=2;var c=256,d=512,_=0;if(_|=2===h,_|=4===h,_|=16===h,_|=h===c,!(_|=h===d))return console.log("Nifti header read. This data type (".concat(h,") is not supported")),n&&n(wt.WRONG_HEADER_DATA_TYPE,null,0,null),!1;if(!(8===u|16===u|32===u))return console.log("Nifti wrong bitPix: ".concat(u,", but should be 8,16 or 32")),n&&n(wt.WRONG_HEADER_BITS_PER_PIXEL,null,0,null),!1;a+=2,a+=4;var f=this.readFloatFromBuffer(r,a);a+=4;var v=this.readFloatFromBuffer(r,a);a+=4;var p=this.readFloatFromBuffer(r,a);a+=4,this.m_boxSize.x=this.m_xDim*f,this.m_boxSize.y=this.m_yDim*v,this.m_boxSize.z=this.m_zDim*p;if(this.m_boxSize.x<1e-5){this.m_boxSize.x=312,this.m_boxSize.y=312,this.m_boxSize.z=312}console.log("Nifti physic volume size: ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z));for(var g=r.slice(148,228),S="",x=!0,y=0;y<80&&x;y++)(x=g[y]>=20&&g[y]<255)&&(S=S.concat(String.fromCharCode(g[y])));if(!(110===r[(a=344)+0]&&43===r[a+1]&&49===r[a+2]))return console.log("Nifti hdr bad magic: ".concat(r[a+0],", ").concat(r[a+1],", ").concat(r[a+2])),n&&n(wt.WRONG_HEADER_MAGIC,null,0,null),!1;a+=4;var T,D=this.m_xDim*this.m_yDim*this.m_zDim,b=a,R=!1;for(T=29;T>=0&&!R;T--){1<<T<D&&(R=!0)}T++,(T-=3)<=0&&(T=1);var w,M,E=(1<<T)-1,A=0;if(M=0,4===h||h===d)for(w=0;w<D;w++){var I=this.readShortFromBuffer(r,b+M);if(M+=2,I>A&&(A=I),i&&0===(w&E)&&w>0)i(0+w/D*.5)}if(h===c||2===h)for(w=0;w<D;w++){var O=r[b+M];if(M++,O>A&&(A=O),i&&0===(w&E)&&w>0)i(0+w/D*.5)}if(16===h)for(w=0;w<D;w++){var X=this.readFloatFromBuffer(r,b+M),C=Math.floor(X)+1;if(M+=4,C>A&&(A=C),i&&0===(w&E)&&w>0)i(0+w/D*.5)}var P=new Float32Array(A+1);for(w=0;w<A+1;w++)P[w]=0;if(M=0,4===h||h===d)for(w=0;w<D;w++){var k=this.readShortFromBuffer(r,b+M);M+=2,P[k]++}if(16===h)for(w=0;w<D;w++){var F=Math.floor(this.readFloatFromBuffer(r,b+M));M+=4,P[F]++}if(h===c||2===h)for(w=0;w<D;w++){var U=r[b+M];M++,P[U]++}var L=new Pt;L.assignArray(A,P);L.smoothHistogram(.8,!1);var N=L.getLastMaxIndex(4);N<4&&(N=A),console.log("LoaderNifti. get Last max peak: ".concat(N," / ").concat(L.m_numColors)),A=N;var z=255,V=D*(u/8),B=new Uint8Array(D),j=130560/A;if(j<=4)return console.log("Bad scaling: image will be 0"),n&&n(wt.ERROR_PROCESS_HISTOGRAM,null,0,null),!1;if(M=0,4===h||h===d)for(w=0;w<D;w++){var G=this.readShortFromBuffer(r,b+M);if(M+=2,G=(G=G*j>>9)<=z?G:z,B[w]=G,i&&0===(w&E)&&w>0)i(.5+w/D*.5)}if(h===c||2===h)for(w=0;w<D;w++){var W=r[b+M];if(M++,W=(W=W*j>>9)<=z?W:z,B[w]=W,i&&0===(w&E)&&w>0)i(.5+w/D*.5)}if(16===h)for(w=0;w<D;w++){var H=Math.floor(this.readFloatFromBuffer(r,b+M));if(M+=4,H=(H=H*j>>9)<=z?H:z,B[w]=H,i&&0===(w&E)&&w>0)i(.5+w/D*.5)}var Y,q,Z,K=this.m_xDim*this.m_yDim,Q=0*K,J=(this.m_zDim-1)*K;for(q=0;q<this.m_yDim;q++){var $=q*this.m_xDim;for(Y=0;Y<this.m_xDim;Y++){B[Q+$+Y]=0,B[J+$+Y]=0}}var ee=this.m_xDim-1;for(Z=0;Z<this.m_zDim;Z++){var te=Z*K;for(q=0;q<this.m_yDim;q++){B[te+q*this.m_xDim+0]=0,B[te+q*this.m_xDim+ee]=0}}var ie=(this.m_yDim-1)*this.m_xDim;for(Z=0;Z<this.m_zDim;Z++){var ne=Z*K;for(Y=0;Y<this.m_xDim;Y++){B[ne+0+Y]=0,B[ne+ie+Y]=0}}e.m_xDim=this.m_xDim,e.m_yDim=this.m_yDim,e.m_zDim=this.m_zDim;e.m_bytesPerVoxel=1,e.m_dataArray=B,e.m_dataSize=D,e.m_boxSize=this.m_boxSize,console.log("Nifti header read OK. Volume pixels = ".concat(this.m_xDim," * ").concat(this.m_yDim," * ").concat(this.m_zDim));var re=6403,se={m_pixelWidth:this.m_xDim,m_pixelHeight:this.m_yDim,m_pixelDepth:this.m_zDim,m_glType:5121,m_glTypeSize:1,m_glFormat:re,m_glInternalFormat:re,m_glBaseInternalFormat:re};return i&&i(1),n&&n(wt.SUCCESS,se,V,B),!0}},{key:"readFromUrl",value:function(e,t,i,n){var r=this;return console.log("LoadedNifti. staring read ".concat(t)),this.m_fileLoader=new Et(t),this.m_fileLoader.readFile((function(t){return r.readFromBuffer(e,t,i,n)}),(function(e){console.log("LoadedNifti. Error read file: ".concat(e)),n(wt.ERROR_CANT_OPEN_URL,null,0,null)})),!0}}]),e}(),Ft=function(){function e(){Object(f.a)(this,e),this.TAGS=[[2,0,"OB","FileMetaInfoGroupLength"],[2,1,"OB","FileMetaInformationVersion"],[2,2,"UI","MediaStoredSOPClassUID"],[2,3,"UI","MediaStoredSOPInstanceUID"],[2,16,"UI","TransferSyntaxUID"],[2,18,"UI","ImplementationClassUID"],[2,19,"UI","ImplementationVersionName"],[2,22,"UI","SourceApplicationEntityTitle"],[2,256,"UI","PrivateInformationCreatorUID"],[2,258,"UI","PrivateInformation"],[8,0,"UL","IdentifyingGroupLength"],[8,1,"UI","LengthToEnd"],[8,5,"CS","SpecificCharacterSet"],[8,6,"SQ","LanguageCodeSequence"],[8,8,"CS","ImageType"],[8,16,"SH","RecognitionCode"],[8,18,"DA","InstanceCreationDate"],[8,19,"TM","InstanceCreationTime"],[8,20,"UI","InstanceCreatorUID"],[8,22,"UI","SOPClassUID"],[8,24,"UI","SOPInstanceUID"],[8,26,"UI","RelatedGeneralSOPClassUID"],[8,27,"UI","OriginalSpecializedSOPClassUID"],[8,32,"DA","StudyDate"],[8,33,"DA","SeriesDate"],[8,34,"DA","AcquisitionDate"],[8,35,"DA","ContentDate"],[8,36,"DA","OverlayDate"],[8,37,"DA","CurveDate"],[8,42,"DT","AcquisitionDateTime"],[8,48,"TM","StudyTime"],[8,49,"TM","SeriesTime"],[8,50,"TM","AcquisitionTime"],[8,51,"TM","ContentTime"],[8,52,"TM","OverlayTime"],[8,53,"TM","CurveTime"],[8,64,"US","DataSetType"],[8,65,"LO","DataSetSubtype"],[8,66,"CS","NuclearMedicineSeriesType"],[8,80,"SH","AccessionNumber"],[8,81,"SQ","IssuerOfAccessionNumberSequence"],[8,82,"CS","QueryRetrieveLevel"],[8,84,"AE","RetrieveAETitle"],[8,86,"CS","InstanceAvailability"],[8,88,"UI","FailedSOPInstanceUIDList"],[8,96,"CS","Modality"],[8,112,"XX","Manufacturer"],[8,128,"XX","InstitutionName"],[8,129,"XX","InstitutionAddress"],[8,144,"XX","ReferringPhysicansName"],[8,4112,"XX","StationName"],[8,4144,"XX","StudyDescription"],[8,4158,"LO","SeriesDescription"],[8,4160,"XX","InstitutionDepartmentName"],[8,4176,"XX","PerformingPhysicansName"],[8,4192,'"XX','"Unkown'],[8,4224,"XX","AdmittingDiagnosesDescription"],[8,4240,"XX","ManufacturterModelName"],[8,4369,"XX","ReferencedPerformedProcStepSeq"],[8,4416,"XX","ReferencedImageSequence"],[8,4432,"UI","ReferencedSOP\u200bClassUID"],[8,4437,"UI","ReferencedSOP\u200bInstanceUID"],[8,8465,'"XX','"DerivationDescription'],[8,8466,'"XX','"SourceImageSequence'],[9,16,"LO","PrivateCreator"],[9,17,"??",'"Unknown'],[9,18,"??",'"Unknown'],[9,4097,"XX","PrivateTag"],[9,4098,"XX","PrivateTag"],[9,4100,"XX","PrivateTag"],[9,4135,"XX","PrivateTag"],[9,4144,"XX","PrivateTag"],[9,4145,"XX","PrivateTag"],[9,4323,"XX","PrivateTag"],[9,4329,"XX","PrivateTag"],[16,0,"UL","PatientGroupLength"],[16,16,"PN","PatientName"],[16,32,"LO","PatientID"],[16,33,"LO","IssuerOfPatientID"],[16,34,"CS","TypeOfPatientID"],[16,36,"SQ","IssuerOfPatientIDQualifiersSequence"],[16,48,"DA","PatientBirthDate"],[16,50,"TM","PatientBirthTime"],[16,64,"CS","PatientGender"],[16,80,"SQ","PatientInsurancePlanCodeSequence"],[16,257,"SQ","PatientPrimaryLanguageCodeSequence"],[16,258,"SQ","PatientPrimaryLanguageModifierCodeSequence"],[16,4096,"LO","OtherPatientIDs"],[16,4097,"PN","OtherPatientNames"],[16,4098,"SQ","OtherPatientIDsSequence"],[16,4101,"PN","PatientBirthName"],[16,4112,"AS","PatientAge"],[16,4128,"DS","PatientSize"],[16,4129,"SQ","PatientSizeCodeSequence"],[16,4144,"DS","PatientWeight"],[16,4160,"LO","PatientAddress"],[16,4176,"LO","InsurancePlanIdentification"],[16,4192,"PN","PatientMotherBirthName"],[16,4224,"LO","MilitaryRank"],[16,4225,"LO","BranchOfService"],[16,4240,"LO","MedicalRecordLocator"],[16,8192,"LO","MedicalAlerts"],[16,8464,"LO","Allergies"],[16,8528,"LO","CountryOfResidence"],[16,8530,"LO","RegionOfResidence"],[16,8532,"SH","PatientTelephoneNumbers"],[16,8544,"SH","EthnicGroup"],[16,8576,"SH","Occupation"],[16,8608,"CS","SmokingStatus"],[16,8624,"LT","AdditionalPatientHistory"],[16,8640,"US","PregnancyStatus"],[16,8656,"DA","LastMenstrualDate"],[16,8688,"LO","PatientReligiousPreference"],[16,8705,"LO","PatientSpeciesDescription"],[16,8706,"SQ","PatientSpeciesCodeSequence"],[16,8707,"CS","PatientSexNeutered"],[16,8720,"CS","AnatomicalOrientationType"],[16,8850,"LO","PatientBreedDescription"],[16,8851,"SQ","PatientBreedCodeSequence"],[16,8852,"SQ","BreedRegistrationSequence"],[16,8853,"LO","BreedRegistrationNumber"],[16,8854,"SQ","BreedRegistryCodeSequence"],[16,8855,"PN","ResponsiblePerson"],[16,8856,"CS","ResponsiblePersonRole"],[16,8857,"LO","ResponsibleOrganization"],[16,16384,"LT","PatientComments"],[16,37937,"FL","ExaminedBodyThickness"],[24,0,"UL","AcquisitionGroupLength"],[24,32,"XX","ScanningSequence"],[24,33,"XX","SequenceVariant"],[24,34,"XX","ScanOptions"],[24,35,"XX","MrAcquisionType"],[24,36,"??",'"SequenceName'],[24,37,"XX","AngioFlag"],[24,80,"XX","SliceThickness"],[24,96,"DS","KVP"],[24,128,"XX","RepetitionTime"],[24,129,"XX","EchoTime"],[24,130,"XX","InversionTime"],[24,131,"XX","NumberOfAverages"],[24,132,"XX","ImagingFrequency"],[24,133,"XX","ImagedNucleus"],[24,134,"XX","EchoNumber"],[24,135,"XX","MagneticFieldStrength"],[24,136,"XX","SpacingBetweenSlices"],[24,137,"XX","NumberOfPhaseEncodingSteps"],[24,144,"XX","DataCollectionDiameter"],[24,145,"XX","EchoTrainLength"],[24,147,"XX","ProcentSampling"],[24,148,"XX","ProcentPhaseFieldOfView"],[24,149,"XX","PixelBandwidth"],[24,4096,"XX","DeviceSerialNumber"],[24,4098,"??","DeviceUID"],[24,4099,"??","DeviceID"],[24,4100,"??","PlateID"],[24,4101,"??","GeneratorID"],[24,4102,"??","GridID"],[24,4103,"??",'"CassetteID'],[24,4104,"??","GantryID"],[24,4112,"??","SecondaryCaptureDeviceID"],[24,4113,"??","HardcopyCreationDeviceID"],[24,4114,"??","DateOfSecondaryCapture"],[24,4116,"??","TimeOfSecondaryCapture"],[24,4118,"??","SecondaryCaptureDeviceManufacturer"],[24,4119,"??","HardcopyDeviceManufacturer"],[24,4120,"??","SecondaryCaptureDeviceModelName"],[24,4121,"??","SecondaryCaptureDeviceSoftwareVers"],[24,4122,"??","HardcopyDeviceSoftwareVersion"],[24,4123,"??","HardcopyDeviceModelName"],[24,4128,"XX","SoftwareVersions"],[24,4144,"XX","ProtocolName"],[24,4225,"XX",'"LowR-RValue'],[24,4226,"XX",'"HiR-RValue'],[24,4227,"XX",'"IntervalsAcquired'],[24,4228,"XX",'"IntervalsRejected'],[24,4232,"XX","HeartRate"],[24,4240,"XX","CardiacNumberOfImages"],[24,4244,"XX","TriggerWindow"],[24,4352,"XX","ReconstructionDiameter"],[24,4368,"XX","DistanceSourceToDetector"],[24,4369,"XX","DistanceSourceToPatient"],[24,4373,"XX","Unknown"],[24,4384,"XX","GantryDetectorTilt"],[24,4400,"XX","TableHeight"],[24,4416,"XX","RotationDirection"],[24,4432,"XX","ExposureTime"],[24,4433,"XX","XRayTubeCurrent"],[24,4434,"XX","Exposure"],[24,4446,"XX",'"Unknown'],[24,4448,"XX","FilterType"],[24,4452,"XX",'"unknown'],[24,4454,"XX",'"unknown'],[24,4456,"XX",'"unknown'],[24,4464,"XX","GeneratorPower"],[24,4480,"XX",'"Unknown'],[24,4496,"XX","FocalSpot"],[24,4624,"XX","ConvolutionKernel"],[24,4688,"XX","ReceiveCoilName"],[24,4880,"XX","AcquisionMatrix"],[24,4882,"XX","InPlanePhaseEncodingDirection"],[24,4884,"XX","FlipAngle"],[24,4885,"XX","VariableFlipAngleFlag"],[24,4886,"XX","SAR"],[24,5120,"XX","unknown"],[24,5632,"XX",'"ShutterShape'],[24,5634,"XX","ShutterLeftVerticalEdge"],[24,5636,"XX",'"ShutterRightVerticalEdge'],[24,5638,"XX",'"ShutterUpperHorizontalEdge'],[24,5640,"XX",'"ShutterLowerHorizontalEdge'],[24,5648,"XX",'"CenterOfCircularShutter'],[24,5650,"XX",'"RadiusOfCircularShutter'],[24,5664,"XX",'"VerticesOfPolygonalShutter'],[24,5666,"XX",'"ShutterPresentationValue'],[24,5667,"XX",'"ShutterOverlayGroup'],[24,5668,"XX",'"ShutterPresentationColorCIELabVal'],[24,5888,"XX","Unknown"],[24,5890,"XX","Unknown"],[24,5892,"XX","Unknown"],[24,5894,"XX","Unknown"],[24,5896,"XX","Unknown"],[24,16384,"XX",'"AcquisitionComments'],[24,20480,"XX","OutputPower"],[24,20512,"XX","Unknown"],[24,20513,"XX",'"Unknown'],[24,20736,"XX","PatientPosition"],[24,20737,"XX","ViewPosition"],[24,24576,"XX","Unknown"],[24,37633,"XX","CTAcquisitionTypeSequence"],[24,37634,"XX","AcquisitionType"],[24,37635,"XX","TubeAngle"],[24,37636,"XX","CTAcquisitionDetailsSequence"],[24,37637,"XX","RevolutionTime"],[24,37638,"XX","SingleCollimationWidth"],[24,37639,"XX","TotalCollimationWidth"],[24,37640,"XX","CTTableDynamicsSequence"],[24,37641,"XX","TableSpeed"],[24,37648,"XX","TableFeedPerRotation"],[24,37649,"XX","SpiralPitchFactor"],[24,37650,"XX","CTGeometrySequence"],[24,37651,"XX","DataCollectionCenterPatient"],[24,37652,"XX","CTReconstructionSequence"],[24,37653,"XX","ReconstructionAlgorithm"],[24,37654,"XX","ConvolutionKernelGroup"],[24,37655,"XX","ReconstructionFieldOfView"],[24,37656,"XX","ReconstructionTargetCenterPatient"],[24,37657,"XX","ReconstructionAngle"],[24,37664,"XX","ImageFilter"],[24,37665,"XX","CTExposureSequenc"],[24,37666,"XX","ReconstructionPixelSpacing"],[24,37667,"XX","ExposureModulationType"],[24,37668,"XX","EstimatedDoseSaving"],[24,37669,"XX","CTXRayDetailsSequence"],[24,37670,"XX","CTPositionSequence"],[24,37671,"XX","TablePosition"],[24,37672,"XX","ExposureTimeInMilliSec"],[24,37673,"XX","CTImageFrameTypeSequence"],[24,37680,"XX","XRayTubeCurrentInMilliAmps"],[25,16,"LO","PrivateCreator"],[25,4098,"XX","NumberOfCellsInDetector"],[25,4099,"XX","CellsNumberAtTheta"],[25,4100,"XX","CellsSpacing"],[25,4111,"XX","HorizFrameOfRef"],[25,4113,"XX","SeriesContrast"],[25,4114,"XX","LastPSeq"],[25,4115,"XX","StartNumberOfBaseLine"],[25,4116,"XX","EndNumberOfBaseLine"],[25,4117,"XX","StartNumberForEnchancedScans"],[25,4118,"XX","EndNumberForEnchancedScans"],[25,4119,"XX","SeriesPlane"],[25,4120,"XX","FirstScanRas"],[25,4121,"XX","FirstScanLocation"],[25,4122,"XX","LastScanRas"],[25,4123,"XX","LastScanLoc"],[25,4126,"XX","DisplayFieldOfView"],[25,4131,"XX","TableSpeed"],[25,4132,"XX","MidScanTime"],[25,4133,"XX","MidScanFlag"],[25,4134,"XX","DegreesOfAzimuth"],[25,4135,"XX","GantryPeriod"],[25,4138,"XX","XRayOnPosition"],[25,4139,"XX","XRayOffPosition"],[25,4140,"XX","NumberOfTriggers"],[25,4142,"XX","AngleOfFirstView"],[25,4143,"XX","TriggerFrequency"],[25,4153,"XX","ScanFovType"],[25,4160,"XX","StatReconFlag"],[25,4161,"XX","ComputeType"],[25,4162,"XX","SegmentNumber"],[25,4163,"XX","TotalSegmentsRequested"],[25,4164,"XX","InterscanDelay"],[25,4167,"XX","ViewCompressionFactor"],[25,4170,"XX","TotalNoOfRefChannels"],[25,4171,"XX","DataSizeForScanData"],[25,4178,"XX","ReconPostProcflag"],[25,4183,"XX","CTWaterNumber"],[25,4184,"XX","CTBoneNumber"],[25,4186,"XX","AcquisitionDuration"],[25,4190,"XX","NumberOfChannels"],[25,4191,"XX","IncrementBetweenChannels"],[25,4192,"XX","StartingView"],[25,4193,"XX","NumberOfViews"],[25,4194,"XX","IncrementBetweenViews"],[25,4202,"XX","DependantOnNoViewsProcessed"],[25,4221,"DS","SecondEcho"],[25,4222,"SS","NumberOfEchoes"],[25,4223,"DS","TableDelta"],[25,4225,"SS","Contiguous"],[25,4228,"DS","PeakSAR"],[25,4231,"DS","CardiacRepetitionTime"],[25,4232,"SS","ImagesPerCardiacCycle"],[25,4234,"SS","ActualReceiveGainAnalog"],[25,4235,"SS","ActualReceiveGainDigital"],[25,4237,"DS","DelayAfterTrigger"],[25,4239,"SS","Swappf"],[25,4240,"SS","PauseInterval"],[25,4241,"DS","PulseTime"],[25,4242,"SL","SliceOffsetOnFreqAxis"],[25,4243,"DS","CenterFrequency"],[25,4244,"SS","TransmitGain"],[25,4245,"SS","AnalogReceiverGain"],[25,4246,"SS","DigitalReceiverGain"],[25,4247,"SL","BitmapDefiningCVs"],[25,4251,"SS","PulseSeqMode"],[25,4252,"LO","PulseSeqName"],[25,4253,"DT","PulseSeqDate"],[25,4254,"LO","InternalPulseSeqName"],[25,4255,"SS","TransmittingCoil"],[25,4256,"SS","SurfaceCoilType"],[25,4257,"SS","ExtremityCoilFlag"],[25,4258,"SL","RawDataRunNumber"],[25,4259,"UL","CalibratedFieldStrength"],[25,4260,"SS","SATFatWaterBone"],[25,4263,"DS","UserData01"],[25,4264,"DS","UserData02"],[25,4265,"DS","UserData03"],[25,4266,"DS","UserData04"],[25,4267,"DS","UserData05"],[25,4268,"DS","UserData06"],[25,4269,"DS","UserData07"],[25,4270,"DS","UserData08"],[25,4271,"DS","UserData09"],[25,4272,"DS","UserData10"],[25,4273,"DS","UserData11"],[25,4274,"DS","UserData12"],[25,4275,"DS","UserData13"],[25,4276,"DS","UserData14"],[25,4277,"DS","UserData15"],[25,4278,"DS","UserData16"],[25,4279,"DS","UserData17"],[25,4280,"DS","UserData18"],[25,4281,"DS","UserData19"],[25,4282,"DS","UserData20"],[25,4283,"DS","UserData21"],[25,4284,"DS","UserData22"],[25,4285,"DS","UserData23"],[25,4286,"DS","ProjectionAngle"],[25,4288,"SS","SaturationPlanes"],[25,4290,"SS","SATLocationR"],[25,4291,"SS","SATLocationL"],[25,4292,"SS","SATLocationA"],[25,4293,"SS","SATLocationP"],[25,4294,"SS","SATLocationH"],[25,4295,"SS","SATLocationF"],[25,4296,"SS","SATThicknessR-L"],[25,4297,"SS","SATThicknessA-P"],[25,4298,"SS","SATThicknessH-F"],[25,4299,"SS","PrescribedFlowAxis"],[25,4300,"SS","VelocityEncoding"],[25,4301,"SS","ThicknessDisclaimer"],[25,4302,"SS","PrescanType"],[25,4303,"SS","PrescanStatus"],[25,4306,"SS","ProjectionAlgorithm"],[25,4307,"SH","ProjectionAlgorithm"],[25,4309,"SS","FractionalEcho"],[25,4311,"SS","CardiacPhases"],[25,4312,"SS","VariableEchoflag"],[25,4313,"DS","ConcatenatedSAT"],[25,4319,"DS","UserData"],[25,4320,"DS","UserData"],[25,4322,"DS","VelocityEncodeScale"],[25,4338,"SS","FastPhases"],[25,4345,"DS","TransmissionGain"],[32,0,"UL","RelationshipGroupLength"],[32,13,"UI","StudyInstanceID"],[32,14,"UI","SeriesInstanceID"],[32,16,"IS","StudyID"],[32,17,"IS","SeriesNumber"],[32,18,"IS","AcquisionNumber"],[32,19,"IS","ImageNumber"],[32,32,"IS","PatientOrientation"],[32,50,"DS","ImagePosition"],[32,55,"DS","ImageOrientation"],[32,64,"XX","PositionReferenceIndicator"],[32,65,"XX","SliceLocation"],[32,82,"UI","FrameOfRefefernceID"],[32,96,"XX","Laterality"],[32,4098,"XX","ImagesInAcquision"],[32,4160,"LO","PositionReferenceIndicator"],[32,4161,"DS","SliceLocation"],[32,36950,"XX","StackId"],[32,36951,"XX","InStackPositionNumber"],[33,16,"LO","PrivateCreator"],[33,4099,"XX","SeriesFromWhichPrescribed"],[33,4101,"XX","GenesisVersionNow"],[33,4103,"XX","SeriesRecordChecksum"],[33,4120,"XX","GenesisVersionNow"],[33,4121,"XX","AcqreconRecordChecksum"],[33,4128,"XX","TableStartLocation"],[33,4149,"XX","SeriesFromWhichPrescribed"],[33,4150,"XX","ImageFromWhichPrescribed"],[33,4151,"XX","ScreenFormat"],[33,4170,"XX","AnatomicalReferenceForScout"],[33,4175,"XX","LocationsInAcquisition"],[33,4176,"XX","GraphicallyPrescribed"],[33,4177,"XX","RotationFromSourceXRot"],[33,4178,"XX","RotationFromSourceYRot"],[33,4179,"XX","RotationFromSourceZRot"],[33,4180,"XX","ImagePosition"],[33,4181,"XX","ImageOrientation"],[33,4182,"XX","IntegerSlop"],[33,4183,"XX","IntegerSlop"],[33,4184,"XX","IntegerSlop"],[33,4185,"XX","IntegerSlop"],[33,4186,"XX","IntegerSlop"],[33,4187,"XX","FloatSlop"],[33,4188,"XX","FloatSlop"],[33,4189,"XX","FloatSlop"],[33,4190,"XX","FloatSlop"],[33,4191,"XX","FloatSlop"],[33,4225,"XX","AutoWindowLevelAlpha"],[33,4226,"XX","AutoWindowLevelBeta"],[33,4227,"XX","AutoWindowLevelWindow"],[33,4228,"XX","ToWindowLevelLevel"],[33,4240,"XX","TubeFocalSpotPosition"],[33,4241,"XX","BiopsyPosition"],[33,4242,"XX","BiopsyTLocation"],[33,4243,"XX","BiopsyRefLocation"],[35,16,"LO","PrivateCreator"],[35,4097,"XX","NumberOfSeriesInStudy"],[35,4098,"XX","NumberOfUnarchivedSeries"],[35,4112,"XX","ReferenceImageField"],[35,4176,"XX","SummaryImage"],[35,4208,"XX","StartTimeSecsInFirstAxial"],[35,4212,"SL","NoofUpdatesToHeader"],[35,4221,"SS","IndicatesIfTheStudyHasCompleteInfo"],[35,4224,"LO","CRFilmFormat"],[37,16,"LO","PrivateCreator"],[37,4102,"SS","LastPulseSequenceUsed"],[37,4103,"SL","ImagesInSeries"],[37,4112,"SL","LandmarkCounter"],[37,4113,"SS","NumberOfAcquisitions"],[37,4116,"SL","IndicatesNoofUpdatesToHeader"],[37,4119,"SL","SeriesCompleteFlag"],[37,4120,"SL","NumberOfImagesArchived"],[37,4121,"SL","LastImageNumberUsed"],[37,4122,"SH","PrimaryReceiverSuiteAndHost"],[37,4123,"OB","ProtocolDataBlock"],[39,16,"LO","PrivateCreator"],[39,4102,"XX","ImageArchiveFlag"],[39,4112,"XX","ScoutType"],[39,4124,"XX","VmaMamp"],[39,4125,"XX","VmaPhase"],[39,4126,"XX","VmaMod"],[39,4127,"XX","VmaClip"],[39,4128,"XX","SmartScanOnOffFlag"],[39,4144,"XX","ForeignImageRevision"],[39,4145,"XX","ImagingMode"],[39,4146,"XX","PulseSequence"],[39,4147,"XX","ImagingOptions"],[39,4149,"XX","PlaneType"],[39,4150,"XX","ObliquePlane"],[39,4160,"XX","RASLetterOfImageLocation"],[39,4161,"XX","ImageLocation"],[39,4162,"XX","CenterRCoordOfPlaneImage"],[39,4163,"XX","CenterACoordOfPlaneImage"],[39,4164,"XX","CenterSCoordOfPlaneImage"],[39,4165,"XX","NormalRCoord"],[39,4166,"XX","NormalACoord"],[39,4167,"XX","NormalSCoord"],[39,4168,"XX","RCoordOfTopRightCorner"],[39,4169,"XX","ACoordOfTopRightCorner"],[39,4170,"XX","SCoordOfTopRightCorner"],[39,4171,"XX","RCoordOfBottomRightCorner"],[39,4172,"XX","ACoordOfBottomRightCorner"],[39,4173,"XX","SCoordOfBottomRightCorner"],[39,4176,"XX","TableStartLocation"],[39,4177,"XX","TableEndLocation"],[39,4192,"FL","ImageDimensionX"],[39,4193,"FL","ImageDimensionY"],[39,4194,"FL","NumberOfExcitations"],[40,0,"UL","ImagePresentationGroupLength"],[40,2,"US","SamplesPerPixel"],[40,4,"CS","PhotometricInterpretation"],[40,6,"US","Planar\u200bConfiguration"],[40,8,"XX","NumberOfFrames"],[40,16,"US","Rows"],[40,17,"US","Columns"],[40,48,"DS","PixelSpacing"],[40,256,"US","BitsAllocated"],[40,257,"US","BitsStored"],[40,258,"US","HighBit"],[40,259,"US","PixelRepresentation"],[40,262,"XX","SmallestImagePixelValue"],[40,263,"XX","LargestImagePixelValue"],[40,288,"US","PixelAddingValue"],[40,769,"CS","BurnderInAnnotation"],[40,771,"CS","Longitudinal\u200bTemporal\u200bInformation\u200bModified"],[40,4176,"DS","WindowCenter"],[40,4177,"DS","WindowWidth"],[40,4178,"DS","RescaleIntercept"],[40,4179,"DS","RescaleSlope"],[40,4180,"LO","RescaleType"],[40,4181,"LO","Window\u200bCenter\u200bWidth\u200bExplanation"],[41,16,"LO","PrivateCreator"],[41,4117,"SL","LowerRangeOfPixels1h"],[41,4118,"SL","LowerRangeOfPixels1i"],[41,4119,"SL","LowerRangeOfPixels2"],[41,4120,"SL","UpperRangeOfPixels2"],[41,4134,"SS","VersionOfTheHdrStruct"],[41,4145,"LO","PrivateTag"],[41,4146,"UL","PrivateTag"],[41,4147,"UL","PrivateTag"],[41,4148,"SL","AdvantageCompOverflow"],[41,4149,"SL","AdvantageCompUnderflow"],[50,0,"UL","StudyGroupLength"],[50,12,"XX","StrudyPriorityId"],[50,4128,"XX","ScheduledStudyLocation"],[50,4144,"XX","ReasonForStudy"],[50,4192,"XX","RequestedProcedureDescription"],[56,16,"XX","AdmissionId"],[56,80,"XX","SpecialNeeds"],[56,1280,"XX","PatientState"],[64,0,"UL","TextGroupLength"],[64,578,"XX","PerformedStationName"],[64,579,"XX","PerformedLocation"],[64,580,"XX","PerformedProcedureStepStartDate"],[64,581,"XX","PerformedProcedureStepStartTime"],[64,595,"XX","PerformedProcedureStepId"],[64,596,"XX","PerformedProcedureStepDescription"],[64,597,"LO","PerformedProcedureTypeDescription"],[64,640,"XX",'"CommentsOnPerformedProcedureStep'],[64,801,"XX","FilmConsumptionSequence"],[64,4097,"XX","RequestedProcedureId"],[64,4098,"XX","Unknown"],[64,4099,"XX","Unknown"],[64,4100,"XX","PatientTransportArrangments"],[64,4101,"XX","RequestedProcedureLocation"],[64,4112,"XX","NamesOfIntendentRecipientsOfResults"],[64,5120,"XX","RequestedProcedureComments"],[64,9216,"XX","ImagingServiceRequestComments"],[64,12289,"XX","Unknown"],[67,16,"LO","PrivateCreator"],[67,4097,"XX","BitmapOfPrescanOptions"],[67,4098,"XX","GradientOffsetInX"],[67,4099,"XX","GradientOffsetInY"],[67,4100,"XX","GradientOffsetInZ"],[67,4101,"XX","ImgIsOriginalOrUnoriginal"],[67,4102,"XX","NumberOfEPIShots"],[67,4103,"XX","ViewsPerSegment"],[67,4104,"XX","RespiratoryRateBpm"],[67,4105,"XX","RespiratoryTriggerPoint"],[67,4106,"XX","TypeOfReceiverUsed"],[67,4107,"XX","PeakRateOfChangeOfGradientField"],[67,4108,"XX","LimitsInUnitsOfPercent"],[67,4109,"XX","PSDEstimatedLimit"],[67,4110,"XX","PSDEstimatedLimitInTeslaPerSecond"],[67,4111,"XX","Saravghead"],[67,4112,"XX","WindowValue"],[67,4113,"XX","TotalInputViews"],[67,4114,"XX","XRayChain"],[67,4115,"XX","DeconKernelParameters"],[67,4116,"XX","CalibrationParameters"],[67,4117,"XX","TotalOutputViews"],[67,4118,"XX","NumberOfOverranges"],[67,4119,"XX","IBHImageScaleFactors"],[67,4120,"XX","BBHCoefficients"],[67,4121,"XX","NumberOfBBHChainsToBlend"],[67,4122,"XX","StartingChannelNumber"],[67,4123,"XX","PpscanParameters"],[67,4124,"XX","GEImageIntegrity"],[67,4125,"XX","LevelValue"],[67,4126,"XX","DeltaStartTime"],[67,4127,"XX","MaxOverrangesInAView"],[67,4128,"XX","AvgOverrangesAllViews"],[67,4129,"XX","CorrectedAfterGlowTerms"],[67,4133,"XX","ReferenceChannels"],[67,4134,"XX","NoViewsRefChansBlocked"],[67,4135,"XX","ScanPitchRatio"],[67,4136,"XX","UniqueImageIden"],[67,4137,"XX","HistogramTables"],[67,4138,"XX","UserDefinedData"],[67,4139,"XX","PrivateScanOptions"],[67,4140,"XX","EffectiveEchoSpacing"],[67,4141,"XX","StringSlopField1"],[67,4142,"XX","StringSlopField2"],[67,4143,"XX","RawDataType"],[67,4144,"XX","RawDataType"],[67,4145,"XX","RACordOfTargetReconCenter"],[67,4146,"XX","RawDataType"],[67,4147,"XX","NegScanspacing"],[67,4148,"XX","OffsetFrequency"],[67,4149,"XX","UserUsageTag"],[67,4150,"XX","UserFillMapMSW"],[67,4151,"XX","UserFillMapLSW"],[67,4152,"XX","User25_48"],[67,4153,"XX","SlopInt6_9"],[67,4160,"XX","TriggerOnPosition"],[67,4161,"XX","DegreeOfRotation"],[67,4162,"XX","DASTriggerSource"],[67,4163,"XX","DASFpaGain"],[67,4164,"XX","DASOutputSource"],[67,4165,"XX","DASAdInput"],[67,4166,"XX","DASCalMode"],[67,4167,"XX","DASCalFrequency"],[67,4168,"XX","DASRegXm"],[67,4169,"XX","DASAutoZero"],[67,4170,"XX","StartingChannelOfView"],[67,4171,"XX","DASXmPattern"],[67,4172,"XX","TGGCTriggerMode"],[67,4173,"XX","StartScanToXrayOnDelay"],[67,4174,"XX","DurationOfXrayOn"],[67,4192,"XX","SlopInt10_17"],[67,4193,"XX","ScannerStudyEntityUID"],[67,4194,"XX","ScannerStudyID"],[67,4207,"XX","ScannerTableEntry"],[67,4221,"US","ReconModeFlagWord "],[67,4224,"LO","CoilIDData"],[67,4225,"LO","GECoilName"],[67,4226,"LO","SystemConfigurationInformation"],[67,4227,"DS","AssetRFactors"],[67,4228,"LO","AdditionalAssetData"],[67,4233,"LO","GoverningBodyAndSARDefinition"],[67,4234,"CS","PrivateInPlanePhaseEncodingDirection"],[67,4240,"LO","SARDefinition"],[67,4241,"DS","SARValue"],[67,4245,"LO","PrescanReuseString"],[67,4246,"CS","ContentQualification"],[67,4247,"LO","ImageFilteringParameters"],[67,4250,"IS","RxStackIdentification"],[67,4266,"LO","AdditionalFilteringParameters"],[67,4273,"SS","ExcitationMode"],[69,16,"LO","PrivateCreator"],[69,4097,"XX","NumberOfMacroRowsInDetector"],[69,4098,"XX","MacroWidthAtISOCenter"],[69,4099,"XX","DASType"],[69,4100,"XX","DASGain"],[69,4102,"XX","TableDirectionInOrOut"],[69,4103,"XX","ZSmoothingFactor"],[69,4104,"XX","ViewWeightingMode"],[69,4105,"XX","SigmaRowNumberWhichRowsWereUsed"],[69,4106,"XX","MinimumDasValueFoundInTheScanData"],[69,4107,"XX","MaximumOffsetShiftValueUsed"],[69,4108,"XX","NumberOfViewsShifted"],[69,4109,"XX","ZTrackingFlag"],[69,4110,"XX","MeanZError"],[69,4111,"XX","ZTrackingMaximumError"],[69,4112,"XX","StartingViewForRow2a"],[69,4113,"XX","NumberOfViewsInRow2a"],[69,4114,"XX","StartingViewForRow1a"],[69,4115,"XX","SigmaMode"],[69,4116,"XX","NumberOfViewsInRow1a"],[69,4117,"XX","StartingViewForRow2b"],[69,4118,"XX","NumberOfViewsInRow2b"],[69,4119,"XX","StartingViewForRow1b"],[69,4120,"XX","NumberOfViewsInRow1b"],[69,4129,"XX","PrivateTag"],[69,4130,"XX","PrivateTag"],[69,4146,"XX","PrivateTag"],[83,16,"LO","PrivateCreator"],[83,4128,"XX","PrivateTag"],[83,4160,"XX","PrivateTag"],[83,4161,"XX","PrivateTag"],[83,4162,"XX","PrivateTag"],[83,4163,"XX","PrivateTag"],[83,4194,"XX","PrivateTag"],[136,320,"XX","StorageMediaFileSetUid"],[136,512,"XX","IconImageSequence"],[8193,4099,"XX","Unknown"],[8193,4106,"XX","Unknown"],[8193,4206,"XX","Unknown"],[8197,18,"XX","Unknown"],[8197,19,"XX","Unknown"],[8197,20,"XX","Unknown"],[8197,4627,"XX","Unknown"],[8197,5126,"XX","Unknown"],[21811,4611,"XX",'"Unknown'],[21811,21777,"XX",'"Unknown'],[32736,0,"IM","PixelDataGroupLength"],[32736,16,"IM","PixelData"]]}return Object(v.a)(e,[{key:"getVr",value:function(e,t){for(var i="",n=this.TAGS.length,r=0;r<n;r++)this.TAGS[r][0]===e&&this.TAGS[r][1]===t&&(i=this.TAGS[r][2]);return 0===t&&(i="UL"),i}},{key:"getTextDesc",value:function(e,t){for(var i="?",n=this.TAGS.length,r=0;r<n;r++)this.TAGS[r][0]===e&&this.TAGS[r][1]===t&&(i=this.TAGS[r][3]);return i}}]),e}(),Ut=function e(){Object(f.a)(this,e),this.m_patientName="",this.m_patientDateOfBirth="",this.m_studyDescr="",this.m_studyDate="",this.m_seriesTime="",this.m_seriesDescr="",this.m_bodyPartExamined="",this.m_institutionName="",this.m_operatorsName="",this.m_physicansName="",this.m_patientId="",this.m_patientGender="",this.m_acquisionTime="",this.m_manufacturerName="",this.m_sliceInfo=[]},Lt=[2,16],Nt=[2,0],zt=[32736,16],Vt=function(){function e(t,i,n,r,s,o,a,m){Object(f.a)(this,e),this.m_group=t,this.m_element=i,this.m_vr=n,this.m_value=r,this.m_offsetStart=s,this.m_offsetValue=o,this.m_offsetEnd=a,this.m_littleEndian=m}return Object(v.a)(e,[{key:"value",value:function(){return this.m_value}},{key:"isTransformSyntax",value:function(){return this.m_group===Lt[0]&&this.m_element===Lt[1]}},{key:"isMetaLength",value:function(){return this.m_group===Nt[0]&&this.m_element===Nt[1]}},{key:"isPixelData",value:function(){return this.m_group===zt[0]&&this.m_element===zt[1]}}]),e}(),Bt=function(){function e(){Object(f.a)(this,e)}return Object(v.a)(e,null,[{key:"getHash",value:function(e){for(var t=e.length,i=53*t,n=0;n<t;n++){i=(i*=137211941^e.charCodeAt(n))<<27|i>>5,i&=1073741823}return i}}]),e}(),jt=function(){function e(){Object(f.a)(this,e),this.m_image=null,this.m_sliceNumber=0,this.m_sliceLocation=0,this.m_patientName="",this.m_studyDescr="",this.m_studyDate="",this.m_seriesTime="",this.m_seriesDescr="",this.m_bodyPartExamined="",this.m_hash=0,this.m_xDim=0,this.m_yDim=0}return Object(v.a)(e,[{key:"buildHash",value:function(){var e=this.m_patientName+this.m_studyDescr+this.m_studyDate+this.m_seriesTime+this.m_seriesDescr+this.m_bodyPartExamined;this.m_hash=Bt.getHash(e)}}]),e}(),Gt=function(){function e(t){Object(f.a)(this,e),console.assert(void 0!==t),console.assert("number"===typeof t,"hash shold be number"),this.m_hash=t,this.m_slices=[],this.m_minSlice=555555555555.5,this.m_maxSlice=-555555555555.5}return Object(v.a)(e,[{key:"addSlice",value:function(e){console.assert(void 0!==e),console.assert(e instanceof jt,"added slice should be DicomSlice object"),this.m_slices.push(e),this.m_minSlice=e.m_sliceNumber<this.m_minSlice?e.m_sliceNumber:this.m_minSlice,this.m_maxSlice=e.m_sliceNumber>this.m_maxSlice?e.m_sliceNumber:this.m_maxSlice}}]),e}(),Wt=function(){function e(){Object(f.a)(this,e),this.m_series=[]}return Object(v.a)(e,[{key:"destroy",value:function(){this.m_series=[]}},{key:"getSeries",value:function(){return this.m_series}},{key:"addSlice",value:function(e){console.assert(void 0!==e),console.assert(e instanceof jt,"should be DicomSlice object"),console.assert(void 0!==e.m_hash),console.assert(0!==e.m_hash);var t=this.getSerieIndex(e);if(t<0){var i=new Gt(e.m_hash);this.m_series.push(i),t=this.m_series.length-1}this.m_series[t].addSlice(e)}},{key:"getSerieIndex",value:function(e){for(var t=this.m_series.length,i=0;i<t;i++){if(this.m_series[i].m_hash===e.m_hash)return i}return-1}}]),e}(),Ht=function e(){Object(f.a)(this,e),this.m_sliceName="",this.m_fileName="",this.m_tags=[]},Yt=function e(){Object(f.a)(this,e),this.m_tag="",this.m_attrName="",this.m_attrValue=""},qt=function(){function e(){Object(f.a)(this,e)}return Object(v.a)(e,[{key:"isValidUrl",value:function(e){var t=e.match(/^((ftp|http|https):\/\/)?(([\S]+)\.)?([\S]+)\.([A-z]{2,})(:\d{1,6})?\/[\S]+/),i=e.match(/(ftp|http|https):\/\/([\d]+)\.([\d]+)\.([\d]+)\.([\d]+)(:([\d]+))?\/([\S]+)/);return null!==t||null!==i}},{key:"getFileNameFromUrl",value:function(e){var t=e.lastIndexOf("/");if(t<0&&(t=e.lastIndexOf("\\")),t<0)return console.log("getFileNameFromUrl: wrong URL!"),"";var i=e.substring(t+1);return i=i.length<=40?i:i.substring(0,40)}},{key:"getFolderNameFromUrl",value:function(e){var t=e.lastIndexOf("/");return t<0&&(t=e.lastIndexOf("\\")),t<0?(console.log("getFolderNameFromUrl: wrong URL!"),""):e.substring(0,t)}},{key:"isUrlExists",value:function(e){var t=null;window.XMLHttpRequest&&(t=new XMLHttpRequest);t.open("GET",e,!0),t.send();return 404!==t.status}},{key:"encodeUrl",value:function(e){for(var t="",i=!1,n=e.length,r=0;r<n;r++){var s=e[r];if(i&&!("/"===s||"."===s||"-"===s||"_"===s)){var o=e.charCodeAt(r);t+=String.fromCharCode(o+1)}else t+=s;i="."===s||i}return t}},{key:"decodeUrl",value:function(e){for(var t="",i=!1,n=e.length,r=0;r<n;r++){var s=e[r];if(i&&!("/"===s||"."===s||"-"===s||"_"===s)){var o=e.charCodeAt(r);t+=String.fromCharCode(o-1)}else t+=s;i="."===s||i}return console.log("".concat(t)),t}}]),e}(),Zt=!1,Kt=[68,73,67,77],Qt=4294967295,Jt=1073741823,$t=[32,19],ei=[32736,16],ti=[40,256],ii=[40,16],ni=[40,17],ri=[40,258],si=[40,262],oi=[40,263],ai=[40,288],mi=[40,48],li=[40,4176],hi=[40,4177],ui=[40,4178],ci=[40,4179],di=[40,4180],_i=[40,259],fi=[32,50],vi=[32,4161],pi=[40,2],gi=[8,4158],Si=[8,49],xi=[65534,57357],yi=[65534,57565],Ti=[32,17],Di=[24,80],bi=[24,21],Ri="1.2.840.10008.1.2.4",wi="1.2.840.10008.1.2.4.57",Mi="1.2.840.10008.1.2.4.70",Ei="1.2.840.10008.1.2.4.50",Ai='"1.2.840.10008.1.2.4.51',Ii="1.2.840.10008.1.2.4.90",Oi="1.2.840.10008.1.2.4.91",Xi="1.2.840.10008.1.2.5",Ci=[16,16],Pi=[16,32],ki=[16,48],Fi=[16,64],Ui=[8,32],Li=[8,4144],Ni=[8,50],zi=[8,128],Vi=[8,144],Bi=[8,112],ji=[8,4208],Gi=function(){function e(t){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(f.a)(this,e),this.m_xDim=-1,this.m_yDim=-1,this.m_zDim=t,this.m_needScaleDownTexture=i,this.m_folder=null,this.m_isLoadedSuccessfull=!1,this.m_dataSize=0,this.m_dataArray=null,this.m_dictionary=new Ft,this.m_imageNumber=-1,this.m_errors=[],this.m_transformSyntax="",this.m_loaders=[],this.m_xDim=-1,this.m_yDim=-1,this.m_bitsPerPixel=-1,this.m_padValue=-1073741823,this.m_windowCenter=Jt,this.m_windowWidth=Jt,this.m_rescaleIntercept=0,this.m_rescaleSlope=1,this.m_rescaleHounsfield=!1,this.m_pixelRepresentaionSigned=!1,this.m_littleEndian=!0,this.m_samplesPerPixel=1,this.m_seriesNumber=-1,this.m_seriesDescr="",this.m_boxSize={x:1,y:1,z:1},this.m_nonEmptyBoxMin={x:0,y:0,z:0},this.m_nonEmptyBoxMax={x:1,y:1,z:1},this.m_slicesVolume=new Wt,this.m_newTagEvent=new CustomEvent("newTag",{detail:{group:null,element:null,desc:null,value:null,imageNumber:null,fileName:null}}),this.m_dicomInfo=new Ut,this.m_pixelSpacing={x:0,y:0,z:0},this.m_filesLoadedCounter=0,this.m_numLoadedFiles=t,this.m_imagePosMin={x:1e12,y:1e12,z:1e12},this.m_imagePosMax={x:-1e12,y:-1e12,z:-1e12},this.m_sliceLocMin=1e12,this.m_sliceLocMax=-1e12,this.runLoader=this.runLoader.bind(this)}return Object(v.a)(e,[{key:"getBoxSize",value:function(){return this.m_boxSize}},{key:"getNonEmptyBoxMin",value:function(){return this.m_nonEmptyBoxMin}},{key:"getNonEmptyBoxMax",value:function(){return this.m_nonEmptyBoxMax}},{key:"getDicomInfo",value:function(){return this.m_dicomInfo}},{key:"createVolumeFromSlices",value:function(e,t,i){console.assert(null!=e,"Null volume"),console.assert(e instanceof Yi,"Should be volume set"),console.assert("number"===typeof t,"index should be number"),console.assert("number"===typeof i,"index should be number");var n=null;t<e.getNumVolumes()?n=e.getVolume(t):(n=new Rt,e.addVolume(n),n=e.getVolume(t),console.assert(null!==n));for(var r=this.m_slicesVolume.m_series.length,s=-1,o=0;o<r;o++)if(this.m_slicesVolume.m_series[o].m_hash===i){s=o;break}console.assert(s>=0);var a=this.m_slicesVolume.m_series[s],m=a.m_slices[0],l=a.m_slices.length;this.m_xDim=m.m_xDim,this.m_yDim=m.m_yDim,this.m_zDim=a.m_slices.length;var h,u,c=this.m_xDim*this.m_yDim,d={x:this.m_imagePosMax.x-this.m_imagePosMin.x,y:this.m_imagePosMax.y-this.m_imagePosMin.y,z:this.m_imagePosMax.z-this.m_imagePosMin.z},_=1e-5;Math.abs(this.m_pixelSpacing.z)>_?h=this.m_pixelSpacing.z*this.m_zDim:(h=d.z,Math.abs(h)<_&&(h=d.x,Math.abs(h)<_&&(h=d.y))),h<_&&(h=1),this.m_pixelSpacing.x*this.m_pixelSpacing.y<_&&(this.m_pixelSpacing.x=1,this.m_pixelSpacing.y=1),this.m_pixelSpacing.z=h/this.m_zDim,this.m_boxSize.z=this.m_zDim*this.m_pixelSpacing.z,this.m_boxSize.x=this.m_xDim*this.m_pixelSpacing.x,this.m_boxSize.y=this.m_yDim*this.m_pixelSpacing.y,console.log("createVolumeFromSlices. Volume local phys dim: ".concat(this.m_boxSize.x," * ").concat(this.m_boxSize.y," * ").concat(this.m_boxSize.z));var f,v=null;if(!this.m_littleEndian)for(var p=0;p<r;p++){var g=this.m_slicesVolume.m_series[p];if(g.m_hash===i)for(var S=0;S<l;S++){var x=g.m_slices[S],y=x.m_image;for(c=x.m_xDim*x.m_yDim,u=0;u<c;u++){var T=y[u];y[u]=T>>8|T<<8&65535}}}for(var D=0;D<r;D++){var b=this.m_slicesVolume.m_series[D];if(b.m_hash===i)for(var R=0;R<l;R++){var w=b.m_slices[R];for(c=w.m_xDim*w.m_yDim,u=0;u<c;u++){var M=w.m_image[u];M===this.m_padValue&&(M=0),w.m_image[u]=M}}}for(var E=-1073741823,A=1073741823,I=0;I<r;I++){var O=this.m_slicesVolume.m_series[I];if(O.m_hash===i)for(var X=0;X<l;X++){var C=O.m_slices[X],P=C.m_image;for(c=C.m_xDim*C.m_yDim,u=0;u<c;u++){var k=P[u]*this.m_rescaleSlope+this.m_rescaleIntercept;A=k<A?k:A,E=k>E?k:E}}}console.log("Build Volume. min/max value=".concat(A,"/").concat(E,". Volume dim = ").concat(this.m_xDim,"*").concat(this.m_yDim,"*").concat(this.m_zDim)),console.log("Min slice number = ".concat(a.m_minSlice)),console.log("Max slice number = ".concat(a.m_maxSlice)),E=E-A>0?E:E+1;var F=Math.floor((1<<19)/(E-A));if(F<=4)return console.log("Bad scaling: image will be 0"),wt.ERROR_SCALING;var U=a.m_slices,L=a.m_maxSlice-a.m_minSlice+1;L!==l&&console.log("Sort by location! N slices by tags = ".concat(L,", but N readed slices = ").concat(l));for(var N=U[0].m_sliceNumber,z=U[0].m_sliceNumber,V=0;V<l;V++){var B=U[V].m_sliceNumber;N=B<N?B:N,z=B>z?B:z}z-N>0?U.sort((function(e,t){return e.m_sliceNumber-t.m_sliceNumber})):U.sort((function(e,t){return e.m_sliceLocation-t.m_sliceLocation}));for(var j=0,G=0;G<l;G++)U[G].m_sliceNumber=j,j++;if(this.m_zDim=l,f=this.m_xDim*this.m_yDim*this.m_zDim,null===(v=new Uint8Array(f)))return console.log("no memory"),wt.ERROR_NO_MEMORY;for(u=0;u<f;u++)v[u]=0;for(var W=0;W<l;W++){var H=U[W];c=H.m_xDim*H.m_yDim;var Y=H.m_image,q=H.m_sliceNumber;if(q>=a.m_slices.length&&((q=H.m_sliceNumber-a.m_minSlice)<0||q>=this.m_zDim))return console.log("Invalid z slice reference"),wt.ERROR_INVALID_SLICE_INDEX;if(null!==Y){var Z=q*c;if(this.m_windowCenter!==Jt&&this.m_windowWidth!==Jt){var K=this.m_windowCenter-.5*this.m_windowWidth;for(u=0;u<c;u++){var Q=Y[u]*this.m_rescaleSlope+this.m_rescaleIntercept,J=0;J=(J=(J=this.m_rescaleHounsfield?Math.floor(255*(Q-K)/this.m_windowWidth):Math.floor(127+128*(Q-this.m_windowCenter)/(this.m_windowWidth/2)))>=0?J:0)<255?J:255,v[Z+u]=J}}else for(u=0;u<c;u++){var $=(Y[u]*this.m_rescaleSlope+this.m_rescaleIntercept-A)*F>>11;$=$<=255?$:255,v[Z+u]=$}}}var ee=this.m_xDim*this.m_yDim*this.m_zDim;if(this.m_needScaleDownTexture&&ee>67108864){var te=512,ie=this.m_xDim<=te?this.m_xDim:te,ne=this.m_yDim<=te?this.m_yDim:te;v=VolumeTools.scaleTextureDown(this,v,ie,ne,120),c=this.m_xDim*this.m_yDim,console.log("Volume scaled down to: ".concat(ie," * ").concat(ne," * ").concat(120,"."))}if(this.m_zDim>4){var re,se,oe,ae,me,le=(oe=0)*this.m_xDim*this.m_yDim,he=(oe=this.m_zDim-1)*this.m_xDim*this.m_yDim;for(se=0;se<this.m_yDim;se++)for(ae=se*this.m_xDim,re=0;re<this.m_xDim;re++)v[le+ae+re]=0,v[he+ae+re]=0;var ue=re=0,ce=re=this.m_xDim-1;for(oe=0;oe<this.m_zDim;oe++)for(me=oe*this.m_xDim*this.m_yDim,se=0;se<this.m_yDim;se++)v[me+(ae=se*this.m_xDim)+ue]=0,v[me+ae+ce]=0;var de=(se=0)*this.m_xDim,_e=(se=this.m_yDim-1)*this.m_xDim;for(oe=0;oe<this.m_zDim;oe++)for(me=oe*this.m_xDim*this.m_yDim,re=0;re<this.m_xDim;re++)v[me+re+de]=0,v[me+re+_e]=0}var fe=6403,ve={m_pixelWidth:this.m_xDim,m_pixelHeight:this.m_yDim,m_pixelDepth:this.m_zDim,m_glType:5121,m_glTypeSize:1,m_glFormat:fe,m_glInternalFormat:fe,m_glBaseInternalFormat:fe},pe=this.m_callbackComplete;pe&&pe(wt.SUCCESS,ve,f,v);return n.m_xDim=this.m_xDim,n.m_yDim=this.m_yDim,n.m_zDim=this.m_zDim,n.m_dataArray=v,n.m_dataSize=f,n.m_bytesPerVoxel=1,n.m_boxSize.x=this.m_boxSize.x,n.m_boxSize.y=this.m_boxSize.y,n.m_boxSize.z=this.m_boxSize.z,n.m_patientName=this.m_dicomInfo.m_patientName,n.m_patientBirth=this.m_dicomInfo.m_patientDateOfBirth,n.m_seriesDescr=this.m_dicomInfo.m_seriesDescr,n.m_studyDescr=this.m_dicomInfo.m_studyDescr,n.m_studyDate=this.m_dicomInfo.m_studyDate,n.m_seriesTime=this.m_dicomInfo.m_seriesTime,n.m_bodyPartExamined=this.m_dicomInfo.m_bodyPartExamined,n.m_institutionName=this.m_dicomInfo.m_institutionName,n.m_operatorsName=this.m_dicomInfo.m_operatorsName,n.m_physicansName=this.m_dicomInfo.m_physicansName,n.createIcon(),wt.SUCCESS}},{key:"getNextTag",value:function(t,i){if(i>=t.byteLengh)return null;var n=!0,r=0,s=0,o=0,a=i,m="";this.m_metaFinished?(n=this.m_littleEndian,r=t.getUint16(i,n)):(r=t.getUint16(i,1),-1!==this.m_metaFinishedOffset&&i>=this.m_metaFinishedOffset||2!==r?(this.m_metaFinished=1,n=this.m_littleEndian,r=t.getUint16(i,n)):n=!0),this.m_metaFound||2!==r||(this.m_metaFound=!0),i+=2,s=t.getUint16(i,n),i+=2,this.m_explicit||!this.m_metaFinished?(m=e.getStringAt(t,i,2),!this.m_metaFound&&this.m_metaFinished&&-1===e.getVrsStringIndex(m)?(m=Ft.getVr(r,s),o=t.getUint32(i,n),i+=4,this.m_explicit=!1):(i+=2,-1!==e.getDataVrsStringIndex(m)?(i+=2,o=t.getUint32(i,n),i+=4):(o=t.getUint16(i,n),i+=2))):(m=this.m_dictionary.getVr(r,s),(o=t.getUint32(i,n))===Qt&&(m="SQ"),i+=4);var l=i,h=null;if("SQ"===m){if(o===Qt){for(var u=0,c=0;u!==yi[0]||c!==yi[1];){u=t.getUint16(i,n),i+=2,c=t.getUint16(i,n),i+=2;var d=t.getUint32(i,n);if(i+=4,d===Qt){for(;!(u===xi[0]&&c===xi[1]||u===yi[0]&&c===yi[1]);){i=this.getNextTag(t,i).m_offsetEnd,u=t.getUint16(i,n),c=t.getUint16(i+2,n)}i+=8}else i+=d}o=0}}else o>0&&(o===Qt&&r===ei[0]&&s===ei[1]&&(o=t.byteLength-i),h=t.buffer.slice(i,i+o));if(4294967295===o)return null;var _=new Vt(r,s,m,h,a,l,i+=o,this.m_littleEndian);if(_&&(this.m_newTagEvent.detail.group=r.toString(16),this.m_newTagEvent.detail.element=s.toString(16),this.m_newTagEvent.detail.desc=this.m_dictionary.getTextDesc(r,s),this.m_newTagEvent.detail.value=e.getAttrValueAsString(_),this.m_newTagEvent.detail.imageNumber=r===$t[0]&&s===$t[1]?parseInt(this.m_newTagEvent.detail.value,10):-1,dispatchEvent(this.m_newTagEvent)),_.isTransformSyntax()){var f=_.m_value.byteLength,v=new DataView(_.m_value),p=e.getStringAt(v,0,f);"1.2.840.10008.1.2"===p?(this.m_explicit=!1,this.m_littleEndian=!0):"1.2.840.10008.1.2.2"===p?(this.m_explicit=!0,this.m_littleEndian=!1):"1.2.840.10008.1.2.1.99"===p?(this.m_needsDeflate=!0,this.m_explicit=!0,this.m_littleEndian=!0):p==Ri?this.m_transformSyntax=Ri:p==Mi?this.m_transformSyntax=Mi:p==wi?this.m_transformSyntax=wi:p==Ei?this.m_transformSyntax=Ei:p==Ai?this.m_transformSyntax=Ai:p==Ii?this.m_transformSyntax=Ii:p==Oi?this.m_transformSyntax=Oi:p==Xi?this.m_transformSyntax=Xi:(this.m_explicit=!0,this.m_littleEndian=!0)}else _.isMetaLength()&&(this.m_metaFinishedOffset=_.m_value[0]+i);return _}},{key:"readFromGoogleBuffer",value:function(t,i,n,r,s,o){var a=new DataView(r),m=(a.byteLength,e.getStringAt(a,64,32));if("Content-Type: application/dicom;"===m){var l=r.slice(136);new DataView(l);return this.readFromBuffer(t,i,n,l,s,o)}return console.log("readFromGoogleBuffer. bad content type = ".concat(m)),wt.BAD_HEADER}},{key:"readFromBuffer",value:function(t,i,n,r,s,o){"number"!==typeof t&&console.log("LoaderDicom.readFromBuffer: bad indexFile argument"),"string"!==typeof i&&console.log("LoaderDicom.readFromBuffer: bad fileName argument"),"object"!==typeof r&&console.log("LoaderDicom.readFromBuffer: bad arrBuf argument");var a=this.m_dicomInfo,m=new Ht,l="Slice "+t.toString();m.m_sliceName=l,m.m_fileName=i,m.m_tags=[],a.m_sliceInfo.push(m);var h=new DataView(r);if(null===h)return console.log("No memory"),wt.ERROR_NO_MEMORY;if(h.byteLength<144)return this.m_error=wt.ERROR_TOO_SMALL_DATA_SIZE,void 0!==o&&o(wt.ERROR_TOO_SMALL_DATA_SIZE),wt.ERROR_TOO_SMALL_DATA_SIZE;for(var u=0;u<4;u++){if(h.getUint8(128+u)!==Kt[u])return this.m_errors[t]=-1,console.log("Dicom readFromBuffer. Wrong header in file: ".concat(i)),void 0!==o&&o(wt.WRONG_HEADER_MAGIC),wt.WRONG_HEADER_MAGIC}var c=128;c+=4,this.m_littleEndian=!0,this.m_explicit=!0,this.m_metaFound=!1,this.m_metaFinished=!1,this.m_metaFinishedOffset=-1,this.m_needsDeflate=!1,this.m_imageNumber=-1,this.m_xDim=-1,this.m_yDim=-1,this.m_bitsPerPixel=-1,this.m_windowCenter=-1,this.m_windowWidth=-1;var d,_=0,f=0,v=!1;for(d=this.getNextTag(h,c);null!==d;){if(d.isPixelData()){v=!0;break}if(c=d.m_offsetEnd,null===(d=this.getNextTag(h,c)))break;var p=this.m_dicomInfo,g=p.m_sliceInfo.length,S=p.m_sliceInfo[g-1],x=new Yt;x.m_tag="("+e.numberToHexString(d.m_group)+","+e.numberToHexString(d.m_element)+")";var y=this.m_dictionary.getTextDesc(d.m_group,d.m_element);x.m_attrName=y.length>1?y:"";var T=e.getAttrValueAsString(d);if(T=null!==T?T:"",x.m_attrValue=T,S.m_tags.push(x),d.m_group===$t[0]&&d.m_element===$t[1]){var D=d.m_value.byteLength,b=new DataView(d.m_value),R=e.getStringAt(b,0,D);this.m_imageNumber=parseInt(R,10)-1}if(d.m_group===ii[0]&&d.m_element===ii[1]){var w=d.m_value.byteLength,M=new DataView(d.m_value),E=2===w?M.getUint16(0,this.m_littleEndian):M.getUint32(0,this.m_littleEndian);if(this.m_yDim<0)this.m_yDim=E;else if(this.m_yDim!==E)return console.log("Bad image size y"),void 0!==o&&o(wt.WRONG_IMAGE_DIM_Y),wt.WRONG_IMAGE_DIM_Y}if(d.m_group===ni[0]&&d.m_element===ni[1]){var A=d.m_value.byteLength,I=new DataView(d.m_value),O=2===A?I.getUint16(0,this.m_littleEndian):I.getUint32(0,this.m_littleEndian);if(this.m_xDim<0)this.m_xDim=O;else if(this.m_xDim!==O)return console.log("Bad image size x"),void 0!==o&&o(wt.WRONG_IMAGE_DIM_X),wt.WRONG_IMAGE_DIM_X}if(d.m_group===ti[0]&&d.m_element===ti[1]){var X=d.m_value.byteLength,C=new DataView(d.m_value);this.m_bitsPerPixel=2===X?C.getUint16(0,this.m_littleEndian):C.getUint32(0,this.m_littleEndian)}if(d.m_group===li[0]&&d.m_element===li[1]&&null!=d.m_value&&d.m_value.byteLength>0){var P=d.m_value.byteLength,k=new DataView(d.m_value),F=e.getStringAt(k,0,P);this.m_windowCenter=parseInt(F,10)}if(d.m_group===hi[0]&&d.m_element===hi[1]&&null!=d.m_value&&d.m_value.byteLength>0){var U=d.m_value.byteLength,L=new DataView(d.m_value),N=e.getStringAt(L,0,U);this.m_windowWidth=parseInt(N,10)}if(d.m_group===ui[0]&&d.m_element===ui[1]&&null!=d.m_value&&d.m_value.byteLength>0){var z=d.m_value.byteLength,V=new DataView(d.m_value),B=e.getStringAt(V,0,z);this.m_rescaleIntercept=parseInt(B,10)}if(d.m_group===ci[0]&&d.m_element===ci[1]&&null!=d.m_value&&d.m_value.byteLength>0){var j=d.m_value.byteLength,G=new DataView(d.m_value),W=e.getStringAt(G,0,j);this.m_rescaleSlope=parseInt(W,10)}if(d.m_group===di[0]&&d.m_element===di[1]&&null!=d.m_value&&d.m_value.byteLength>0){var H=d.m_value.byteLength,Y=new DataView(d.m_value);"HU"===e.getStringAt(Y,0,H)&&(this.m_rescaleHounsfield=!0)}if(d.m_group===_i[0]&&d.m_element===_i[1]&&null!=d.m_value&&d.m_value.byteLength>0){var q=d.m_value.byteLength,Z=new DataView(d.m_value);1===(2===q?Z.getUint16(0,this.m_littleEndian):Z.getUint32(0,this.m_littleEndian))&&(this.m_pixelRepresentaionSigned=!0)}if(d.m_group===Ti[0]&&d.m_element===Ti[1]&&null!=d.m_value&&d.m_value.byteLength>0){var K=d.m_value.byteLength,Q=new DataView(d.m_value),J=e.getStringAt(Q,0,K);this.m_seriesNumber=parseInt(J,10)}if(d.m_group===gi[0]&&d.m_element===gi[1]&&null!==d.m_value){var $=d.m_value.byteLength,ee=new DataView(d.m_value);this.m_seriesDescr=e.getStringAt(ee,0,$)}if(d.m_group===ri[0]&&d.m_element===ri[1]){var te=d.m_value.byteLength,ie=new DataView(d.m_value),ne=2===te?ie.getUint16(0,this.m_littleEndian):ie.getUint32(0,this.m_littleEndian);_=(1<<ne+1)-1}if(d.m_group===si[0]&&d.m_element===si[1]){var re=d.m_value.byteLength,se=new DataView(d.m_value);2===re?se.getInt16(0,this.m_littleEndian):se.getInt32(0,this.m_littleEndian)}if(d.m_group===oi[0]&&d.m_element===oi[1]){var oe=d.m_value.byteLength,ae=new DataView(d.m_value);2===oe?ae.getInt16(0,this.m_littleEndian):ae.getInt32(0,this.m_littleEndian)}if(d.m_group===ai[0]&&d.m_element===ai[1]){var me=d.m_value.byteLength,le=new DataView(d.m_value);f=2===me?le.getUint16(0,this.m_littleEndian):le.getUint32(0,this.m_littleEndian),this.m_padValue=f}if(d.m_group===mi[0]&&d.m_element===mi[1]){var he=d.m_value.byteLength,ue=new DataView(d.m_value),ce=e.getStringAt(ue,0,he).split("\\");2===ce.length&&(this.m_pixelSpacing.x=parseFloat(ce[0]),this.m_pixelSpacing.y=parseFloat(ce[1]))}if(d.m_group===fi[0]&&d.m_element===fi[1]){var de=d.m_value.byteLength,_e=new DataView(d.m_value),fe=e.getStringAt(_e,0,de).split("\\");if(3===fe.length){var ve=parseFloat(fe[0]),pe=parseFloat(fe[1]),ge=parseFloat(fe[2]);this.m_imagePosMin.x=ve<this.m_imagePosMin.x?ve:this.m_imagePosMin.x,this.m_imagePosMin.y=pe<this.m_imagePosMin.y?pe:this.m_imagePosMin.y,this.m_imagePosMin.z=ge<this.m_imagePosMin.z?ge:this.m_imagePosMin.z,this.m_imagePosMax.x=ve>this.m_imagePosMax.x?ve:this.m_imagePosMax.x,this.m_imagePosMax.y=pe>this.m_imagePosMax.y?pe:this.m_imagePosMax.y,this.m_imagePosMax.z=ge>this.m_imagePosMax.z?ge:this.m_imagePosMax.z}}if(d.m_group===Di[0]&&d.m_element===Di[1]){var Se=d.m_value.byteLength,xe=new DataView(d.m_value),ye=e.getStringAt(xe,0,Se);this.m_pixelSpacing.z=parseFloat(ye)}if(d.m_group===vi[0]&&d.m_element===vi[1]){var Te=d.m_value.byteLength,De=new DataView(d.m_value),be=e.getStringAt(De,0,Te),Re=parseFloat(be);this.m_sliceLocation=Re,this.m_sliceLocMin=Re<this.m_sliceLocMin?Re:this.m_sliceLocMin,this.m_sliceLocMax=Re>this.m_sliceLocMax?Re:this.m_sliceLocMax}if(d.m_group===pi[0]&&d.m_element===pi[1]){var we=d.m_value.byteLength,Me=new DataView(d.m_value);this.m_samplesPerPixel=2===we?Me.getUint16(0,this.m_littleEndian):Me.getUint32(0,this.m_littleEndian)}if(d.m_group===gi[0]&&d.m_element===gi[1]&&null!==d.m_value){var Ee=d.m_value.byteLength,Ae=new DataView(d.m_value),Ie=e.getStringAt(Ae,0,Ee);this.m_dicomInfo.m_seriesDescr=Ie}if(d.m_group===Si[0]&&d.m_element===Si[1]&&null!==d.m_value){var Oe=d.m_value.byteLength,Xe=new DataView(d.m_value),Ce=e.getStringAt(Xe,0,Oe),Pe=Ce.substring(0,2),ke=Ce.substring(2,4),Fe=Ce.substring(4,Ce.length),Ue="".concat(Pe,":").concat(ke,":").concat(Fe);this.m_dicomInfo.m_seriesTime=Ue}if(d.m_group===Ci[0]&&d.m_element===Ci[1]&&null!==d.m_value){var Le=d.m_value.byteLength,Ne=new DataView(d.m_value);this.m_dicomInfo.m_patientName=e.getUtf8StringAt(Ne,0,Le),this.m_dicomInfo.m_patientName=this.m_dicomInfo.m_patientName.trim()}if(d.m_group===Pi[0]&&d.m_element===Pi[1]&&null!==d.m_value){var ze=d.m_value.byteLength,Ve=new DataView(d.m_value);this.m_dicomInfo.m_patientId=e.getStringAt(Ve,0,ze)}if(d.m_group===Fi[0]&&d.m_element===Fi[1]&&null!==d.m_value){var Be=d.m_value.byteLength,je=new DataView(d.m_value);this.m_dicomInfo.m_patientGender=e.getStringAt(je,0,Be)}if(d.m_group===ki[0]&&d.m_element===ki[1]&&null!==d.m_value){var Ge=d.m_value.byteLength,We=new DataView(d.m_value),He=e.getStringAt(We,0,Ge),Ye=He.substring(0,4),qe=He.substring(4,6),Ze=He.substring(6);this.m_dicomInfo.m_patientDateOfBirth="".concat(Ze,"/").concat(qe,"/").concat(Ye)}if(d.m_group===Ui[0]&&d.m_element===Ui[1]&&null!==d.m_value){var Ke=d.m_value.byteLength,Qe=new DataView(d.m_value),Je=e.getStringAt(Qe,0,Ke),$e=Je.substring(0,4),et=Je.substring(4,6),tt=Je.substring(6);this.m_dicomInfo.m_studyDate="".concat(tt,"/").concat(et,"/").concat($e)}if(d.m_group===Li[0]&&d.m_element===Li[1]&&null!==d.m_value){var it=d.m_value.byteLength,nt=new DataView(d.m_value),rt=e.getStringAt(nt,0,it);this.m_dicomInfo.m_studyDescr=rt,this.m_dicomInfo.m_studyDescr=this.m_dicomInfo.m_studyDescr.trim()}if(d.m_group===bi[0]&&d.m_element===bi[1]&&null!==d.m_value){var st=d.m_value.byteLength,ot=new DataView(d.m_value);this.m_dicomInfo.m_bodyPartExamined=e.getStringAt(ot,0,st)}if(d.m_group===Ni[0]&&d.m_element===Ni[1]&&null!==d.m_value){var at=d.m_value.byteLength,mt=new DataView(d.m_value);this.m_dicomInfo.m_acquisionTime=e.getStringAt(mt,0,at)}if(d.m_group===zi[0]&&d.m_element===zi[1]&&null!==d.m_value){var lt=d.m_value.byteLength,ht=new DataView(d.m_value);this.m_dicomInfo.m_institutionName=e.getUtf8StringAt(ht,0,lt),this.m_dicomInfo.m_institutionName=this.m_dicomInfo.m_institutionName.trim()}if(d.m_group===ji[0]&&d.m_element===ji[1]&&null!==d.m_value){var ut=d.m_value.byteLength,ct=new DataView(d.m_value);this.m_dicomInfo.m_operatorsName=e.getUtf8StringAt(ct,0,ut),this.m_dicomInfo.m_operatorsName=this.m_dicomInfo.m_operatorsName.trim()}if(d.m_group===Vi[0]&&d.m_element===Vi[1]&&null!==d.m_value){var dt=d.m_value.byteLength,_t=new DataView(d.m_value);this.m_dicomInfo.m_physicansName=e.getUtf8StringAt(_t,0,dt),this.m_dicomInfo.m_physicansName=this.m_dicomInfo.m_physicansName.trim()}if(d.m_group===Bi[0]&&d.m_element===Bi[1]&&null!==d.m_value){var ft=d.m_value.byteLength,vt=new DataView(d.m_value);this.m_dicomInfo.m_manufacturerName=e.getStringAt(vt,0,ft),this.m_dicomInfo.m_manufacturerName=this.m_dicomInfo.m_manufacturerName.trim()}}if(!v)return void 0!==o&&o(wt.ERROR_PIXELS_TAG_NOT_FOUND),wt.ERROR_PIXELS_TAG_NOT_FOUND;if(this.m_transformSyntax.length>1)return void 0!==o&&o(wt.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED),wt.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED;var pt=Math.floor(this.m_xDim*this.m_yDim*(this.m_bitsPerPixel/8)*this.m_samplesPerPixel);if(pt!==d.m_value.byteLength||0===_)return console.log("Wrong image pixels size. Readed ".concat(d.m_value.byteLength,", but expected ").concat(pt)),void 0!==o&&o(wt.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED),wt.WRONG_HEADER_DATA_SIZE;var gt=this.m_xDim*this.m_yDim,St=new jt;if(null===St)return console.log("No memory"),wt.ERROR_NO_MEMORY;if(this.m_pixelRepresentaionSigned?St.m_image=new Int16Array(gt):St.m_image=new Uint16Array(gt),null===St.m_image)return console.log("No memory"),wt.ERROR_NO_MEMORY;St.m_sliceNumber=this.m_imageNumber,St.m_sliceLocation=this.m_sliceLocation,St.m_patientName=this.m_dicomInfo.m_patientName,St.m_studyDescr=this.m_dicomInfo.m_studyDescr,St.m_studyDate=this.m_dicomInfo.m_studyDate,St.m_seriesTime=this.m_dicomInfo.m_seriesTime,St.m_seriesDescr=this.m_dicomInfo.m_seriesDescr,St.m_bodyPartExamined=this.m_dicomInfo.m_bodyPartExamined,St.m_institutionName=this.m_dicomInfo.m_institutionName,St.m_operatorsName=this.m_dicomInfo.m_operatorsName,St.m_physicansName=this.m_dicomInfo.m_physicansName,St.buildHash(),St.m_xDim=this.m_xDim,St.m_yDim=this.m_yDim;var xt=St.m_image,yt=new DataView(d.m_value);if(null===yt)return console.log("No memory"),wt.ERROR_NO_MEMORY;var Tt;if(8===this.m_bitsPerPixel){if(1===this.m_samplesPerPixel)for(Tt=0;Tt<gt;Tt++){var Dt=yt.getUint8(Tt);xt[Tt]=Dt}else if(3===this.m_samplesPerPixel){var bt=0;for(Tt=0;Tt<gt;Tt++,bt+=3){var Rt=yt.getUint8(bt+0),Mt=yt.getUint8(bt+1),Et=yt.getUint8(bt+2);xt[Tt]=Math.floor((Rt+Mt+Et)/3)}}}else if(16===this.m_bitsPerPixel){var At=0;for(Tt=0;Tt<gt;Tt++){var It=yt.getUint16(At,this.m_littleEndian);At+=2,xt[Tt]=It}}else console.log("TODO: need to implement reading non-8 and non-16 bit dicom images");return this.m_error=0,this.m_slicesVolume.addSlice(St),void 0!==o&&o(wt.SUCCESS),wt.SUCCESS}},{key:"readFromUrl",value:function(e,t,i,n){var r=this;console.assert(null!=e,"Null volume"),console.assert(e instanceof Yi,"Should be volume set"),console.assert(null!=t,"Null string url"),console.assert("string"===typeof t,"Should be string in url");var s=new qt;if(!s.isValidUrl(t))return console.log("readFromUrl: not vaild URL = = ".concat(t," ")),!1;this.m_folder=s.getFolderNameFromUrl(t);var o=this.m_folder+"/file_list.txt";console.log("readFromUrl: load file = ".concat(o," "));var a=new Et(o);return this.m_callbackComplete=n,this.m_callbackProgress=i,this.m_fileListCounter=0,a.readFile((function(t){return r.m_fileListCounter+=1,1!==r.m_fileListCounter||r.readReadyFileList(e,t,i,n)}),(function(e){return console.log("Error read file: ".concat(e)),n(wt.ERROR_CANT_OPEN_URL,null,0,null),!1})),!0}},{key:"readReadyFileList",value:function(e,t,i,n){console.assert(null!=e,"Null volume"),console.assert(e instanceof Yi,"Should be volume set"),console.assert(null!=t,"Null array"),console.assert("ArrayBuffer"===t.constructor.name,"Should be ArrayBuf in arrBuf");var r=new Uint8Array(t),s=String.fromCharCode.apply(null,r),o=s.substr(0,64);console.log("Loaded file list. Started with:  ".concat(o," ..."));for(var a=s.split("\n"),m=a.length,l=m-1;l>=0;l--)a[l].endsWith("\r")&&(a[l]=a[l].substring(0,a[l].length-1)),a[l].length<4&&a.pop();m=a.length,this.m_zDim=m,console.log("Loaded file list. ".concat(m," files will be loaded. 1st file in list is = ").concat(a[0])),console.log("Loaded file list. Last file in list is = ".concat(a[m-1]));for(var h=0;h<m;h++)this.m_errors[h]=-1,this.m_loaders[h]=null;this.m_pixelSpacing={x:0,y:0,z:0},this.m_filesLoadedCounter=0,this.m_numFailsLoad=0,this.m_numLoadedFiles=m,this.m_imagePosMin={x:1e12,y:1e12,z:1e12},this.m_imagePosMax={x:-1e12,y:-1e12,z:-1e12},this.m_sliceLocMin=1e12,this.m_sliceLocMax=-1e12;for(var u=0;u<this.m_numLoadedFiles&&this.m_numFailsLoad<1;u++){var c="".concat(this.m_folder,"/").concat(a[u]);this.m_loaders[u]=new Et(c);var d=this.m_loaders[u];if(!this.runLoader(e,a[u],d,u,i,n,!1))return!1}return!0}},{key:"runLoader",value:function(e,t,i,n,r,s,o){var a=this;return this.m_fromGoogle=o,i.readFile((function(i){var o,m=a.m_filesLoadedCounter/a.m_numLoadedFiles;if(void 0!==r&&0===(7&a.m_filesLoadedCounter)&&r(m),void 0!==r&&a.m_filesLoadedCounter+1===a.m_numLoadedFiles&&r(1),a.m_newTagEvent.detail.fileName=t,(o=a.m_fromGoogle?a.readFromGoogleBuffer(n,t,m,i,r,s):a.readFromBuffer(n,t,m,i,r,s))!==wt.SUCCESS&&0===a.m_numFailsLoad&&(a.m_numFailsLoad+=1,null!==s))return s(o,null,0,null,t),!1;if(a.m_filesLoadedCounter+=1,a.m_filesLoadedCounter===a.m_numLoadedFiles){Zt;var l,h={x:a.m_imagePosMax.x-a.m_imagePosMin.x,y:a.m_imagePosMax.y-a.m_imagePosMin.y,z:a.m_imagePosMax.z-a.m_imagePosMin.z},u=1e-5;Math.abs(a.m_pixelSpacing.z)>u?l=a.m_pixelSpacing.z*a.m_zDim:(l=h.z,Math.abs(l)<u&&(l=h.x,Math.abs(l)<u&&(l=h.y))),l<u&&(l=1),a.m_pixelSpacing.z=l/a.m_zDim,a.m_boxSize.z=a.m_zDim*a.m_pixelSpacing.z,a.m_boxSize.x=a.m_xDim*a.m_pixelSpacing.x,a.m_boxSize.y=a.m_yDim*a.m_pixelSpacing.y,console.log("Volume local phys dim: ".concat(a.m_boxSize.x," * ").concat(a.m_boxSize.y," * ").concat(a.m_boxSize.z));var c=a.m_slicesVolume.getSeries();0===c.length&&(a.m_slicesVolume.buildSeriesInfo(),c=a.m_slicesVolume.getSeries());var d=c[0].m_hash,_=a.createVolumeFromSlices(e,0,d);if(null!==s)return s(_),!0}return!0}),(function(e){return console.log("Error read file: ".concat(e)),!1})),!0}}],[{key:"getVrsStringIndex",value:function(e){for(var t=["AE","AS","AT","CS","DA","DS","DT","FL","FD","IS","LO","LT","OB","OD","OF","OW","PN","SH","SL","SS","ST","TM","UI","UL","UN","US","UT"],i=t.length,n=0;n<i;n++)if(t[n]===e)return n;return-1}},{key:"getDataVrsStringIndex",value:function(e){for(var t=["OB","OW","OF","SQ","UT","UN"],i=t.length,n=0;n<i;n++)if(t[n]===e)return n;return-1}},{key:"getStringAt",value:function(e,t,i){for(var n="",r=0;r<i;r++){var s=e.getUint8(t+r);0!==s&&(n+=String.fromCharCode(s))}return n}},{key:"getUtf8StringAt",value:function(e,t,i){for(var n="",r=0;r<i;){var s=e.getUint8(t+r);switch(r++,94==s&&(s=32),s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:n+=String.fromCharCode(s);break;case 12:case 13:var o=e.getUint8(t+r);r++,n+=String.fromCharCode((31&s)<<6|63&o);break;case 14:var a=e.getUint8(t+r);r++;var m=e.getUint8(t+r);r++,n+=String.fromCharCode((15&s)<<12|(63&a)<<6|(63&m)<<0)}}return n}},{key:"getAttrValueAsString",value:function(t){if(null===t.m_value)return"SQ"===t.m_vr?"(Sequence Data)":null;var i=new DataView(t.m_value),n=null,r=null,s=0;switch(t.m_vr){case"AE":return e.getStringAt(i,0,t.m_value.byteLength);case"AS":switch(n=e.getStringAt(i,0,t.m_value.byteLength),r=Number(n.slice(0,3)).toString(),n[3]){case"D":return"".concat(r," days");case"W":return"".concat(r," weeks");case"M":return"".concat(r," months");case"Y":return"".concat(r," years");default:return null}case"CS":return e.getStringAt(i,0,t.m_value.byteLength);case"DA":return n=e.getStringAt(i,0,t.m_value.byteLength),new Date("".concat(n.slice(0,4),"-").concat(n.slice(4,6),"-").concat(n.slice(6,8))).toLocaleDateString();case"DS":case"DT":return e.getStringAt(i,0,t.m_value.byteLength);case"FL":for(r=i.getFloat32(0,t.m_littleEndian).toString(),s=4;s+4<=i.byteLength;)r="".concat(r," \\ ").concat(i.getFloat32(s,t.m_littleEndian).toString()),s+=4;return r;case"FD":for(r=i.getFloat64(0,t.m_littleEndian).toString(),s=8;s+4+4<=i.byteLength;)r="".concat(r," \\ ").concat(i.getFloat64(s,t.m_littleEndian).toString()),s+=8;return r;case"IS":case"LO":case"LT":case"PN":case"SH":return e.getStringAt(i,0,t.m_value.byteLength);case"SL":for(r=i.getInt32(0,t.m_littleEndian).toString(),s=4;s+2<=i.byteLength;)r="".concat(r," \\ ").concat(i.getInt16(s,t.m_littleEndian).toString()),s+=4;return r;case"SS":for(r=i.getInt16(0,t.m_littleEndian).toString(),s=2;s+2<=i.byteLength;)r="".concat(r," \\ ").concat(i.getInt16(s,t.m_littleEndian).toString()),s+=2;return r;case"ST":return e.getStringAt(i,0,t.m_value.byteLength);case"TM":return n=e.getStringAt(i,0,t.m_value.byteLength),t.m_value.byteLength>=2&&(r="".concat(Number(n.slice(0,2)),"h")),t.m_value.byteLength>=4&&(r="".concat(r," ").concat(Number(n.slice(2,4)),"m")),t.m_value.byteLength>4&&(r="".concat(r," ").concat(parseFloat(n.slice(4,t.m_value.byteLength)),"s")),r;case"UI":return e.getStringAt(i,0,t.m_value.byteLength);case"UL":for(r=i.getUint32(0,t.m_littleEndian).toString(),s=4;s+4<=i.byteLength;)r="".concat(r," \\ ").concat(i.getUint32(s,t.m_littleEndian).toString()),s+=4;return r;case"US":for(r=i.getUint16(0,t.m_littleEndian).toString(),s=2;s+2<=i.byteLength;)r="".concat(r," \\ ").concat(i.getUint16(s,t.m_littleEndian).toString()),s+=2;return r;case"UT":return e.getStringAt(i,0,t.m_value.byteLength);default:return null}}},{key:"numberToHexString",value:function(e){for(var t=e.toString(16),i=4-t.length,n="",r=0;r<i;r++)n+="0";return"0x"+n+t}}]),e}(),Wi=function(){function e(){Object(f.a)(this,e),this.m_file=null,this.m_reader=null,this.m_request=null}return Object(v.a)(e,[{key:"readLocal",value:function(e){var t=this;return new Promise((function(i){t.m_file=e,t.m_reader=new FileReader,t.m_reader.addEventListener("load",(function(e){var t=e.target.result;i&&i(t)})),t.m_reader.readAsArrayBuffer(t.m_file)}))}},{key:"readFromUrl",value:function(e){var t=this;return new Promise((function(i,n){t.m_url=e,t.m_request=null;if(t.m_request=new XMLHttpRequest,!("withCredentials"in t.m_request))return t.m_request=null,void console.log("This browser cant support CORS requests");t.m_request.open("GET",t.m_url,!0),t.m_request.responseType="arraybuffer",t.m_request.addEventListener("load",(function(e){var t=e.target.response;null===t?console.log("Bad response type. Expect object type in response."):i(t)}),!1),t.m_request.addEventListener("error",(function(e){var t="Error event happend for XMLHttpRequest: loaded = ".concat(e.loaded,", total = ").concat(e.total);console.log(t),n(t)}),!1),t.m_request.send()}))}}]),e}(),Hi=function(){function e(){Object(f.a)(this,e)}return Object(v.a)(e,[{key:"readFromBufferHeader",value:function(t,i,n,r){console.assert(null!=t,"Null volume"),console.assert(t instanceof Rt,"Should be volume"),console.assert(null!=i,"Null array"),console.assert("ArrayBuffer"===i.constructor.name,"Should be ArrayBuf in arrBuf");var s=new Uint8Array(i);if(348!==s.length)return r&&r(wt.WRONG_HEADER_DATA_SIZE,null,0,null),!1;var o=0,a=e.readIntFromBuffer(s,o);if(o+=4,348!==a)return console.log("Hdr first int wrong: ".concat(a,", but should be ").concat(348)),r&&r(wt.BAD_HEADER,null,0,null),!1;var m=e.getStringAt(s,o,10);if(o+=10,t.m_dataType=0,"CHAR"===m&&(t.m_dataType=2,t.m_bytesPerVoxel=1),"SHORT"===m&&(t.m_dataType=4,t.m_bytesPerVoxel=2),0===t.m_dataType)return console.log("Hdr wrong data type. Should be CHAR or SHORT, but found: ".concat(m)),r&&r(wt.BAD_HEADER,null,0,null),!1;console.log("Hdr read data type = ".concat(m));o+=18;var l=e.readIntFromBuffer(s,o);o+=4;if(16384!==l)return console.log("Hdr wrong extents in header. Should be ".concat(16384,", but found: ").concat(l)),r&&r(wt.BAD_HEADER,null,0,null),!1;o+=2;var h=e.readByteFromBuffer(s,o);o+=1;if(114!==h)return console.log("Hdr wrong regular in header. Should be ".concat(114,", but found: ").concat(h)),r&&r(wt.BAD_HEADER,null,0,null),!1;o+=1,o+=2;var u=e.readShortFromBuffer(s,o);o+=2;var c=e.readShortFromBuffer(s,o);o+=2;var d=e.readShortFromBuffer(s,o);o+=2,t.m_xDim=u,t.m_yDim=c,t.m_zDim=d,console.log("HDR: volume dim = ".concat(t.m_xDim," * ").concat(t.m_yDim," * ").concat(t.m_zDim," "));o+=8;o+=4;o+=8,o+=2;var _=e.readShortFromBuffer(s,o);if(o+=2,2===t.m_dataType&&2!==_)return console.log("Wrong data tye for char typed header"),!1;if(4===t.m_dataType&&4!==_)return console.log("Wrong data tye for signed short typed header"),!1;var f=e.readShortFromBuffer(s,o);if(o+=2,2===t.m_dataType&&8!==f)return console.log("Wrong bits pix for char typed header"),!1;if(4===t.m_dataType&&16!==f)return console.log("Wrong bits pix for word typed header"),!1;o+=2,o+=4;var v=e.readFloatFromBuffer(s,o);o+=4;var p=e.readFloatFromBuffer(s,o);o+=4;var g=e.readFloatFromBuffer(s,o);o+=4;return o+=16,t.m_boxSize.x=t.m_xDim*v,t.m_boxSize.y=t.m_yDim*p,t.m_boxSize.z=t.m_zDim*g,console.log("HDR: physic size = ".concat(t.m_boxSize.x," * ").concat(t.m_boxSize.y," * ").concat(t.m_boxSize.z," ")),!0}},{key:"readFromBufferImage",value:function(e,t,i,n){console.assert(null!=e,"Null volume"),console.assert(e instanceof Rt,"Should be volume"),console.assert(null!=t,"Null array"),console.assert("ArrayBuffer"===t.constructor.name,"Should be ArrayBuf in arrBuf");var r=new Uint8Array(t).length;return r<8?(n&&n(wt.ERROR_TOO_SMALL_DATA_SIZE,null,0,null),!1):r>=241172480?(n&&n(wt.ERROR_TOO_LARGE_DATA_SIZE,null,0,null),!1):(e.m_imageBufferSize=r,e.m_arrBuf=t,console.log("readFromBufferImage complete with ".concat(r," bytes in image ")),!0)}},{key:"createVolumeFromHeaderAndImage",value:function(e){console.assert(null!=e,"Null volume"),console.assert(e instanceof Rt,"Should be volume");var t=0;2===e.m_dataType&&(t=1),4===e.m_dataType&&(t=2);var i=e.m_xDim*e.m_yDim*e.m_zDim,n=i*t;if(n!==e.m_imageBufferSize)return console.log("HDR: wrong IMG data size. Read: ".concat(e.m_imageBufferSize,", but expected ").concat(n," ")),!1;var r=e.m_arrBuf;if(4===e.m_dataType){var s,o=new Uint16Array(r);e.m_dataArray=new Uint8Array(i);var a=0;for(s=0;s<i;s++)a=o[s]>a?o[s]:a;a++;for(s=0;s<i;s++)e.m_dataArray[s]=Math.floor(255*o[s]/a)}else if(2===e.m_dataType){var m=new Uint8Array(r);e.m_dataArray=m}return e.m_bytesPerVoxel=1,e.m_dataSize=e.m_imageBufferSize,!0}},{key:"createRoiVolumeFromHeaderAndImage",value:function(e,t){console.assert(null!=e,"Null volume"),console.assert(e instanceof Rt,"Should be volume"),console.assert(null!=t,"Null volume"),console.assert(t instanceof Rt,"Should be volume");if(1!==e.m_bytesPerVoxel)return console.log("createRoiVolumeFromHeaderAndImage: bad volDst. m_bytesPerVoxel should be 1"),!1;if(1!==t.m_bytesPerVoxel)return console.log("createRoiVolumeFromHeaderAndImage: bad volRoi"),!1;if(e.m_xDim!==t.m_xDim||e.m_yDim!==t.m_yDim||e.m_zDim!==t.m_zDim)return console.log("createRoiVolumeFromHeaderAndImage: different volumes sizes"),!1;for(var i=e.m_xDim*e.m_yDim*e.m_zDim,n=new Uint8Array(4*i),r=t.m_arrBuf,s=new Uint8Array(r),o=0,a=0;a<i;a++,o+=4)n[o+0]=e.m_dataArray[a],n[o+1]=0,n[o+2]=0,n[o+3]=s[a];e.m_dataArray=n;return e.m_bytesPerVoxel=4,console.log("createRoiVolumeFromHeaderAndImage: success"),!0}},{key:"readFromUrl",value:function(e,t,i,n){console.log("readFromUrl. going to read from ".concat(t," ..."));var r=new qt;if(!r.isValidUrl(t))return console.log("readFromUrl: not vaild URL = = ".concat(t," ")),!1;this.m_folder=r.getFolderNameFromUrl(t);var s=r.getFileNameFromUrl(t),o=/(\w+)_intn.(h|hdr)/.exec(s);if(3!==o.length)return console.log("LoaderHdr.readFromUrl: bad URL name = ".concat(t,". Should be in template NNN_intn.h ")),!1;var a=o[1],m=this.m_folder+"/"+a+"_intn.h",l=this.m_folder+"/"+a+"_intn.img",h=this.m_folder+"/"+a+"_mask.h",u=this.m_folder+"/"+a+"_mask.img",c=[];return c.push(m),c.push(l),c.push(h),c.push(u),this.readFromUrls(c,e,i,n)}},{key:"readFromUrls",value:function(e,t,i,n){var r=this;console.assert(null!=t,"Null volume set"),console.assert(t instanceof Yi,"Should be volume set");var s=e.length;if(2===s){var o=e[0],a=e[1],m=new Wi,l=new Wi,h=o.indexOf(".h");if(-1===h&&(h=o.indexOf(".hdr")),-1===h){var u=o;o=a,a=u}var c=t.getVolume(0);m.readFromUrl(o).then((function(e){r.readFromBufferHeader(c,e,n,i),console.log("Load success HDR file: ".concat(o)),l.readFromUrl(a).then((function(e){r.readFromBufferImage(c,e,n,i),console.log("Load success IMG file: ".concat(a)),r.createVolumeFromHeaderAndImage(c),n(wt.SUCCESS)}))}),(function(e){return console.log("HDR File read error",e),n(wt.ERROR_CANT_OPEN_URL,null,0,null),!1}))}else{if(4!==s)return console.log("Error read hdr files. Should be ".concat(2," files")),!1;var d=e[0],_=e[1],f=e[2],v=e[3],p=new Wi,g=new Wi,S=new Wi,x=new Wi,y=new Rt,T=t.getVolume(0);p.readFromUrl(d).then((function(e){r.readFromBufferHeader(T,e,n,i),console.log("Load success HDR file: ".concat(d)),g.readFromUrl(_).then((function(e){r.readFromBufferImage(T,e,n,i),console.log("Load success IMG file: ".concat(_)),S.readFromUrl(f).then((function(e){r.readFromBufferHeader(y,e,n,i),x.readFromUrl(v).then((function(e){r.readFromBufferImage(y,e,n,i),r.createVolumeFromHeaderAndImage(T),r.createRoiVolumeFromHeaderAndImage(T,y),n(wt.SUCCESS)}))}))}))}),(function(e){return console.log("HDR File read error",e),!1}))}return!0}}],[{key:"readByteFromBuffer",value:function(e,t){return e[t]}},{key:"readIntFromBuffer",value:function(e,t){return e[t+0]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24}},{key:"readShortFromBuffer",value:function(e,t){return e[t+0]|e[t+1]<<8}},{key:"readFloatFromBuffer",value:function(e,t){var i=new ArrayBuffer(4),n=new DataView(i);n.setUint8(0,e[t+0]),n.setUint8(1,e[t+1]),n.setUint8(2,e[t+2]),n.setUint8(3,e[t+3]);return n.getFloat32(0,!0)}},{key:"getStringAt",value:function(e,t,i){for(var n="",r=0;r<i;r++){var s=e[t+r];if(0===s)break;n+=String.fromCharCode(s)}return n}}]),e}(),Yi=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).m_numVolumes=0,n.m_volumes=[],n.m_patientName="",n.m_patientBirth="",n.m_seriesDescr="",n.m_studyDescr="",n.m_studyDate="",n.m_seriesTime="",n.m_bodyPartExamined="",n.m_institutionName="",n.m_operatorsName="",n.m_physicansName="",n}return Object(v.a)(i,[{key:"addVolume",value:function(e){console.assert(e instanceof Rt,"VolumeSet.addVolume: arg must be Volume"),this.m_volumes.push(e),this.m_numVolumes++}},{key:"getNumVolumes",value:function(){return this.m_numVolumes}},{key:"getVolume",value:function(e){return console.assert(Number.isInteger(e),"VolumeSet.getVolume: arg must be number"),console.assert(e<this.m_numVolumes,"index of volume should be in range"),console.assert(e>=0,"index of volume should be non negative"),e<0||e>=this.m_numVolumes?null:this.m_volumes[e]}},{key:"render",value:function(){return r.a.createElement("p",null,">")}},{key:"readFromKtx",value:function(e,t,i){console.assert(null!=e),console.assert("ArrayBuffer"===e.constructor.name,"Should be ArrayBuf in arrBuf");var n=new Xt,r=this.getVolume(0);return n.readFromBuffer(r,e,t,i)}},{key:"readFromKtxUrl",value:function(e,t,i){var n=new Xt,r=this.getVolume(0);n.readFromUrl(r,e,t,i)}},{key:"readFromNiiUrl",value:function(e,t,i){var n=new kt,r=this.getVolume(0);return n.readFromUrl(r,e,t,i)}},{key:"readFromDicomUrl",value:function(e,t,i){return new Gi(0).readFromUrl(this,e,t,i)}},{key:"readFromHdrUrl",value:function(e,t,i){return(new Hi).readFromUrl(this,e,t,i)}},{key:"readFromNifti",value:function(e,t,i){var n=new kt,r=this.getVolume(0);return n.readFromBuffer(r,e,t,i)}},{key:"readFromDicom",value:function(e,t,i,n){return e.readFromBuffer(0,"file???",0,t,i,n)}},{key:"readSingleSliceFromDicom",value:function(e,t,i,n,r,s,o){return e.readFromBuffer(t,i,n,r,s,o)}}]),i}(r.a.Component),qi=function(){function e(){Object(f.a)(this,e),this.m_texture=-1}return Object(v.a)(e,[{key:"createFromRawVolume",value:function(e){this.m_texture=new Z.k(e.m_dataArray,e.m_xDim,e.m_yDim,e.m_zDim)}}]),e}(),Zi=i(190),Ki=i(187),Qi=i(194),Ji=i(188),$i=i(129),en=1073741823,tn=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).m_needMode3dLight=!0,n.onMode3dLight=n.onMode3dLight.bind(Object(S.a)(n)),n.m_objCanvas=null,n.m_dataMin=en,n.m_dataMax=en,n.onButtonCancel=n.onButtonCancel.bind(Object(S.a)(n)),n.onButtonApply=n.onButtonApply.bind(Object(S.a)(n)),n.state={showModalWindowCenterWidth:!1,windowMin:-350,windowMax:1650},n}return Object(v.a)(i,[{key:"onModalHide",value:function(){this.setState({showModalWindowCenterWidth:!1})}},{key:"reset",value:function(){this.m_dataMin=en,this.m_dataMax=en,this.setState({windowMin:-350}),this.setState({windowMax:1650})}},{key:"onButtonCancel",value:function(){this.reset(),(0,this.props.onHide)(!1)}},{key:"onButtonApply",value:function(){}},{key:"componentDidMount",value:function(){this.props.onRef(this),this.renderPreview()}},{key:"componentWillUnmount",value:function(){this.props.onRef(void 0)}},{key:"componentDidUpdate",value:function(){this.renderPreview()}},{key:"drawSlice",value:function(e,t,i,n,r,s,o){for(var a=s[0].m_slices,m=a.length,l=a[0].m_sliceNumber,h=a[0].m_sliceNumber,u=0;u<m;u++){var c=a[u].m_sliceNumber;l=c<l?c:l,h=c>h?c:h}h-l>0?a.sort((function(e,t){return e.m_sliceNumber-t.m_sliceNumber})):a.sort((function(e,t){return e.m_sliceLocation-t.m_sliceLocation}));for(var d=0,_=0;_<m;_++)a[_].m_sliceNumber=d,d++;o.m_zDim=m;var f,v=a[Math.floor(m/2)],p=v.m_image,g=v.m_xDim,S=v.m_yDim,x=-1073741823,y=1073741823,T=g*S;for(f=0;f<T;f++){var D=p[f];if(!o.m_littleEndian)D=D>>8|D<<8&65535;var b=(D=D===o.m_padValue?0:D)*o.m_rescaleSlope+o.m_rescaleIntercept;y=b<y?b:y,x=b>x?b:x}var R=this.state.windowMin,w=this.state.windowMax,M=Math.floor(.5*(w+R)),E=w-R;if(Math.floor((1<<19)/(x-y))<=4)console.log("Bad scaling: image will be 0");else{var A=new Uint8Array(T),I=M-.5*E;for(f=0;f<T;f++){var O=p[f];if(!o.m_littleEndian)O=O>>8|O<<8&65535;var X=(O=O===o.m_padValue?0:O)*o.m_rescaleSlope+o.m_rescaleIntercept,C=0;C=(C=(C=o.m_rescaleHounsfield?Math.floor(255*(X-I)/E):Math.floor(127+128*(X-M)/(E/2)))>=0?C:0)<255?C:255,A[0+f]=C}for(var P=0,k=g/t,F=S/i,U=0,L=0;L<i;L++,U+=F)for(var N=Math.floor(U)*g,z=0,V=0;V<t;V++,z+=k){var B=A[0+N+Math.floor(z)];r[P+0]=B,r[P+1]=B,r[P+2]=B,r[P+3]=255,P+=4}e.putImageData(n,0,0)}}},{key:"renderPreview",value:function(){var e=this.m_objCanvas;if(null!==e){var t=e.clientWidth,i=e.clientHeight,n=e.getContext("2d"),r=this.props;n.fillStyle="rgb(40, 40, 40)",n.fillRect(0,0,t,i);var s=n.createImageData(t,i),o=s.data,a=r.loaderDicom;if(null!==a){var m=a.m_slicesVolume.m_series;0!==m.length&&this.drawSlice(n,t,i,s,o,m,a)}}}},{key:"onSliderWindowRange",value:function(){var e=this.refs.sliderRange.slider.get(),t=parseInt(e[0]),i=parseInt(e[1]);this.setState({windowMin:t}),this.setState({windowMax:i})}},{key:"getDataMinMax",value:function(e,t){var i=t.m_slicesVolume.m_series;if(0!==i.length){var n,r=i[0].m_slices[0],s=r.m_image,o=-1073741823,a=1073741823,m=r.m_xDim*r.m_yDim;for(n=0;n<m;n++){var l=s[n];if(!t.m_littleEndian)l=l>>8|l<<8&65535;var h=(l=l===t.m_padValue?0:l)*t.m_rescaleSlope+t.m_rescaleIntercept;a=h<a?h:a,o=h>o?h:o}this.m_dataMin=a,this.m_dataMax=o}}},{key:"initWindowRange",value:function(){var e=this.props,t=e.loaderDicom;if(null!==t){var i=!0;if(i=t.m_windowCenter!==en&&i,i=t.m_windowWidth!==en&&i,i=!(t.m_windowWidth<=0)&&i){var n=Math.floor(t.m_windowCenter-t.m_windowWidth/2),r=Math.floor(t.m_windowCenter+t.m_windowWidth/2);this.setState({windowMin:n}),this.setState({windowMax:r})}this.getDataMinMax(e,t)}}},{key:"onMode",value:function(e){this.props.dispatch({type:l.SET_MODE_VIEW,modeView:e})}},{key:"onMode3dLight",value:function(){this.onMode(h.VIEW_3D_LIGHT),console.log("TODO: on Apply Render file in 3d..."),this.reset();for(var e=this.props,t=e.loaderDicom,i=e.volumeSet,n=t.m_slicesVolume.getSeries(),r=n.length,s=0;s<r;s++){var o=n[s].m_hash;t.createVolumeFromSlices(i,s,o)}(0,this.props.onHide)(!0)}},{key:"render",value:function(){var e=this,t=this.props.modeView===h.VIEW_3D_LIGHT?"primary":"secondary",i=this.props.stateVis,n=this.props.onHide,s=r.a.createElement("canvas",{ref:function(t){e.m_objCanvas=t},style:{width:"500px",height:"400px"},width:"500px",height:"400px"});return this.m_dataMin,r.a.createElement(Zi.a,{show:i,onHide:n,size:"xl"},r.a.createElement(Zi.a.Header,{closeButton:!0}),r.a.createElement(Zi.a.Body,null,r.a.createElement(D.a,null,r.a.createElement(x.a,null,r.a.createElement(y.a,{xs:!0,md:!0,lg:"12",ref:function(t){e.m_objCol=t}},r.a.createElement("p",{className:"text-center"},s))),r.a.createElement(x.a,null,r.a.createElement(y.a,{xs:!0,md:!0,lg:"5"}),r.a.createElement(y.a,{xs:!0,md:!0,lg:"3"},r.a.createElement(Ki.a,{className:"mr-2","aria-label":"Top group"},r.a.createElement(Qi.a,{key:"3dLight",placement:"bottom",overlay:r.a.createElement(Ji.a,null,"Prepare 2D")},r.a.createElement($i.a,{variant:t,onClick:this.onMode3dLight},"2D Image Creation"))))))))}}]),i}(r.a.Component),nn=Object(a.b)((function(e){return e}))(tn),rn=i(6),sn=i.n(rn),on=function(){function e(){Object(f.a)(this,e),this.m_loaderDicom=null}return Object(v.a)(e,[{key:"loadDicomfir",value:function(e,t){var i=new DataView(t),n=null;try{n=sn.a.Series.parseImage(i)}catch(f){return console.log("error parse dcm file buffer"),wt.BAD_DICOM}if(void 0===n||null===n)return wt.BAD_DICOM;var r,s=[4,4640];r=sn.a.Utils.dec2hex(s[0])+sn.a.Utils.dec2hex(s[1]);var o=n.tags[r];if(void 0!==o)for(var a=o.value.length,m=0;m<a;m++){var l=o.value[m];if(57344===l.element&&65534===l.group)for(var h=l.value.length,u=0;u<h;u++){var c=l.value[u];if(5168===c.element&&c.group,5376===c.element&&4===c.group){var d=c.value[0],_=c.value[1];console.log("image nm = ".concat(d," / ").concat(_))}}}return wt.SUCCESS}},{key:"loadSingleSlice",value:function(e,t,i){var n=new DataView(i),r=null;try{r=sn.a.Series.parseImage(n)}catch(_e){return console.log("error parse dcm file buffer"),wt.BAD_DICOM}if(void 0===r||null===r)return wt.BAD_DICOM;var s=r.getRows(),o=r.getCols(),a=r.getBitsAllocated();8!==a&&16!==a&&console.log("Parse Dicom data. Strange bits per pixel = "+a.toString());var m=r.getPatientName(),l=r.getImageDescription(),h=r.getStudyDate(),u=r.getStudyTime(),c=r.getSeriesDescription(),d=this.m_loaderDicom.m_dicomInfo,_=new jt;_.m_sliceNumber=e,_.m_sliceLocation=-1,_.m_patientName=m,_.m_studyDescr=l,_.m_studyDate=h,_.m_seriesTime=u,_.m_seriesDescr=c,_.m_bodyPartExamined="NonExistInDiakonReader",_.buildHash(),this.m_loaderDicom.m_minSlice=0,this.m_loaderDicom.m_maxSlice=0,this.m_loaderDicom.m_pixelSpacing.x=0,this.m_loaderDicom.m_pixelSpacing.y=0,this.m_loaderDicom.m_pixelSpacing.z=0,this.m_loaderDicom.m_xDim=o,this.m_loaderDicom.m_yDim=s,e<this.m_loaderDicom.m_slicesVolume.m_minSlice&&(this.m_loaderDicom.m_slicesVolume.m_minSlice=e),e>this.m_loaderDicom.m_slicesVolume.m_maxSlice&&(this.m_loaderDicom.m_slicesVolume.m_maxSlice=e),this.m_loaderDicom.m_newTagEvent.detail.fileName=t;var f=new Ht,v="Slice "+e.toString();f.m_sliceName=v,f.m_fileName=t,f.m_tags=[],d.m_sliceInfo.push(f);var p=[sn.a.Tag.TAG_ROWS,sn.a.Tag.TAG_COLS,sn.a.Tag.TAG_ACQUISITION_MATRIX,sn.a.Tag.TAG_NUMBER_OF_FRAMES,sn.a.Tag.TAG_NUMBER_TEMPORAL_POSITIONS,sn.a.Tag.TAG_PIXEL_SPACING,sn.a.Tag.TAG_SLICE_THICKNESS,sn.a.Tag.TAG_SLICE_GAP,sn.a.Tag.TAG_TR,sn.a.Tag.TAG_FRAME_TIME,sn.a.Tag.TAG_BITS_ALLOCATED,sn.a.Tag.TAG_BITS_STORED,sn.a.Tag.TAG_PIXEL_REPRESENTATION,sn.a.Tag.TAG_HIGH_BIT,sn.a.Tag.TAG_PHOTOMETRIC_INTERPRETATION,sn.a.Tag.TAG_SAMPLES_PER_PIXEL,sn.a.Tag.TAG_PLANAR_CONFIG,sn.a.Tag.TAG_PALETTE_RED,sn.a.Tag.TAG_PALETTE_GREEN,sn.a.Tag.TAG_PALETTE_BLUE,sn.a.Tag.TAG_DATA_SCALE_SLOPE,sn.a.Tag.TAG_DATA_SCALE_INTERCEPT,sn.a.Tag.TAG_DATA_SCALE_ELSCINT,sn.a.Tag.TAG_PIXEL_BANDWIDTH,sn.a.Tag.TAG_IMAGE_MIN,sn.a.Tag.TAG_IMAGE_MAX,sn.a.Tag.TAG_WINDOW_CENTER,sn.a.Tag.TAG_WINDOW_WIDTH,sn.a.Tag.TAG_PATIENT_NAME,sn.a.Tag.TAG_PATIENT_ID,sn.a.Tag.TAG_STUDY_DATE,sn.a.Tag.TAG_STUDY_TIME,sn.a.Tag.TAG_STUDY_DES,sn.a.Tag.TAG_IMAGE_TYPE,sn.a.Tag.TAG_IMAGE_COMMENTS,sn.a.Tag.TAG_SEQUENCE_NAME,sn.a.Tag.TAG_MODALITY,sn.a.Tag.TAG_FRAME_OF_REF_UID,sn.a.Tag.TAG_STUDY_UID,sn.a.Tag.TAG_SERIES_DESCRIPTION,sn.a.Tag.TAG_SERIES_INSTANCE_UID,sn.a.Tag.TAG_SERIES_NUMBER,sn.a.Tag.TAG_ECHO_NUMBER,sn.a.Tag.TAG_TEMPORAL_POSITION,sn.a.Tag.TAG_IMAGE_NUM,sn.a.Tag.TAG_SLICE_LOCATION,sn.a.Tag.TAG_IMAGE_ORIENTATION,sn.a.Tag.TAG_IMAGE_POSITION,sn.a.Tag.TAG_SLICE_LOCATION_VECTOR,sn.a.Tag.TAG_LUT_SHAPE,[40,288]],g=[16,48],S=[24,21],x=[8,128],y=[8,4208],T=[8,144];d.m_patientName=r.getPatientName(),d.m_patientDateOfBirth=sn.a.Image.getSingleValueSafely(r.getTag(g[0],g[1]),0),d.m_seriesDescr=c,d.m_studyDescr=l,d.m_studyDate=h,d.m_seriesTime=u,d.m_bodyPartExamined=sn.a.Image.getSingleValueSafely(r.getTag(S[0],S[1]),0),d.m_institutionName=sn.a.Image.getSingleValueSafely(r.getTag(x[0],x[1]),0),d.m_operatorsName=sn.a.Image.getSingleValueSafely(r.getTag(y[0],y[1]),0),d.m_physicansName=sn.a.Image.getSingleValueSafely(r.getTag(T[0],T[1]),0);for(var D,b=p.length,R=0;R<b;R++){var w=sn.a.Utils.dec2hex(p[R][0])+sn.a.Utils.dec2hex(p[R][1]),M=r.tags[w];if(void 0!==M){var E=M.value,A=M.group,I=M.element,O=new Gi;O.m_tag="("+Gi.numberToHexString(A)+","+Gi.numberToHexString(I)+")";var X=this.m_loaderDicom.m_dictionary.getTextDesc(A,I);O.m_attrName=X.length>1?X:"";var C="";null!==E&&(C=E.toString()),O.m_attrValue=C,f.m_tags.push(O)}}D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_SLICE_LOCATION[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_SLICE_LOCATION[1]);var P=r.tags[D];if(void 0!==P){var k=P.value[0];_.m_sliceLocation=k,this.m_sliceLocMin=k<this.m_sliceLocMin?k:this.m_sliceLocMin,this.m_sliceLocMax=k>this.m_sliceLocMax?k:this.m_sliceLocMax}D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_IMAGE_NUM[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_IMAGE_NUM[1]);var F=r.tags[D];if(void 0!==F&&null!==F.value){var U=F.value[0];_.m_sliceNumber=U}D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_SAMPLES_PER_PIXEL[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_SAMPLES_PER_PIXEL[1]);var L=r.tags[D];if(void 0!==L){var N=L.value[0];this.m_loaderDicom.m_samplesPerPixel=N}D=sn.a.Utils.dec2hex(40)+sn.a.Utils.dec2hex(288);var z=r.tags[D];if(void 0!==z){var V=z.value[0];V<0&&(V=-(65535^V)-1),this.m_loaderDicom.m_padValue=V}D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_WINDOW_CENTER[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_WINDOW_CENTER[1]);var B=r.tags[D];void 0!==B&&(this.m_loaderDicom.m_windowCenter=B.value[0]),D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_WINDOW_WIDTH[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_WINDOW_WIDTH[1]);var j=r.tags[D];void 0!==j&&(this.m_loaderDicom.m_windowWidth=j.value[0]),D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_DATA_SCALE_INTERCEPT[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_DATA_SCALE_INTERCEPT[1]);var G=r.tags[D];void 0!==G&&(this.m_loaderDicom.m_rescaleIntercept=G.value[0]),D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_DATA_SCALE_SLOPE[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_DATA_SCALE_SLOPE[1]);var W=r.tags[D];void 0!==W&&(this.m_loaderDicom.m_rescaleSlope=W.value[0]);var H=[40,4180];D=sn.a.Utils.dec2hex(H[0])+sn.a.Utils.dec2hex(H[1]);var Y=r.tags[D];void 0!==Y&&null!==Y.value&&"HU"===Y.value[0]&&(this.m_loaderDicom.m_rescaleHounsfield=!0),D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_PIXEL_REPRESENTATION[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_PIXEL_REPRESENTATION[1]);var q=r.tags[D];void 0!==q&&1===q.value[0]&&(this.m_loaderDicom.m_pixelRepresentaionSigned=!0),D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_PIXEL_SPACING[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_PIXEL_SPACING[1]);var Z=r.tags[D];if(void 0!==Z){var K=Z.value;2===K.length&&(this.m_loaderDicom.m_pixelSpacing.x=parseFloat(K[0]),this.m_loaderDicom.m_pixelSpacing.y=parseFloat(K[1]))}D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_SLICE_THICKNESS[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_SLICE_THICKNESS[1]);var Q=r.tags[D];if(void 0!==Q){var J=Q.value;1===J.length&&(this.m_loaderDicom.m_pixelSpacing.z=parseFloat(J[0]))}D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_IMAGE_POSITION[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_IMAGE_POSITION[1]);var $=r.tags[D];if(void 0!==$){if(3===$.value.length){var ee=$.value[0],te=$.value[1],ie=$.value[2];this.m_loaderDicom.m_imagePosMin.x=ee<this.m_loaderDicom.m_imagePosMin.x?ee:this.m_loaderDicom.m_imagePosMin.x,this.m_loaderDicom.m_imagePosMin.y=te<this.m_loaderDicom.m_imagePosMin.y?te:this.m_loaderDicom.m_imagePosMin.y,this.m_loaderDicom.m_imagePosMin.z=ie<this.m_loaderDicom.m_imagePosMin.z?ie:this.m_loaderDicom.m_imagePosMin.z,this.m_loaderDicom.m_imagePosMax.x=ee>this.m_loaderDicom.m_imagePosMax.x?ee:this.m_loaderDicom.m_imagePosMax.x,this.m_loaderDicom.m_imagePosMax.y=te>this.m_loaderDicom.m_imagePosMax.y?te:this.m_loaderDicom.m_imagePosMax.y,this.m_loaderDicom.m_imagePosMax.z=ie>this.m_loaderDicom.m_imagePosMax.z?ie:this.m_loaderDicom.m_imagePosMax.z}}D=sn.a.Utils.dec2hex(sn.a.Tag.TAG_TRANSFER_SYNTAX[0])+sn.a.Utils.dec2hex(sn.a.Tag.TAG_TRANSFER_SYNTAX[1]);var ne=r.tags[D];void 0!==ne&&("1.2.840.10008.1.2.2"===ne.value[0]&&(this.m_loaderDicom.m_littleEndian=!1));this.m_loaderDicom.m_slicesVolume.addSlice(_);var re=r.getRawData();if(re.byteLength!==o*s*Math.floor(a/8)*this.m_loaderDicom.m_samplesPerPixel)return console.log("Error read Dicom via Diakon parser"),wt.ERROR_COMPRESSED_IMAGE_NOT_SUPPORTED;this.m_loaderDicom.m_pixelRepresentaionSigned?_.m_image=new Int16Array(o*s):_.m_image=new Uint16Array(o*s);var se=o*s;if(1===this.m_loaderDicom.m_samplesPerPixel)for(var oe=new Uint16Array(re),ae=0;ae<se;ae++)_.m_image[ae]=oe[ae];else if(3===this.m_loaderDicom.m_samplesPerPixel)for(var me=new Uint8Array(re),le=0,he=0;he<se;he++,le+=3){var ue=me[le+0],ce=me[le+1],de=me[le+2];_.m_image[he]=Math.floor((ue+ce+de)/3)}return _.m_xDim=o,_.m_yDim=s,wt.SUCCESS}},{key:"readSlice",value:function(e,t,i,n){return this.m_loaderDicom=e,this.loadSingleSlice(t,i,n)}},{key:"readSingleSlice",value:function(e,t,i,n,r){var s;if(this.m_loaderDicom=t,(s=this.loadSingleSlice(i,n,r))!==wt.SUCCESS)return s;var o=this.m_loaderDicom.m_dicomInfo;return e.dispatch({type:l.SET_DICOM_INFO,dicomInfo:o}),e.dispatch({type:l.SET_LOADER_DICOM,loaderDicom:this.m_loaderDicom}),s}}]),e}(),an=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).onButtonLocalFile=n.onButtonLocalFile.bind(Object(S.a)(n)),n.handleFileSelected=n.handleFileSelected.bind(Object(S.a)(n)),n.onFileContentReadSingleFile=n.onFileContentReadSingleFile.bind(Object(S.a)(n)),n.onFileContentReadMultipleDicom=n.onFileContentReadMultipleDicom.bind(Object(S.a)(n)),n.onFileContentReadMultipleHdr=n.onFileContentReadMultipleHdr.bind(Object(S.a)(n)),n.setErrorString=n.setErrorString.bind(Object(S.a)(n)),n.onModalWindowCWHide=n.onModalWindowCWHide.bind(Object(S.a)(n)),n.onModalDicomSeriesHide=n.onModalDicomSeriesHide.bind(Object(S.a)(n)),n.onDicomSerieSelected=n.onDicomSerieSelected.bind(Object(S.a)(n)),n.callbackReadProgress=n.callbackReadProgress.bind(Object(S.a)(n)),n.callbackReadComplete=n.callbackReadComplete.bind(Object(S.a)(n)),n.callbackReadSingleDicomComplete=n.callbackReadSingleDicomComplete.bind(Object(S.a)(n)),n.callbackReadMultipleComplete=n.callbackReadMultipleComplete.bind(Object(S.a)(n)),n.callbackCompleteMultipleDicom=n.callbackCompleteMultipleDicom.bind(Object(S.a)(n)),n.m_fileNameOnLoad="",n.m_fileName="",n.m_fileIndex=0,n.m_fileReader=null,n.state={strUrl:"",showModalUrl:!1,showModalDemo:!1,showModalGoogle:!1,showModalWindowCW:!1,onLoadCounter:1},n.m_volumeSet=null,n.m_volumeRoi=null,n.m_updateEnable=!0,n.roiMode=!1,n}return Object(v.a)(i,[{key:"finalizeSuccessLoadedVolume",value:function(e,t){var i=this.props;console.assert(e instanceof Yi,"finalizeSuccessLoadedVolume: should be VolumeSet"),console.assert(e.getNumVolumes()>=1,"finalizeSuccessLoadedVolume: should be more or 1 volume");var n=e.getVolume(0);if(console.assert(null!==n,"finalizeSuccessLoadedVolume: should be non zero volume"),null!==n.m_dataArray){console.log("success loaded volume from ".concat(t)),n.makeDimensions4x(),i.isLoaded&&i.dispatch({type:l.SET_IS_LOADED,isLoaded:!1}),i.dispatch({type:l.SET_VOLUME_SET,volumeSet:e}),i.dispatch({type:l.SET_VOLUME_INDEX,volumeIndex:0}),i.dispatch({type:l.SET_IS_LOADED,isLoaded:!0}),i.dispatch({type:l.SET_FILENAME,fileName:t}),i.dispatch({type:l.SET_ERR_ARRAY,arrErrors:[]});var r=new qi;r.createFromRawVolume(n),i.dispatch({type:l.SET_TEXTURE3D,texture3d:r}),i.dispatch({type:l.SET_MODE_VIEW,modeView:h.VIEW_2D}),i.dispatch({type:l.SET_MODE_3D,mode3d:c.RAYCAST})}}},{key:"setErrorString",value:function(e){var t=this.props,i=[];i.push(e),t.dispatch({type:l.SET_IS_LOADED,isLoaded:!1}),t.dispatch({type:l.SET_ERR_ARRAY,arrErrors:i}),t.dispatch({type:l.SET_VOLUME_SET,volume:null})}},{key:"finalizeFailedLoadedVolume",value:function(e,t,i){console.assert(void 0!==i);var n=this.props;n.dispatch({type:l.SET_IS_LOADED,isLoaded:!1}),n.dispatch({type:l.SET_VOLUME_SET,volume:null}),n.dispatch({type:l.SET_ERR_ARRAY,arrErrors:i}),n.dispatch({type:l.SET_FILENAME,fileName:t}),n.uiApp.doHideProgressBar()}},{key:"callbackReadProgress",value:function(e){var t=Math.floor(100*e),i=this.props.uiApp;null!==i&&(0===t&&i.doShowProgressBar("Loading..."),t>=99?i.doHideProgressBar():i.doSetProgressBarRatio(t))}},{key:"callbackReadComplete",value:function(e){if(void 0===e)console.log("callbackReadComplete. should be errCode");else if(e!==wt.SUCCESS){var t=wt.getResultString(e);this.setErrorString(t)}if(this.props.uiApp.doHideProgressBar(),e===wt.SUCCESS)this.finalizeSuccessLoadedVolume(this.m_volumeSet,this.m_fileName);else{console.log("callbackReadComplete failed! reading ".concat(this.m_fileName," file"));var i=[],n=wt.getResultString(e);i.push(n),this.finalizeFailedLoadedVolume(this.m_volumeSet,this.m_fileName,i)}}},{key:"callbackReadSingleDicomComplete",value:function(e){if(e===wt.SUCCESS){var t=this.props;return t.dispatch({type:l.SET_VOLUME_SET,volumeSet:this.m_volumeSet}),t.dispatch({type:l.SET_VOLUME_INDEX,volumeIndex:0}),t.dispatch({type:l.SET_LOADER_DICOM,loaderDicom:this.m_loader}),this.childModalWindowCenterWidth.initWindowRange(),void this.setState({showModalWindowCW:!0})}this.callbackReadComplete(e)}},{key:"callbackReadMultipleComplete",value:function(e){if(e!==wt.SUCCESS){var t=wt.getResultString(e);this.setErrorString(t)}}},{key:"onFileReadSingleUncompressedFile",value:function(e,t,i,n){this.m_fileName.endsWith(".ktx")||this.m_fileName.endsWith(".KTX")?this.m_volumeSet.readFromKtx(e,t,i):this.m_fileName.endsWith(".nii")||this.m_fileName.endsWith(".NII")?this.m_volumeSet.readFromNifti(e,t,i):this.m_fileName.endsWith(".dcm")||this.m_fileName.endsWith(".DCM")?(this.m_loader=new Gi,this.m_loader.m_zDim=1,this.m_loader.m_numFiles=1,this.m_volumeSet.readFromDicom(this.m_loader,e,t,n)):this.m_fileName.endsWith(".hdr")||this.m_fileName.endsWith(".HDR")?console.log("cant read single hdr file: ".concat(this.m_fileName)):this.m_fileName.endsWith(".img")||this.m_fileName.endsWith(".IMG")?console.log("cant read single img file: ".concat(this.m_fileName)):console.log("onFileContentReadSingleFile: unknown file type: ".concat(this.m_fileName))}},{key:"onFileContentReadSingleFile",value:function(){var e=this.m_fileReader.result;this.onFileReadSingleBuffer(e)}},{key:"readSliceDicomViaDaikon",value:function(e,t,i,n){return(new on).readSlice(this.m_loader,e,t,n)}},{key:"onFileReadSingleBuffer",value:function(e){if(this.m_fileName.endsWith(".dcm")||this.m_fileName.endsWith(".DCM")){var t=new on,i=this.props,n=this.m_fileIndex,r=this.m_fileName;this.m_loader=new Gi(1);var s=t.readSingleSlice(i,this.m_loader,n,r,e);return this.callbackReadSingleDicomComplete(s),s}this.m_volumeSet=new Yi,this.m_volumeSet.addVolume(new Rt);var o=this.callbackReadProgress,a=this.callbackReadComplete,m=this.callbackReadSingleDicomComplete;if(this.m_fileName.endsWith(".ktx")||this.m_fileName.endsWith(".KTX"))this.m_volumeSet.readFromKtx(e,o,a);else if(this.m_fileName.endsWith(".nii")||this.m_fileName.endsWith(".NII"))this.m_volumeSet.readFromNifti(e,o,a);else if(this.m_fileName.endsWith(".dcm")||this.m_fileName.endsWith(".DCM")){this.m_loader=new Gi,this.m_loader.m_zDim=1,this.m_loader.m_numFiles=1,this.m_volumeSet.readFromDicom(this.m_loader,e,o,m);var h=this.m_loader.m_dicomInfo,u=h.m_sliceInfo[0];u.m_fileName=this.m_fileName,u.m_sliceName="Slice 0",this.props.dispatch({type:l.SET_DICOM_INFO,dicomInfo:h})}else this.m_fileName.endsWith(".hdr")||this.m_fileName.endsWith(".HDR")?console.log("cant read single hdr file: ".concat(this.m_fileName)):this.m_fileName.endsWith(".img")||this.m_fileName.endsWith(".IMG")?console.log("cant read single img file: ".concat(this.m_fileName)):console.log("onFileContentReadSingleFile: unknown file type: ".concat(this.m_fileName))}},{key:"onFileContentReadMultipleHdr",value:function(){if(2===this.m_numFiles||4===this.m_numFiles){var e=this.m_fileName.endsWith("hdr")||this.m_fileName.endsWith("HDR");console.log("onFileContentReadMultipleHdr: read file ".concat(this.m_fileName,". Ratio=").concat(this.m_fileIndex," / ").concat(this.m_numFiles)),this.m_fileIndex++;var t=this.m_fileIndex/this.m_numFiles,i=this.m_fileReader.result;this.m_fileIndex<=1&&(0===this.m_volumeSet.getNumVolumes()&&this.m_volumeSet.addVolume(new Rt),this.callbackReadProgress(0)),4===this.m_numFiles&&null===this.m_volumeRoi&&(this.m_volumeRoi=new Rt);var n=/([\S]+)\.[\S]+/.exec(this.m_fileName),r=!1,s=!1;if(2===n.length){var o=n[1];o.endsWith("_mask")&&(r=!0),o.endsWith("_intn")&&(s=!0)}var a=this.m_volumeSet.getVolume(0);if(this.m_fileIndex>2&&(a=this.m_volumeRoi),s&&(a=this.m_volumeSet.getVolume(0)),r&&(a=this.m_volumeRoi,this.roiMode=!0,4!==this.m_numFiles))console.log("You need to load 4 files, if one of them has _mask in name");else{var m=!1;if(m=e?this.m_loader.readFromBufferHeader(a,i,null,null):this.m_loader.readFromBufferImage(a,i,null,null),a=this.m_volumeSet.getVolume(0),m&&this.m_fileIndex===this.m_numFiles){var l=!1;2===this.m_numFiles?l=this.m_loader.createVolumeFromHeaderAndImage(a):4===this.m_numFiles&&(l=this.m_loader.createVolumeFromHeaderAndImage(a))&&(l=this.m_loader.createRoiVolumeFromHeaderAndImage(a,this.m_volumeRoi)),this.callbackReadProgress(1),l?this.callbackReadComplete(wt.SUCCESS):this.callbackReadComplete(wt.FAIL)}if(this.m_fileIndex<this.m_numFiles){this.callbackReadProgress(t),this.m_fileReader.onloadend=this.onFileContentReadMultipleHdr;var h=this.m_files[this.m_fileIndex];this.m_fileName=h.name,this.m_fileReader.readAsArrayBuffer(h)}}}else console.log("onFileContentReadMultipleHdr: can read ".concat(2," or ").concat(4," files for multiple hdr loader"))}},{key:"callbackCompleteMultipleDicom",value:function(e){if(e!==wt.SUCCESS){var t=wt.getResultString(e);this.setErrorString(t)}}},{key:"onFileContentReadMultipleDicom",value:function(){var e=this.m_fileReader.result;this.m_fileIndex++;var t=this.m_fileIndex/this.m_numFiles;if(this.m_fileIndex<=1){var i=new Rt;this.m_volumeSet.addVolume(i),this.callbackReadProgress(0)}var n;this.callbackCompleteMultipleDicom;if((n=this.readSliceDicomViaDaikon(this.m_fileIndex-1,this.m_fileName,t,e))!==wt.SUCCESS&&console.log("onFileContentReadMultipleDicom. Error read individual file"),n===wt.SUCCESS&&this.m_fileIndex===this.m_numFiles){var r=this.props;return r.dispatch({type:l.SET_VOLUME_INDEX,volumeIndex:0}),r.dispatch({type:l.SET_VOLUME_SET,volumeSet:this.m_volumeSet}),r.dispatch({type:l.SET_LOADER_DICOM,loaderDicom:this.m_loader}),this.callbackReadProgress(1),this.callbackReadComplete(wt.SUCCESS),this.childModalWindowCenterWidth.initWindowRange(),void this.setState({showModalWindowCW:!0})}if(n===wt.SUCCESS){if(this.m_fileIndex<this.m_numFiles){var s=Math.floor(this.m_numFiles/16);this.m_fileIndex%s===0&&this.callbackReadProgress(t),this.m_fileReader.onloadend=this.onFileContentReadMultipleDicom;var o=this.m_files[this.m_fileIndex];this.m_fileName=o.name,this.m_fileReader.readAsArrayBuffer(o)}}else{var a=[],m=this.props.arrErrors[0];a.push(m),this.finalizeFailedLoadedVolume(this.m_volumeSet,this.m_fileName,a)}}},{key:"handleFileSelected",value:function(e){var t=this;if(void 0!==e.target.files){var i=e.target.files.length;if(console.log("UiOpenMenu. Trying to open ".concat(i," files")),i<=0)return;if(console.log("UiOpenMenu. handleFileSelected. file[0] = ".concat(e.target.files[0].name)),this.m_volumeSet=new Yi,1===i){var n=e.target.files[0];if(this.m_fileName=n.name,this.m_fileName.endsWith(".gz")){this.m_unzippedBuffer=null,this.m_fileName=this.m_fileName.slice(0,-3);var r=this.props,s=Tt.a.createGunzip();return bt()(n).pipe(s),s.on("data",(function(e){var i=r.uiApp;if(null==t.m_unzippedBuffer)i.doShowProgressBar("Read gzip...");else{var s=t.m_unzippedBuffer.length,o=n.size,a=Math.floor(100*s*.28/o);i.doSetProgressBarRatio(a)}var m=e.length;if(null==t.m_unzippedBuffer)t.m_unzippedBuffer=new Uint8Array(m),t.m_unzippedBuffer.set(e,0);else{var l=t.m_unzippedBuffer.length,h=new Uint8Array(l+m);h.set(t.m_unzippedBuffer,0),h.set(e,l),t.m_unzippedBuffer=h}})),s.on("close",(function(){console.log("gzip on close")})),void s.on("end",(function(){r.uiApp.doHideProgressBar();var e=t.m_unzippedBuffer.length;if(e<128)console.log("Too small ungzipped data: "+e.toString()+" bytes. can not read volume data");else{for(var i=[0,0,1,92],n=!0,s=0;s<4;s++)t.m_unzippedBuffer[s]!==i[s]&&(n=!1);for(var o=!0,a=0;a<4;a++)t.m_unzippedBuffer[a]!==i[3-a]&&(o=!1);n||o?(console.log("ungzip done with "+e.toString()+" bytes. Correct nifti header detected"),t.onFileReadSingleBuffer(t.m_unzippedBuffer)):console.log("Wrong Nifti Header, cant read gzipped file")}}))}this.m_fileReader=new FileReader,this.m_fileReader.onloadend=this.onFileContentReadSingleFile,this.m_fileReader.readAsArrayBuffer(n)}else{if(this.m_files=Array.from(e.target.files),this.m_fileIndex=0,this.m_numFiles=i,this.m_fileReader=new FileReader,this.m_loader=null,e.target.files[0].name.endsWith(".dcm")){for(var o=0,a=i-1;a>=0;a--)this.m_files[a].name.endsWith(".dcm")?o++:this.m_files.splice(a,1);i=o,this.m_numFiles=o,this.m_loader=new Gi(i);var m=this.m_loader.m_dicomInfo,h=this.props;h.dispatch({type:l.SET_DICOM_INFO,dicomInfo:m}),h.dispatch({type:l.SET_LOADER_DICOM,loaderDicom:this.m_loader}),this.m_fileReader.onloadend=this.onFileContentReadMultipleDicom}else(e.target.files[0].name.endsWith(".hdr")||e.target.files[0].name.endsWith(".img"))&&(this.m_loader=new Hi(i),this.m_fileReader.onloadend=this.onFileContentReadMultipleHdr);this.m_volumeRoi=null;var u=e.target.files[0];this.m_fileName=u.name,this.m_fileReader.readAsArrayBuffer(u)}}}},{key:"buildFileSelector",value:function(){var e=document.createElement("input");return e.setAttribute("type","file"),e.setAttribute("accept",".ktx,.dcm,.nii,.hdr,.h,.img,.gz"),e.setAttribute("multiple",""),e.onchange=this.handleFileSelected,e}},{key:"onButtonLocalFile",value:function(e){e.preventDefault(),this.m_fileSelector.click()}},{key:"arrNumToStr",value:function(e){for(var t=e.length,i="",n=0;n<t;n++){var r=e[n];i=i.concat(String.fromCharCode(r))}return i}},{key:"shouldComponentUpdate",value:function(){return!0}},{key:"onModalDicomSeriesHide",value:function(){this.props.dispatch({type:l.SET_DICOM_SERIES,dicomSeries:[]})}},{key:"onDicomSerieSelected",value:function(e){var t=this.props,i=t.dicomSeries[e].m_hash;this.m_loader.createVolumeFromSlices(this.m_volumeSet,e,i),this.finalizeSuccessLoadedVolume(this.m_volumeSet,this.m_fileName),console.log("onFileContentReadMultipleDicom read all ".concat(this.m_numFiles," files")),t.dispatch({type:l.SET_DICOM_SERIES,dicomSeries:[]})}},{key:"onModalWindowCWHide",value:function(e){if(this.setState({showModalWindowCW:!1}),e){this.finalizeSuccessLoadedVolume(this.m_volumeSet,this.m_fileName);var t=this.props,i=null;void 0!==this.m_loader&&(i=this.m_loader.m_slicesVolume.getSeries(),t.dispatch({type:l.SET_DICOM_SERIES,dicomSeries:i}));var n=t.graphics2d;null!==n&&n.forceUpdate()}}},{key:"componentDidMount",value:function(){this.m_fileSelector=this.buildFileSelector();var e=this.m_fileNameOnLoad;if(e.length>0&&this.state.onLoadCounter>0){this.setState({onLoadCounter:0});setTimeout(this.loadFromUrl(e),50)}}},{key:"render",value:function(){var e=this,t=this.props.fileNameOnLoad;this.m_fileNameOnLoad=t;return t.length>2?r.a.createElement("p",null):r.a.createElement("div",null,"\xa0",r.a.createElement("span",{style:{display:"inline-block",marginTop:"6px",cursor:"pointer"},href:"#actionOpenComputer",onClick:function(t){return e.onButtonLocalFile(t)}},r.a.createElement("i",{className:"fas fa-desktop"}),"Upload File"),"\xa0\xa0",r.a.createElement(nn,{stateVis:this.state.showModalWindowCW,volSet:this.m_volumeSet,onHide:this.onModalWindowCWHide,onRef:function(t){return e.childModalWindowCenterWidth=t}}))}}]),i}(r.a.Component),mn=Object(a.b)((function(e){return e}))(an),ln=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).m_needMode3dLight=!0,n.onMode3dLight=n.onMode3dLight.bind(Object(S.a)(n)),n}return Object(v.a)(i,[{key:"onMode",value:function(e){this.props.dispatch({type:l.SET_MODE_VIEW,modeView:e})}},{key:"onMode3dLight",value:function(){this.onMode(h.VIEW_3D_LIGHT)}},{key:"render",value:function(){var e=this.props.modeView===h.VIEW_3D_LIGHT?"primary":"secondary";return r.a.createElement(Ki.a,{className:"mr-2","aria-label":"Top group"},r.a.createElement(Qi.a,{key:"3dLight",placement:"bottom",overlay:r.a.createElement(Ji.a,null,"3d mode with fast rendering")},r.a.createElement($i.a,{variant:e,onClick:this.onMode3dLight},"3D Render")))}}]),i}(r.a.Component),hn=Object(a.b)((function(e){return e}))(ln),un=i(192),cn=i(191),dn=i(189),_n=!0,fn=function(){function e(){Object(f.a)(this,e)}return Object(v.a)(e,null,[{key:"writeIntToBuffer",value:function(e,t,i){new DataView(t,i).setInt32(0,e,_n)}},{key:"writeShortToBuffer",value:function(e,t,i){new DataView(t,i).setInt16(0,e,_n)}},{key:"writeFloatToBuffer",value:function(e,t,i){new DataView(t,i).setFloat32(0,e,_n)}},{key:"fpsToDimInfo",value:function(e,t,i){return 3&e|(3&t)<<2|(3&i)<<4}},{key:"writeBuffer",value:function(t,i){var n=i.x,r=i.y,s=i.z;(n<=0||r<=0||s<=0)&&console.log("SaverNifti. volume pixels dim is bad: ".concat(n," * ").concat(r," * ").concat(s," "));var o=i.pixdim1,a=i.pixdim2,m=i.pixdim3,l=1e-5;(o>5||a>5||m>5)&&console.log("SaverNifti. volume grid size is too much: ".concat(o," * ").concat(a," * ").concat(m," ")),(o<l||a<l||m<l)&&console.log("SaverNifti. volume grid size is too min: ".concat(o," * ").concat(a," * ").concat(m," ")),t.length!==n*r*s&&console.log("SaverNifti. bad input volume size = ".concat(t.length,", expected = ").concat(n,"*").concat(r,"*").concat(s));for(var h=1e6,u=-1e6,c=n*r*s,d=0;d<c;d++)h=t[d]<h?t[d]:h,u=t[d]>u?t[d]:u;u-h<60&&console.log("SaverNifti. bad input volume data range: [".concat(h," .. ").concat(u,"]"));var _=new ArrayBuffer(348+2*t.length),f=new Uint8Array(_),v=0;e.writeIntToBuffer(348,_,v),v+=4,v+=10,v+=18,v+=4,v+=2,v+=1;var p=e.fpsToDimInfo(1,2,3);f[v]=p,v+=1;e.writeShortToBuffer(3,_,v),v+=2,e.writeShortToBuffer(i.x,_,v),v+=2,e.writeShortToBuffer(i.y,_,v),v+=2,e.writeShortToBuffer(i.z,_,v),v+=2,v+=8,v+=4,v+=4,v+=4,v+=2;e.writeShortToBuffer(512,_,v),v+=2;e.writeShortToBuffer(16,_,v),v+=2,v+=2,v+=4,e.writeFloatToBuffer(i.pixdim1,_,v),v+=4,e.writeFloatToBuffer(i.pixdim2,_,v),v+=4,e.writeFloatToBuffer(i.pixdim3,_,v),v+=4,v+=16;e.writeFloatToBuffer(352,_,v),v+=4;e.writeFloatToBuffer(1,_,v),v+=4;e.writeFloatToBuffer(0,_,v),v+=4;f[v+=2]=1;f[++v]=10,v++,v+=16,v+=8,v+=80,v+=24;e.writeShortToBuffer(1,_,v),v+=2,e.writeShortToBuffer(1,_,v),v+=2;f[(v=344)+0]=110,f[v+1]=43,f[v+2]=49,v+=4;var g=new Uint16Array(t);return new Uint16Array(_,v).set(g),_}}]),e}(),vn=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).onModalShow=n.onModalShow.bind(Object(S.a)(n)),n.onModalHide=n.onModalHide.bind(Object(S.a)(n)),n.onButtonSave=n.onButtonSave.bind(Object(S.a)(n)),n.onTexChange=n.onTexChange.bind(Object(S.a)(n)),n.handleFormSubmit=n.handleFormSubmit.bind(Object(S.a)(n)),n.onSaveNifti=n.onSaveNifti.bind(Object(S.a)(n)),n.m_hideFunc=null,n.state={showModalSaveNifti:!1,text:"dump"},n}return Object(v.a)(i,[{key:"onButtonSave",value:function(){this.m_hideFunc(),this.onSaveNifti()}},{key:"onModalShow",value:function(){this.setState({showModalSaveNifti:!0})}},{key:"onModalHide",value:function(){this.setState({showModalSaveNifti:!1})}},{key:"handleFormSubmit",value:function(e){e.preventDefault(),this.m_hideFunc(),this.onSaveNifti()}},{key:"onTexChange",value:function(e){var t=e.target.value;this.setState({text:t})}},{key:"onSaveNifti",value:function(){var e=this.props,t=e.volumeSet,i=e.volumeIndex,n=t.getVolume(i),r=n.m_xDim,s=n.m_yDim,o=n.m_zDim,a={x:r,y:s,z:o,pixdim1:n.m_boxSize.x/r,pixdim2:n.m_boxSize.y/s,pixdim3:n.m_boxSize.z/o},m=n.m_dataArray,l=e.volumeRenderer;null!==l&&(m=l.volumeUpdater.bufferR);var h=fn.writeBuffer(m,a),u=new Blob([h],{type:"application/octet-stream"}),c=window.URL.createObjectURL(u),d=this.state.text;d.endsWith(".nii")||(d=d.concat(".nii"));var _=document.createElement("a");_.download=d,_.innerHTML="Download File",_.href=c,_.onclick=function(e){return document.body.removeChild(e.target)},_.style.display="none",document.body.appendChild(_),_.click()}},{key:"render",value:function(){var e=this,t=this.props.stateVis,i=this.props.onHide;return this.m_hideFunc=i,r.a.createElement(Zi.a,{show:t,onHide:i},r.a.createElement(Zi.a.Body,null,r.a.createElement(Zi.a.Title,null,"Save as Nifti"),r.a.createElement(cn.a,{onSubmit:function(t){return e.handleFormSubmit(t)}},r.a.createElement(dn.a,null,r.a.createElement("thead",null,r.a.createElement("tr",null,r.a.createElement("th",null,r.a.createElement(cn.a.Control,{required:!0,type:"text",placeholder:"Enter file name here",defaultValue:this.state.text,onChange:this.onTexChange})),r.a.createElement("th",null,r.a.createElement(cn.a.Label,{className:"text-left"},".nii")))))),r.a.createElement(x.a,null,r.a.createElement(y.a,{lg:!0,xl:"2"},r.a.createElement($i.a,{onClick:this.onButtonSave},"Save")),r.a.createElement(y.a,{lg:!0,xl:"2"},r.a.createElement($i.a,{onClick:i},"Cancel")),r.a.createElement(y.a,{lg:!0,xl:"8"}))))}}]),i}(r.a.Component),pn=Object(a.b)((function(e){return e}))(vn),gn=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).onModalSaveNiftiShow=n.onModalSaveNiftiShow.bind(Object(S.a)(n)),n.onModalSaveNiftiHide=n.onModalSaveNiftiHide.bind(Object(S.a)(n)),n.state={showModalSaveNifti:!1},n}return Object(v.a)(i,[{key:"componentDidMount",value:function(){}},{key:"onModalSaveNiftiShow",value:function(){this.setState({showModalSaveNifti:!0})}},{key:"onModalSaveNiftiHide",value:function(){this.setState({showModalSaveNifti:!1})}},{key:"render",value:function(){var e=this,t=!this.props.isLoaded;return r.a.createElement(un.a,{id:"save-nav-dropdown",disabled:t,title:r.a.createElement("div",{style:{display:"inline-block"}},r.a.createElement("i",{className:"fas fa-save"}),"Save")},r.a.createElement(un.a.Item,{onClick:function(t){return e.onModalSaveNiftiShow(t)}},r.a.createElement("i",{className:"fas fa-globe"}),"Save to Nifti"),r.a.createElement(pn,{stateVis:this.state.showModalSaveNifti,onHide:this.onModalSaveNiftiHide}))}}]),i}(r.a.Component),Sn=Object(a.b)((function(e){return e}))(gn),xn=i(130),yn=function(){function e(){Object(f.a)(this,e),this.m_strUserAgent="",this.m_strVendor="",this.m_isOpera=!1,this.m_isFirefox=!1,this.m_isSafari=!1,this.m_isIE=!1,this.m_isChrome=!1,this.m_isMobileBrowser=!1}return Object(v.a)(e,[{key:"checkWebGlSupported",value:function(){var e=Object(xn.createCanvas)(640,480),t=null;try{t=e.getContext("webgl2")}catch(i){t=null}return e=void 0,null!==t}},{key:"checkValidBrowser",value:function(){this.m_strUserAgent=navigator.userAgent.toLowerCase(),this.m_strVendor=navigator.vendor,this.m_isOpera=/opr\/|opios/i.test(this.m_strUserAgent),this.m_isFirefox="undefined"!==typeof InstallTrigger,this.m_isSafari=this.m_strUserAgent.search("safari")>=0&&this.m_strUserAgent.search("chrome")<0,this.m_isIE=!!document.documentMode,this.m_isChrome=/chrome/i.test(navigator.userAgent),this.m_isEdge=navigator.appVersion.indexOf("Edge")>-1,this.m_isEdge&&(this.m_isChrome=!1);var e="".concat("Med3web is designed for Chrome/Firefox/Safari browsers."," ").concat("The application can be slow or unstable in this web browser."),t=this.m_isChrome||this.m_isFirefox||this.m_isSafari||this.m_isOpera;if(!t){console.log("BrowserDetector. ".concat(e,". ").concat("App is specially designed for Chrome/Firefox/Opera/Safari browsers"))}var i=["iphone","ipad","android","blackberry","nokia","opera mini","windows mobile","windows phone","iemobile"];this.m_isMobileBrowser=!1;for(var n=0;n<i.length;n++)this.m_strUserAgent.indexOf(i[n].toLowerCase())>0&&(this.m_isMobileBrowser=!0);return(window.innerWidth<=800||window.innerHeight<=600)&&(this.m_isMobileBrowser=!0),this.m_isMobileBrowser&&console.log("MobileBrowserDetector. ".concat(e,". App can be slow due to detected mobile browser")),!!this.m_isMobileBrowser||t}}]),e}(),Tn=function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(e){var n;return Object(f.a)(this,i),(n=t.call(this,e)).doShowProgressBar=n.doShowProgressBar.bind(Object(S.a)(n)),n.doHideProgressBar=n.doHideProgressBar.bind(Object(S.a)(n)),n.doSetProgressBarRatio=n.doSetProgressBarRatio.bind(Object(S.a)(n)),n.m_modalText=null,n.m_store=null,n.m_fileNameOnLoad="",n.state={showModalText:!1,showProgressBar:!1,progressBarRatio:55,showModalAlert:!1,strAlertTitle:"???",strAlertText:"???",strProgressMessage:"Loading..."},n}return Object(v.a)(i,[{key:"UNSAFE_componentWillMount",value:function(){var e="",t=window.location.search;if(t.length>0){var i=t.match(/\\?url=(\S+)/);if(null===i)return void console.log("arguments should be in form: ?url=www.xxx.yy/zz/ww");var n=(e=i[1]).match(/^((ftp|http|https):\/\/)?(([\S]+)\.)?([\S]+)\.([A-z]{2,})(:\d{1,6})?\/[\S]+/),r=e.match(/(ftp|http|https):\/\/([\d]+)\.([\d]+)\.([\d]+)\.([\d]+)(:([\d]+))?\/([\S]+)/);if(null===n&&null===r)return void console.log("Not valid URL = ".concat(e));this.m_fileNameOnLoad=e}}},{key:"componentDidMount",value:function(){var e=this.m_store;null===e&&console.log("UiApp. componentDidMount. store is NULL"),e.dispatch({type:l.SET_UI_APP,uiApp:this});var t=new yn;this.isWebGl20supported=t.checkWebGlSupported()}},{key:"doShowProgressBar",value:function(e){void 0!==e&&null!==e?(this.setState({strProgressMessage:e}),this.setState({showProgressBar:!0})):console.log("doShowProgressBar: need argument - strProgressMsg")}},{key:"doHideProgressBar",value:function(){this.setState({showProgressBar:!1})}},{key:"doSetProgressBarRatio",value:function(e){e>=0&&e<=99&&!1===this.state.showProgressBar&&this.setState({showProgressBar:!0}),this.setState({progressBarRatio:e})}},{key:"render",value:function(){var e=this.props;this.m_store=e;var t=e.isLoaded,i=e.fileName,n=t?"File: "+i:"Upload Files to Render",s=this.state.strProgressMessage,o=r.a.createElement(x.a,null,r.a.createElement(y.a,{xs:!0,xl:!0,sm:!0,md:!0,lg:"12",style:{width:"100%"}},s,r.a.createElement(T.a,{animated:!0,variant:"success",now:this.state.progressBarRatio,label:"".concat(this.state.progressBarRatio,"%")}))),a=this.state.showProgressBar?o:r.a.createElement("p",null);return r.a.createElement(D.a,{fluid:"true",style:{height:"100%",minHeight:"100%"}},r.a.createElement(b.a,{bg:"dark",variant:"dark",expand:"lg"},r.a.createElement(b.a.Brand,null),r.a.createElement(b.a.Toggle,{"aria-controls":"basic-navbar-nav"}),r.a.createElement(b.a.Collapse,{id:"basic-navbar-nav"},r.a.createElement(R.a,{className:"mr-auto"},r.a.createElement(b.a.Text,{className:"d-none d-sm-block"},n),r.a.createElement(mn,{fileNameOnLoad:this.m_fileNameOnLoad}),r.a.createElement(Sn,null),r.a.createElement(hn,null)))),a,t?r.a.createElement(xt,null):r.a.createElement("p",null))}}]),i}(r.a.Component),Dn=Object(a.b)((function(e){return e}))(Tn),bn=(i(179),function(e){Object(p.a)(i,e);var t=Object(g.a)(i);function i(){return Object(f.a)(this,i),t.apply(this,arguments)}return Object(v.a)(i,[{key:"render",value:function(){return r.a.createElement(Dn,null)}}]),i}(r.a.Component)),Rn=Object(a.b)((function(e){return e}))(bn),wn=document.getElementById("root"),Mn=Object(m.b)(_);o.a.render(r.a.createElement(a.a,{store:Mn},r.a.createElement(Rn,null)),wn)},90:function(e,t){}},[[180,1,2]]]);
//# sourceMappingURL=main.bb58a394.chunk.js.map